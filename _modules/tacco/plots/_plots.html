<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tacco.plots._plots &mdash; TACCO  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=ad0ac74c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/readthedocs-custom.css?v=c8300288" />
      <link rel="stylesheet" type="text/css" href="../../../_static/notebook_hacks.css?v=e4ce2130" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/tacco.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TACCO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tacco.plots._plots</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tacco.plots._plots</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
<span class="kn">import</span> <span class="nn">matplotlib.lines</span> <span class="k">as</span> <span class="nn">mlines</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">to_rgb</span><span class="p">,</span> <span class="n">to_rgba</span><span class="p">,</span> <span class="n">rgb_to_hsv</span><span class="p">,</span> <span class="n">hsv_to_rgb</span><span class="p">,</span> <span class="n">to_rgba_array</span><span class="p">,</span> <span class="n">PowerNorm</span><span class="p">,</span> <span class="n">LinearSegmentedColormap</span><span class="p">,</span> <span class="n">to_hex</span><span class="p">,</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">LogNorm</span><span class="p">,</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">matplotlib.cm</span> <span class="kn">import</span> <span class="n">ScalarMappable</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">import</span> <span class="nn">scipy.cluster</span>
<span class="kn">from</span> <span class="nn">..tools._enrichments</span> <span class="kn">import</span> <span class="n">get_compositions</span><span class="p">,</span> <span class="n">get_contributions</span><span class="p">,</span> <span class="n">enrichments</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">get</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">preprocessing</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>

<span class="k">def</span> <span class="nf">get_min_max</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span>
        <span class="n">minimum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">vector</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximum</span> <span class="o">-</span> <span class="n">minimum</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">maximum</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="n">minimum</span> <span class="o">-=</span> <span class="n">delta</span>
        <span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">maximum</span><span class="p">)</span>
        <span class="n">minimum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">minimum</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">minimum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="c1">#delta = (maximum - minimum) * 0.1</span>
        <span class="c1">#maximum += delta</span>
        <span class="c1">#minimum -= delta</span>
    <span class="k">return</span> <span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span>
        
<span class="k">def</span> <span class="nf">_correlations</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">x_y_finite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x_y_finite</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">x_y_finite</span><span class="p">]</span>
    <span class="n">nDOF</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">nDOF</span><span class="p">)</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pc</span><span class="p">,</span> <span class="n">x2</span>

<span class="k">def</span> <span class="nf">_scatter_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">)</span>
    <span class="n">pc</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_correlations</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;r=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pc</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.95</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">chi^2_m$=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">0.00</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_composition_bar</span><span class="p">(</span><span class="n">compositions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">n_freqs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compositions</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">compositions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">n_freqs</span><span class="o">+</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">compositions</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">compositions</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">compositions</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">compositions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;composition&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.75</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">compositions</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">n_freqs</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">0</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">compositions</span><span class="p">:</span>
                <span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">compositions</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">compositions</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">compositions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;composition&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.75</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">compositions</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span> <span class="nf">_complement_color</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">rgb_to_hsv</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
    <span class="n">_r</span><span class="p">,</span> <span class="n">_g</span><span class="p">,</span> <span class="n">_b</span> <span class="o">=</span> <span class="n">hsv_to_rgb</span><span class="p">(((</span><span class="n">h</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_r</span><span class="p">,</span> <span class="n">_g</span><span class="p">,</span> <span class="n">_b</span>

<span class="k">def</span> <span class="nf">_scatter_frame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">ax_</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_min_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">joint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
    <span class="n">pie</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rasterized</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rasterized</span> <span class="o">!=</span> <span class="s1">&#39;pie&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`rasterized` has to be boolean or &quot;pie&quot;!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`rasterized==&quot;pie&quot;` cannot use a `cmap`!&#39;</span><span class="p">)</span>
        <span class="n">pie</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">rasterized</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">color_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">colors</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">])])</span>

        <span class="n">dpi</span> <span class="o">=</span> <span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">get_dpi</span><span class="p">()</span>
        <span class="n">point_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">point_size</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dpi</span>
        
        <span class="c1"># convert from pixel to axes units</span>
        <span class="n">point_radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="n">point_radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">id_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    
    <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_ax_</span> <span class="o">=</span> <span class="n">ax_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">_id_</span> <span class="o">=</span> <span class="n">id_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="n">joint</span><span class="p">:</span>
        <span class="n">_ax_</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_types</span>
        <span class="n">_id_</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_types</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_ax_</span> <span class="o">=</span> <span class="n">ax_</span>
        <span class="n">_id_</span> <span class="o">=</span> <span class="n">id_</span>
    
    <span class="n">axsize</span> <span class="o">=</span> <span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span><span class="o">.</span><span class="n">size</span>
    <span class="n">canvas_size</span> <span class="o">=</span> <span class="n">axsize</span>
    
    <span class="n">coords</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    
    <span class="c1"># use the largest possible amount of space of the axes</span>
    <span class="n">coords_min</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">_coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">-</span> <span class="n">coords_min</span>
    <span class="n">coords_range</span> <span class="o">=</span> <span class="n">_coords</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">scale_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="n">coords_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">scale_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="n">coords_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">scale_0</span><span class="p">,</span> <span class="n">scale_1</span><span class="p">)</span>
    <span class="c1"># center the coords</span>
    <span class="n">offset_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">offset_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># coords_min is mapped to (offset_0,offset_1)</span>
    <span class="c1"># =&gt; coords_min-(offset_0,offset_1)/scale is mapped to (0,0)</span>
    <span class="c1"># canvas_size / scale is the range</span>
    <span class="c1"># =&gt; extent_min = coords_min - (offset_0,offset_1) / scale</span>
    <span class="c1"># =&gt; extent_max = extent_min + canvas_size / scale</span>
    <span class="n">extent_min</span> <span class="o">=</span> <span class="n">coords_min</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">offset_0</span><span class="p">,</span><span class="n">offset_1</span><span class="p">))</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="n">extent_max</span> <span class="o">=</span> <span class="n">extent_min</span> <span class="o">+</span> <span class="n">canvas_size</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">extent_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extent_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extent_min</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">c</span><span class="p">),</span><span class="n">ax</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="n">_ax_</span><span class="p">,</span><span class="n">_id_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pie</span><span class="p">:</span>
            <span class="n">only_color_array</span> <span class="o">=</span> <span class="n">color_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">only_color_array</span><span class="p">[</span><span class="n">only_color_array</span> <span class="o">!=</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#fff0&#39;</span> <span class="c1"># transparent white</span>
            
            <span class="n">weights</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            
            <span class="k">def</span> <span class="nf">plotit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">color_array</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">_weights</span><span class="p">,</span><span class="n">_x</span><span class="p">,</span><span class="n">_y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">_weights</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="n">color_array</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">point_radius</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">out_min_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># get values for backpropagation of the value range</span>
                    <span class="n">out_min_max</span><span class="p">[</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">joint</span><span class="p">:</span>
                <span class="n">plotit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">only_color_array</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">title</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">joint</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">items</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># plot full pies only once</span>
                    <span class="n">plotit</span><span class="p">(</span><span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">color_array</span><span class="p">)</span>
            
            
        <span class="k">elif</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#scale = 200.0 * np.random.rand(n)</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">to_rgb</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">_r</span><span class="p">,</span> <span class="n">_g</span><span class="p">,</span> <span class="n">_b</span> <span class="o">=</span> <span class="n">_complement_color</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="c1"># complement colors for negative values</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># dont plot invisible points</span>
                <span class="n">visible</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="n">vals</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">visible</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">visible</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">visible</span><span class="p">]</span>
                <span class="c1"># separately plot efficient cases</span>
                <span class="n">which1p</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">&gt;=</span> <span class="o">+</span><span class="mi">1</span>
                <span class="n">vals1p</span><span class="p">,</span> <span class="n">_x1p</span><span class="p">,</span> <span class="n">_y1p</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">which1p</span><span class="p">],</span> <span class="n">_x</span><span class="p">[</span><span class="n">which1p</span><span class="p">],</span> <span class="n">_y</span><span class="p">[</span><span class="n">which1p</span><span class="p">]</span>
                <span class="n">which1m</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">vals1m</span><span class="p">,</span> <span class="n">_x1m</span><span class="p">,</span> <span class="n">_y1m</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">which1m</span><span class="p">],</span> <span class="n">_x</span><span class="p">[</span><span class="n">which1m</span><span class="p">],</span> <span class="n">_y</span><span class="p">[</span><span class="n">which1m</span><span class="p">]</span>
                <span class="c1"># and the rest</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="p">(</span><span class="n">vals</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">vals</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">vals</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">remaining</span><span class="p">],</span> <span class="n">_x</span><span class="p">[</span><span class="n">remaining</span><span class="p">],</span> <span class="n">_y</span><span class="p">[</span><span class="n">remaining</span><span class="p">]</span>
                <span class="n">color1p</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                <span class="n">color1m</span> <span class="o">=</span> <span class="p">[</span><span class="n">_r</span><span class="p">,</span><span class="n">_g</span><span class="p">,</span><span class="n">_b</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">r</span><span class="p">,</span><span class="n">_r</span><span class="p">],[</span><span class="n">g</span><span class="p">,</span><span class="n">_g</span><span class="p">],[</span><span class="n">b</span><span class="p">,</span><span class="n">_b</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">[(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">))</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]])</span>
                <span class="k">def</span> <span class="nf">plotit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="n">rasterized</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_x1p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_x1p</span><span class="p">,</span> <span class="n">_y1p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color1p</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="n">rasterized</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_x1m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_x1m</span><span class="p">,</span> <span class="n">_y1m</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color1m</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="n">rasterized</span><span class="p">)</span>
                    
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">out_min_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># get values for backpropagation of the value range</span>
                        <span class="n">out_min_max</span><span class="p">[</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">joint</span><span class="p">:</span>
                    <span class="n">plotit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">title</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">joint</span><span class="p">:</span>
                    <span class="n">plotit</span><span class="p">(</span><span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="k">def</span> <span class="nf">plotit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">cmap_vmin_vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">cmap_vmin_vmax</span>
                        <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                        <span class="n">norm</span> <span class="o">=</span> <span class="kc">None</span>
                    
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="n">rasterized</span><span class="p">)</span>
                    
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">out_min_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># get values for backpropagation of the value range</span>
                        <span class="n">out_min_max</span><span class="p">[</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span>

                <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">joint</span><span class="p">:</span>
                    <span class="n">plotit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">title</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">joint</span><span class="p">:</span>
                    <span class="n">plotit</span><span class="p">(</span><span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_make_stencil</span><span class="p">(</span><span class="n">point_radius</span><span class="p">):</span>
    <span class="n">extra_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">point_radius</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">stencil_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">extra_size</span>
    <span class="n">stencil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">stencil_size</span><span class="p">,</span><span class="n">stencil_size</span><span class="p">))</span>
    <span class="c1"># monte carlo evaluate density profile of a disc... There have to be better options, but maybe not more straightforward ones...</span>
    <span class="c1"># for one quadrant</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">point_radius2</span> <span class="o">=</span> <span class="n">point_radius</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">point_radius2</span><span class="o">*</span><span class="mi">10000</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">point_radius</span>
    <span class="n">quadrant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">extra_size</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">extra_size</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">d2</span> <span class="o">&lt;</span> <span class="n">point_radius2</span><span class="p">:</span>
            <span class="n">_sample</span> <span class="o">=</span> <span class="n">sample</span><span class="o">+</span><span class="mf">0.5</span>
            <span class="n">quadrant</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">_sample</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># symmetrize octant</span>
    <span class="n">quadrant</span> <span class="o">=</span> <span class="n">quadrant</span> <span class="o">+</span> <span class="n">quadrant</span><span class="o">.</span><span class="n">T</span> <span class="c1"># using += with numba and matrices gives wrong results: https://github.com/numba/numba/issues/6949 </span>
    <span class="c1"># replicate to other quadrants</span>
    <span class="n">stencil</span><span class="p">[:</span><span class="o">-</span><span class="n">extra_size</span><span class="p">,:</span><span class="o">-</span><span class="n">extra_size</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quadrant</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">stencil</span><span class="p">[</span><span class="n">extra_size</span><span class="p">:,:</span><span class="o">-</span><span class="n">extra_size</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quadrant</span><span class="p">[::,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">stencil</span><span class="p">[:</span><span class="o">-</span><span class="n">extra_size</span><span class="p">,</span><span class="n">extra_size</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">quadrant</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,::]</span>
    <span class="n">stencil</span><span class="p">[</span><span class="n">extra_size</span><span class="p">:,</span><span class="n">extra_size</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">quadrant</span><span class="p">[::,::]</span>
    <span class="c1"># normalize</span>
    <span class="n">stencil</span> <span class="o">/=</span> <span class="n">stencil</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">stencil</span>
<span class="nd">@njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_draw_weights</span><span class="p">(</span><span class="n">canvas_size</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">offset_x</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">stencil</span><span class="p">):</span>
    <span class="n">extra_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">stencil</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">canvas_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">w</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="n">xo</span><span class="p">,</span><span class="n">yo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">offset_x</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">offset_y</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">[(</span><span class="n">xo</span><span class="o">-</span><span class="n">extra_size</span><span class="p">):(</span><span class="n">xo</span><span class="o">+</span><span class="n">extra_size</span><span class="o">+</span><span class="mi">1</span><span class="p">),(</span><span class="n">yo</span><span class="o">-</span><span class="n">extra_size</span><span class="p">):(</span><span class="n">yo</span><span class="o">+</span><span class="n">extra_size</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">stencil</span>
    <span class="k">return</span> <span class="n">canvas</span>
                    
<span class="k">def</span> <span class="nf">_render_frame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">ax_</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_min_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">joint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color_mix_mode</span><span class="o">=</span><span class="s1">&#39;xyv&#39;</span><span class="p">):</span>
    
    <span class="n">typing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    
    <span class="n">coords_min</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">-</span> <span class="n">coords_min</span>
    <span class="n">coords_range</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># empty dots dont get rendered</span>
        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">typing</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span>
    
    <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">typing</span>
    
    <span class="n">dpi</span> <span class="o">=</span> <span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">get_dpi</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">id_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_ax_</span> <span class="o">=</span> <span class="n">ax_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">_id_</span> <span class="o">=</span> <span class="n">id_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="n">joint</span><span class="p">:</span>
        <span class="n">_ax_</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_types</span>
        <span class="n">_id_</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_types</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_ax_</span> <span class="o">=</span> <span class="n">ax_</span>
        <span class="n">_id_</span> <span class="o">=</span> <span class="n">id_</span>
    
    <span class="n">point_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">point_size</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">72</span> <span class="o">*</span> <span class="n">dpi</span>
    
    <span class="n">margin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">margin</span> <span class="o">*</span> <span class="n">dpi</span> <span class="o">+</span> <span class="n">point_radius</span><span class="p">))</span>
    <span class="n">axsize</span> <span class="o">=</span> <span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span><span class="o">.</span><span class="n">size</span>
    <span class="n">canvas_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">axsize</span><span class="p">)</span><span class="o">*</span><span class="n">dpi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># use the largest possible amount of space of the axes</span>
    <span class="n">scale_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="n">coords_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">scale_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="n">coords_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">scale_0</span><span class="p">,</span> <span class="n">scale_1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">dpi</span>
    <span class="c1"># center the coords</span>
    <span class="n">offset_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coords_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">offset_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coords_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># coords_min is mapped to (offset_0,offset_1)</span>
    <span class="c1"># =&gt; coords_min-(offset_0,offset_1)/scale is mapped to (0,0)</span>
    <span class="c1"># canvas_size / scale is the range</span>
    <span class="c1"># =&gt; extent_min = coords_min - (offset_0,offset_1) / scale</span>
    <span class="c1"># =&gt; extent_max = extent_min + canvas_size / scale</span>
    <span class="n">extent_min</span> <span class="o">=</span> <span class="n">coords_min</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">offset_0</span><span class="p">,</span><span class="n">offset_1</span><span class="p">))</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="n">extent_max</span> <span class="o">=</span> <span class="n">extent_min</span> <span class="o">+</span> <span class="n">canvas_size</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">extent_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extent_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extent_min</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    
    <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">*</span> <span class="n">scale</span>
    
    <span class="n">stencil</span> <span class="o">=</span> <span class="n">_make_stencil</span><span class="p">(</span><span class="n">point_radius</span><span class="p">)</span>
    
    <span class="n">canvases</span> <span class="o">=</span> <span class="p">{</span> <span class="n">c</span><span class="p">:</span> <span class="n">_draw_weights</span><span class="p">((</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">weights</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">coords</span><span class="p">,</span> <span class="n">offset_0</span><span class="p">,</span> <span class="n">offset_1</span><span class="p">,</span> <span class="n">stencil</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
    
    <span class="n">sum_canvas</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">canvases</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">finite_sum</span> <span class="o">=</span> <span class="n">sum_canvas</span><span class="o">!=</span><span class="mi">0</span>
    
    <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">}</span>
    
    <span class="c1"># alpha just tells us whether there is data on the pixel or not</span>
    <span class="k">def</span> <span class="nf">get_alpha</span><span class="p">(</span><span class="n">norm_canvas</span><span class="p">,</span> <span class="n">stencil</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">norm_canvas</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">stencil</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">alpha</span><span class="p">[</span><span class="n">alpha</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># cut off values with too high alpha</span>
        <span class="k">return</span> <span class="n">alpha</span>
    <span class="k">def</span> <span class="nf">add_alpha</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="n">norm_canvas</span><span class="p">,</span> <span class="n">stencil</span><span class="p">):</span>
        <span class="n">canvasA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">canvas</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">canvasA</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span>
        <span class="n">canvasA</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_alpha</span><span class="p">(</span><span class="n">norm_canvas</span><span class="p">,</span> <span class="n">stencil</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">canvasA</span>

    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#norm_canvas = _draw_weights((canvas_size[0],canvas_size[1]), np.ones(shape=len(weights)), coords, offset_0, offset_1, stencil)</span>
        <span class="n">norm_canvas</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span> <span class="k">for</span> <span class="n">canvas</span> <span class="ow">in</span> <span class="n">canvases</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="c1">#finite_norm = norm_canvas!=0</span>
        
        <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">joint</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">mix_base_colors</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">canvases</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">canvases</span><span class="p">],</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">colors</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">canvases</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="n">color_mix_mode</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="c1"># remove zero weight colors</span>
                <span class="n">canvas</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">][</span><span class="o">~</span><span class="n">finite_sum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">canvas</span><span class="p">[</span><span class="n">canvas</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># numerical accuracy issues</span>

            <span class="n">canvasA</span> <span class="o">=</span> <span class="n">add_alpha</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="n">norm_canvas</span><span class="p">,</span> <span class="n">stencil</span><span class="p">)</span>

            <span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">canvasA</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">out_min_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># get values for backpropagation of the value range</span>
                <span class="n">out_min_max</span><span class="p">[</span><span class="n">id_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">id_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">canvases</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">/</span><span class="n">stencil</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">canvases</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">stencil</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">joint</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">c</span><span class="p">),</span><span class="n">ax</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="n">_ax_</span><span class="p">,</span><span class="n">_id_</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">canvases</span><span class="p">:</span>
                    <span class="n">canvas</span>  <span class="o">=</span> <span class="n">canvases</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">colors</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                    <span class="n">finite_t</span> <span class="o">=</span> <span class="n">canvases</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="c1"># normalize the colors by the weights</span>
                        <span class="n">canvas</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">][</span><span class="n">finite_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">][</span><span class="n">finite_t</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">canvases</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">finite_t</span><span class="p">])</span>
                    <span class="n">canvas</span><span class="p">[</span><span class="n">canvas</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># numerical accuracy issues</span>

                    <span class="n">canvasA</span> <span class="o">=</span> <span class="n">add_alpha</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">canvases</span><span class="p">[</span><span class="n">t</span><span class="p">]),</span> <span class="n">stencil</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">canvasA</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">title</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">out_min_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># get values for backpropagation of the value range</span>
                        <span class="n">out_min_max</span><span class="p">[</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">canvases</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">/</span><span class="n">stencil</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">canvases</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">stencil</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm_canvas</span> <span class="o">=</span> <span class="n">_draw_weights</span><span class="p">((</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">canvas_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)),</span> <span class="n">coords</span><span class="p">,</span> <span class="n">offset_0</span><span class="p">,</span> <span class="n">offset_1</span><span class="p">,</span> <span class="n">stencil</span><span class="p">)</span>
        <span class="n">finite_norm</span> <span class="o">=</span> <span class="n">norm_canvas</span><span class="o">!=</span><span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">joint</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">sum_canvas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span> <span class="o">/</span> <span class="n">norm_canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span> <span class="c1"># normalize the values by the weights</span>

            <span class="n">alpha</span> <span class="o">=</span> <span class="n">get_alpha</span><span class="p">(</span><span class="n">norm_canvas</span><span class="p">,</span> <span class="n">stencil</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cmap_vmin_vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">cmap_vmin_vmax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

            <span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">canvas</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">out_min_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># get values for backpropagation of the value range</span>
                <span class="n">out_min_max</span><span class="p">[</span><span class="n">id_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">id_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span>
        
        <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">joint</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">c</span><span class="p">),</span><span class="n">ax</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="n">_ax_</span><span class="p">,</span><span class="n">_id_</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">canvases</span><span class="p">:</span>
                    <span class="n">canvas</span> <span class="o">=</span> <span class="n">canvases</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span> <span class="o">/</span> <span class="n">norm_canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span> <span class="c1"># normalize the values by the weights</span>

                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">get_alpha</span><span class="p">(</span><span class="n">norm_canvas</span><span class="p">,</span> <span class="n">stencil</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cmap_vmin_vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">cmap_vmin_vmax</span>
                        <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">canvas</span><span class="p">[</span><span class="n">finite_norm</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                        <span class="n">norm</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">canvas</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">title</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">out_min_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># get values for backpropagation of the value range</span>
                        <span class="n">out_min_max</span><span class="p">[</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span>

<span class="k">def</span> <span class="nf">_set_axes_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axes_labels</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">axes_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_list_like</span><span class="p">(</span><span class="n">axes_labels</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes_labels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`axes_labels` </span><span class="si">{</span><span class="n">axes_labels</span><span class="si">!r}</span><span class="s1"> is not a list-like of 2 elements!&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">axes_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">axes_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        
<span class="k">def</span> <span class="nf">spatial_distribution_plot</span><span class="p">(</span><span class="n">typing_data</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">n_cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">joint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_min_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">noticks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_data_legend</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_types</span> <span class="o">+</span> <span class="n">n_cols</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span>
    <span class="k">elif</span> <span class="n">joint</span><span class="p">:</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n_y</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_types</span> <span class="o">+</span> <span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span>
    <span class="n">n_solutions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">typing_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_y</span><span class="p">,</span><span class="n">n_solutions</span><span class="o">*</span><span class="n">n_cols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="o">*</span><span class="n">n_solutions</span><span class="o">*</span><span class="n">n_cols</span><span class="p">,</span><span class="mi">7</span><span class="o">*</span><span class="n">n_y</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_y</span><span class="p">,</span><span class="n">n_solutions</span><span class="o">*</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;spatial_distribution_plot got axs of wrong dimensions: need </span><span class="si">%s</span><span class="s1">, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">n_y</span><span class="p">,</span><span class="n">n_solutions</span><span class="o">*</span><span class="n">n_cols</span><span class="p">),</span><span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">_axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_solutions</span><span class="p">,</span><span class="n">n_cols</span><span class="o">*</span><span class="n">n_y</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_solutions</span><span class="p">,</span><span class="n">n_cols</span><span class="o">*</span><span class="n">n_y</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_y</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_solutions</span><span class="p">):</span>
                <span class="n">_axs</span><span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="n">n_solutions</span><span class="o">+</span><span class="n">c</span><span class="p">]</span>
                <span class="n">_idx</span><span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">counter</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="n">n_solutions</span><span class="o">+</span><span class="n">c</span><span class="p">])</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">for</span> <span class="n">id_</span><span class="p">,</span><span class="n">ax_</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_idx</span><span class="p">,</span><span class="n">_axs</span><span class="p">,</span><span class="n">typing_data</span><span class="p">,</span><span class="n">typing_data</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># dont change the original df</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span> <span class="c1"># normalize values per column to give alphas between 0 and 1</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            
        <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">coords</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span> <span class="c1"># remove all-nan columns</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># remove any-nan rows</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">render</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">render</span><span class="p">:</span>
            <span class="n">_scatter_frame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">ax_</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="n">cmap_vmin_vmax</span><span class="p">,</span> <span class="n">out_min_max</span><span class="o">=</span><span class="n">out_min_max</span><span class="p">,</span> <span class="n">joint</span><span class="o">=</span><span class="n">joint</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="n">rasterized</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rasterized</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`render!=False` only works when `rasterized==True`&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">render</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">color_mix_mode</span> <span class="o">=</span> <span class="s1">&#39;xyv&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color_mix_mode</span> <span class="o">=</span> <span class="n">render</span>
            <span class="n">_render_frame</span> <span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">ax_</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="n">cmap_vmin_vmax</span><span class="p">,</span> <span class="n">out_min_max</span><span class="o">=</span><span class="n">out_min_max</span><span class="p">,</span> <span class="n">joint</span><span class="o">=</span><span class="n">joint</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">color_mix_mode</span><span class="o">=</span><span class="n">color_mix_mode</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_</span><span class="p">:</span>
            
            <span class="n">_set_axes_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axes_labels</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">noticks</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                    
        <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">joint</span><span class="p">:</span>
            <span class="n">ax_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">on_data_legend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">weighted_median</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">value_col</span><span class="p">,</span> <span class="n">weights_col</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">value_col</span><span class="p">,</span> <span class="n">weights_col</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">value_col</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">value_col</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="n">weights_col</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">weights_col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">def</span> <span class="nf">find_closest_point</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">weights</span> <span class="o">&gt;=</span> <span class="n">weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># only consider points with weights above 90% of the max weight</span>
                <span class="n">dists</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">coords</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">coords</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
            
            <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]]:</span>
                <span class="n">medians</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                    <span class="n">medians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weighted_median</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">annotation</span><span class="p">))</span>
                <span class="n">closest</span> <span class="o">=</span> <span class="n">find_closest_point</span><span class="p">(</span><span class="n">medians</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]],</span> <span class="n">df</span><span class="p">[</span><span class="n">annotation</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">*</span><span class="n">closest</span><span class="p">,</span> <span class="n">on_data_legend</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span> <span class="k">if</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">on_data_legend</span> <span class="k">else</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span> <span class="nf">write_results_to_adata</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">typing_data</span><span class="p">,</span> <span class="n">pfn_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pfn_key</span><span class="o">=</span><span class="s1">&#39;platform_normalization_factors&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pfn_key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">:</span>
        <span class="n">pfns</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="n">pfn_key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pfns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">typing</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">typing_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">typing</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pfn_factors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">typing</span> <span class="ow">in</span> <span class="n">pfn_factors</span> <span class="ow">and</span> <span class="n">pfn_factors</span><span class="p">[</span><span class="n">typing</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pfns</span><span class="p">[</span><span class="n">typing</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfn_factors</span><span class="p">[</span><span class="n">typing</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pfns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="n">pfn_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfns</span>

<div class="viewcode-block" id="get_default_colors">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.get_default_colors.html#tacco.plots.get_default_colors">[docs]</a>
<span class="k">def</span> <span class="nf">get_default_colors</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Chooses default colors.</span>
<span class="sd">    This is a convenience wrapper around :func:`seaborn.color_palette` which</span>
<span class="sd">    provides a quasi-periodicity of 10, i.e. every 10 colors, the colors are</span>
<span class="sd">    related.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n</span>
<span class="sd">        Number of colors to choose OR a list of keys to choose colors for.</span>
<span class="sd">    offset</span>
<span class="sd">        The number of chosen colors to skip before starting to use them. This</span>
<span class="sd">        is useful for generating different sets of colors.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    If `n` is a number, returns a list of colors. If `n` is a list-like,\</span>
<span class="sd">    returns a mapping of the elements of `n` to colors.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
  
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_list_like</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">default_colors</span> <span class="o">=</span> <span class="n">get_default_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">color</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">default_colors</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default_colors</span> <span class="o">=</span> <span class="p">[</span> <span class="n">to_hex</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;bright&quot;</span><span class="p">),</span><span class="o">*</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;deep&quot;</span><span class="p">),</span><span class="o">*</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;dark&quot;</span><span class="p">),</span><span class="o">*</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;pastel&quot;</span><span class="p">)]</span> <span class="p">]</span>
        <span class="n">default_colors</span> <span class="o">*=</span> <span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_colors</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_colors</span><span class="p">[</span><span class="n">offset</span><span class="p">:(</span><span class="n">n</span><span class="o">+</span><span class="n">offset</span><span class="p">)]</span></div>


<div class="viewcode-block" id="mix_base_colors">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.mix_base_colors.html#tacco.plots.mix_base_colors">[docs]</a>
<span class="k">def</span> <span class="nf">mix_base_colors</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">base_colors_rgb</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;xyv&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Mix colors &quot;additively&quot;. In contrast to weighted averages over &quot;rgb&quot; values</span>
<span class="sd">    (which results in quite dark colors), the average can be done in &quot;xyv&quot;</span>
<span class="sd">    space, which is &quot;hsv&quot; with the &quot;hs&quot; part converted from polar to cartesian</span>
<span class="sd">    coordinates.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights</span>
<span class="sd">        A weight tensor with last dimension `n_base` describing mixtures of</span>
<span class="sd">        `n_base` colors; this can be a :class:`~numpy.ndarray` or a</span>
<span class="sd">        :class:`~pandas.DataFrame`.</span>
<span class="sd">    base_colors_rgb</span>
<span class="sd">        An `n_base X 3` matrix defining the base colors in rgb space; this must</span>
<span class="sd">        be a :class:`~numpy.ndarray`.</span>
<span class="sd">    mode</span>
<span class="sd">        The mixing mode; available are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;rgb&#39;: average the rgb values in the rgb cube</span>
<span class="sd">        - &#39;xyv&#39;: average the xyz values in the hsv cylider</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Returns the color mixtures depending on the type of `weights` either as\</span>
<span class="sd">    :class:`~numpy.ndarray` or :class:`~pandas.DataFrame`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">weights_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="s1">&#39;to_numpy&#39;</span><span class="p">):</span>
        <span class="n">weights_index</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">index</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;xyv&#39;</span><span class="p">:</span>
        <span class="n">base_colors_hsv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">rgb_to_hsv</span><span class="p">(</span><span class="n">base_color_rgb</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">base_color_rgb</span> <span class="ow">in</span> <span class="n">base_colors_rgb</span><span class="p">])</span>
        <span class="n">base_colors_xyv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">base_colors_hsv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">base_colors_hsv</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">base_colors_hsv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">base_colors_hsv</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">base_colors_hsv</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">mixed_colors_xyv</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">@</span> <span class="n">base_colors_xyv</span>
        <span class="n">mixed_colors_hsv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">mixed_colors_xyv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mixed_colors_xyv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mixed_colors_xyv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">mixed_colors_xyv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">mixed_colors_xyv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">],</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mixed_colors_hsv</span><span class="p">[</span><span class="n">mixed_colors_hsv</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">mixed_colors_rgb</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="n">mixed_colors_hsv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weights_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mixed_colors_rgb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mixed_colors_rgb</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">weights_index</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="n">mixed_colors_rgb</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">@</span> <span class="n">base_colors_rgb</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The mode &quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1">&quot; is not implemented!&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mixed_colors_rgb</span></div>


<span class="k">def</span> <span class="nf">_filter_types</span><span class="p">(</span><span class="n">typing_data</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">show_only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">show_only</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">show_only</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_only</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">types</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">show_only</span><span class="p">]</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not all selected types </span><span class="si">%s</span><span class="s1"> are available in the data </span><span class="si">%s</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">show_only</span><span class="p">,</span> <span class="n">types</span><span class="p">))</span>
    
    <span class="n">typing_data</span> <span class="o">=</span> <span class="n">typing_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">types</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">typing_data</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span>


<span class="k">def</span> <span class="nf">_get_colors</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">types</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="c1">#colors = colors[colors.index.intersection(types)]</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not all types </span><span class="si">%s</span><span class="s1"> are given colors with </span><span class="si">%s</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">get_default_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">types</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">colors</span><span class="p">,</span> <span class="n">types</span>

<span class="k">def</span> <span class="nf">_get_adatas</span><span class="p">(</span><span class="n">adata</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
        <span class="n">adatas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">adatas</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">adatas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">adatas</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dataframe2anndata</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1">#adatas = pd.Series(adata) # it could be so simple - but it does not work for adatas...</span>
        <span class="n">adatas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dataframe2anndata</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">adatas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adatas</span> <span class="o">=</span> <span class="n">adata</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">adatas</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The series of adatas has non-unique indices: </span><span class="si">%s</span><span class="s1">!&#39;</span><span class="p">,</span> <span class="n">adatas</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">adatas</span>

<span class="k">def</span> <span class="nf">_validate_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compositional</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
    <span class="n">adatas</span> <span class="o">=</span> <span class="n">_get_adatas</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">keys</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#methods = pd.Series({k:v for k,v in methods.items()}) # check basically whether methods is a dict or pd.Series (having an items method), mapping sample names to methods</span>
        <span class="c1"># check basically whether methods is a dict or pd.Series (having an items method), mapping sample names to methods</span>
        <span class="n">_methods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">_methods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">_methods</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">methods</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">adatas</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="c1"># assume same methods available for all samples</span>
    
    <span class="n">typing_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">adata</span> <span class="ow">in</span> <span class="n">adatas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">[</span><span class="n">sample</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_list_like</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">method</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">element</span><span class="p">]):</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The adata obs key </span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s1"> did contain non-numeric data%s!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39; for sample &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">sample</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="n">_data</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
                        <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">_data</span><span class="p">):</span>
                            <span class="n">_data</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">A</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The key </span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s1"> is neither in obs.columns nor in var.index%s!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39; for sample &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">sample</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
                <span class="n">iscat</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">method</span><span class="p">],</span> <span class="s1">&#39;cat&#39;</span><span class="p">)</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">iscat</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">number</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;More than 30 categories were discovered in column `.obs[</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">]`, which probably leads to slow plotting! (This message can be removed, if the column is made a categorical column).&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">method</span><span class="p">:</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">method</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The method key </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1"> is neither obs(m) key nor a list-like%s!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39; for sample &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">sample</span><span class="p">)))</span>
                
            <span class="k">if</span> <span class="n">compositional</span><span class="p">:</span>
                
                <span class="n">data</span> <span class="o">*=</span> <span class="p">(</span><span class="n">data</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1"># some methods may export negative values... (RCTD did that once)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reads</span><span class="p">:</span> <span class="c1"># scale by read count</span>
                    <span class="n">counts</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">counts</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># ...but only if there is data for that</span>
                        <span class="n">data</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[:,</span><span class="kc">None</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">compositional</span> <span class="o">==</span> <span class="s1">&#39;catsize&#39;</span><span class="p">:</span>
                    <span class="n">sizes</span> <span class="o">=</span> <span class="n">get_cellsize</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">/=</span> <span class="n">sizes</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="n">types</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">method_label</span> <span class="o">=</span> <span class="n">method</span> <span class="k">if</span> <span class="p">((</span><span class="n">method_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">method_labels</span><span class="p">))</span> <span class="k">else</span> <span class="n">method_labels</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">method_label</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">method_label</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_label</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">method_label</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">sample</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sample</span><span class="si">}</span><span class="s1">; </span><span class="si">{</span><span class="n">method_label</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">typing_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
            
            
    <span class="n">typing_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">typing_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span><span class="s1">&#39;method&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    
    <span class="n">colors</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_get_colors</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">types</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">compositional</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`compositional==True`, but there were less than 2 categories: </span><span class="si">{</span><span class="n">types</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">typing_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">_filter_types</span><span class="p">(</span><span class="n">typing_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span>

<span class="k">def</span> <span class="nf">_validate_scatter_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">position_key</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compositional</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">_validate_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">,</span> <span class="n">compositional</span><span class="o">=</span><span class="n">compositional</span><span class="p">)</span>
    
    <span class="n">coords</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">adata</span> <span class="ow">in</span> <span class="n">adatas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_coords</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">positions</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">position_key</span><span class="p">)</span>
        <span class="n">_coords</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">coords</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">_coords</span><span class="c1">#.rename(columns={_coords.columns[0]:&#39;x&#39;,_coords.columns[1]:&#39;y&#39;})</span>
    
    <span class="k">return</span> <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">coords</span>

<div class="viewcode-block" id="subplots">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.subplots.html#tacco.plots.subplots">[docs]</a>
<span class="k">def</span> <span class="nf">subplots</span><span class="p">(</span>
    <span class="n">n_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">x_padding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y_padding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
    <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
    <span class="n">width_ratios</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">height_ratios</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">x_shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y_shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Creates a new figure with a grid of subplots.</span>
<span class="sd">    This is a convenience wrapper around :func:`matplotlib.pyplot.subplots`</span>
<span class="sd">    with parameters for axis instead of figure and absolute instead of relative</span>
<span class="sd">    units.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_x</span>
<span class="sd">        Number of plots in horizontal/x direction</span>
<span class="sd">    n_y</span>
<span class="sd">        Number of plots in vertical/y direction</span>
<span class="sd">    axsize</span>
<span class="sd">        Size of a single axis in the plot</span>
<span class="sd">    hspace</span>
<span class="sd">        Relative vertical spacing between plots</span>
<span class="sd">    wspace</span>
<span class="sd">        Relative horizontal spacing between plots</span>
<span class="sd">    x_padding</span>
<span class="sd">        Absolute horizontal spacing between plots; this setting overrides</span>
<span class="sd">        `wspace`; if `None`, use the value from `wspace`</span>
<span class="sd">    y_padding</span>
<span class="sd">        Absolute vertical spacing between plots; this setting overrides</span>
<span class="sd">        `hspace`; if `None`, use the value from `hspace`</span>
<span class="sd">    title</span>
<span class="sd">        Sets the figure suptitle</span>
<span class="sd">    sharex</span>
<span class="sd">        Parameter for sharing the x-axes between the subplots; see the</span>
<span class="sd">        documentation of :func:`matplotlib.pyplot.subplots`</span>
<span class="sd">    sharey</span>
<span class="sd">        Parameter for sharing the y-axes between the subplots; see the</span>
<span class="sd">        documentation of :func:`matplotlib.pyplot.subplots`</span>
<span class="sd">    width_ratios</span>
<span class="sd">        Sets the ratios of widths for the columns of the subplot grid keeping</span>
<span class="sd">        the width of the widest column; if `None`, all columns have the same</span>
<span class="sd">        width</span>
<span class="sd">    height_ratios</span>
<span class="sd">        Sets the ratios of heights for the rows of the subplot grid keeping the</span>
<span class="sd">        height of the highest row; if `None`, all rows have the same height</span>
<span class="sd">    x_shifts</span>
<span class="sd">        The absolute shifts in position in horizontal/x direction per column of</span>
<span class="sd">        subplots; if `None`, the columns are not shifted</span>
<span class="sd">    y_shifts</span>
<span class="sd">        The absolute shifts in position in vertical/y direction per row of</span>
<span class="sd">        subplots; if `None`, the rows are not shifted</span>
<span class="sd">    dpi</span>
<span class="sd">        The dpi setting to use for this figure</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Extra keyword arguments are forwarded to</span>
<span class="sd">        :func:`matplotlib.pyplot.subplots`</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A pair of the created :class:`~matplotlib.figure.Figure` and an 2d\</span>
<span class="sd">    :class:`~numpy.ndarray` of :class:`~matplotlib.axes.Axes`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
  
    <span class="k">if</span> <span class="n">x_padding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wspace</span> <span class="o">=</span> <span class="n">x_padding</span> <span class="o">/</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">y_padding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hspace</span> <span class="o">=</span> <span class="n">y_padding</span> <span class="o">/</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">width_ratios</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">effective_n_x</span> <span class="o">=</span> <span class="n">n_x</span>
        <span class="n">effective_wspace</span> <span class="o">=</span> <span class="n">wspace</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">effective_n_x</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">)</span>
        <span class="n">effective_wspace</span> <span class="o">=</span> <span class="n">wspace</span> <span class="o">*</span> <span class="n">n_x</span> <span class="o">/</span> <span class="n">effective_n_x</span>
        
    <span class="k">if</span> <span class="n">height_ratios</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">effective_n_y</span> <span class="o">=</span> <span class="n">n_y</span>
        <span class="n">effective_hspace</span> <span class="o">=</span> <span class="n">hspace</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">effective_n_y</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">height_ratios</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">height_ratios</span><span class="p">)</span>
        <span class="n">effective_hspace</span> <span class="o">=</span> <span class="n">hspace</span> <span class="o">*</span> <span class="n">n_y</span> <span class="o">/</span> <span class="n">effective_n_y</span>
    
    <span class="c1"># find the values of the figure size which will keep the axis size identical for all numbers of columns and rows...</span>
    <span class="n">fig_height</span> <span class="o">=</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">effective_n_y</span> <span class="o">+</span> <span class="n">hspace</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">fig_width</span> <span class="o">=</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">effective_n_x</span> <span class="o">+</span> <span class="n">wspace</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="n">top</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title_space</span> <span class="o">=</span> <span class="mf">0.75</span>
        <span class="n">fig_height</span> <span class="o">+=</span> <span class="n">title_space</span>
        <span class="n">top</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">title_space</span> <span class="o">/</span> <span class="n">fig_height</span>
    
    <span class="k">if</span> <span class="n">dpi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpi</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_y</span><span class="p">,</span><span class="n">n_x</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_width</span><span class="p">,</span><span class="n">fig_height</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;wspace&#39;</span><span class="p">:</span><span class="n">effective_wspace</span><span class="p">,</span><span class="s1">&#39;hspace&#39;</span><span class="p">:</span><span class="n">effective_hspace</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;top&#39;</span><span class="p">:</span><span class="n">top</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="n">width_ratios</span><span class="p">,</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:</span> <span class="n">height_ratios</span><span class="p">},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">x_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x_shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_shifts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_shifts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_y</span>
        <span class="k">for</span> <span class="n">i_x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_x</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_y</span><span class="p">):</span>
                <span class="p">[</span><span class="n">left</span><span class="p">,</span><span class="n">bottom</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">]</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i_y</span><span class="p">,</span><span class="n">i_x</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i_y</span><span class="p">,</span><span class="n">i_x</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">left</span><span class="o">+</span><span class="n">x_shifts</span><span class="p">[</span><span class="n">i_x</span><span class="p">],</span><span class="n">bottom</span><span class="o">+</span><span class="n">y_shifts</span><span class="p">[</span><span class="n">i_y</span><span class="p">],</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span></div>


<span class="k">def</span> <span class="nf">_add_legend_or_colorbars</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_legend</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="n">colors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">],</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rel_dpi_factor</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_dpi</span><span class="p">()</span> <span class="o">/</span> <span class="mi">72</span>
        <span class="n">height_pxl</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="o">*</span> <span class="n">scale_legend</span>
        <span class="n">width_pxl</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="o">*</span> <span class="n">scale_legend</span>
        <span class="n">offset_top_pxl</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="o">*</span> <span class="n">scale_legend</span>
        <span class="n">offset_left_pxl</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="o">*</span> <span class="n">scale_legend</span>

        <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span><span class="n">jcol</span><span class="p">]</span>
                <span class="n">left</span><span class="p">,</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">offset_left_pxl</span><span class="p">,</span><span class="o">-</span><span class="n">offset_top_pxl</span><span class="o">-</span><span class="n">height_pxl</span><span class="p">]))</span>
                <span class="n">width</span><span class="p">,</span><span class="n">height</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">width_pxl</span><span class="p">,</span><span class="n">height_pxl</span><span class="p">]))</span>
                <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">min_max</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">min_max</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">),</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<div class="viewcode-block" id="scatter">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.scatter.html#tacco.plots.scatter">[docs]</a>
<span class="k">def</span> <span class="nf">scatter</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="n">position_key</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">),</span>
    <span class="n">group_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">padding</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">share_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">joint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">method_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">compositional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">point_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">on_data_legend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">render</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">background_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">noticks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">axes_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Scatter plots of annotation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` including annotation in `.obs` and/or</span>
<span class="sd">        `.obsm`. Can also be a mapping of labels to :class:`~anndata.AnnData`</span>
<span class="sd">        to specify multiple datasets. The :class:`~anndata.AnnData` instances</span>
<span class="sd">        can be replaced also by :class:`~pandas.DataFrame`, which are then</span>
<span class="sd">        treated like the `.obs` of an :class:`~anndata.AnnData`.</span>
<span class="sd">    keys</span>
<span class="sd">        The `.obs`/`.obsm` annotation keys to compare. Can be a single string,</span>
<span class="sd">        or a list of strings, or a mapping of the labels of `adata` to strings</span>
<span class="sd">        or lists of strings. In the list or mapping variant, categorical `.obs`</span>
<span class="sd">        keys can be replaced by list-likes of numerical `.obs` keys or gene</span>
<span class="sd">        names can be used.</span>
<span class="sd">    position_key</span>
<span class="sd">        The `.obsm` key or array-like of `.obs` keys with the position space</span>
<span class="sd">        coordinates.</span>
<span class="sd">    group_key</span>
<span class="sd">        An `.obs` key with categorical group information to split `adata` prior</span>
<span class="sd">        to plotting. This works only if `adata` is a single</span>
<span class="sd">        :class:`~anndata.AnnData` instance.</span>
<span class="sd">    colors</span>
<span class="sd">        A mapping of annotation values to colors. If `None`, default colors are</span>
<span class="sd">        used.</span>
<span class="sd">    show_only</span>
<span class="sd">        A subset of annotation values to restrict the plotting to.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and height of a single axis. If one of them is `None`,</span>
<span class="sd">        it is determined from the aspect ratio of the data. If it is a single</span>
<span class="sd">        scalar value, then this is interpreted as a conversion factor from</span>
<span class="sd">        data units to axsize units and `share_scaling` is ignored.</span>
<span class="sd">    padding</span>
<span class="sd">        The absolute padding between the plots.</span>
<span class="sd">    margin</span>
<span class="sd">        The absolute margin between the outermost data points and the boundary</span>
<span class="sd">        of the plot</span>
<span class="sd">    sharex</span>
<span class="sd">        Whether to use common x axis for all axes.</span>
<span class="sd">    sharey</span>
<span class="sd">        Whether to use common y axis for all axes.</span>
<span class="sd">    share_scaling</span>
<span class="sd">        Whether to have the units in all plots be of the same size in pixels</span>
<span class="sd">    n_cols</span>
<span class="sd">        Number of &quot;columns&quot; to plot: If larger than 1 splits columns of plots</span>
<span class="sd">        into `n_cols` columns.</span>
<span class="sd">    joint</span>
<span class="sd">        Whether to plot only one scatter plot with all annotation categories or</span>
<span class="sd">        only the scatter plots with one annotation category per plot. If</span>
<span class="sd">        `None`, plot both.</span>
<span class="sd">    method_labels</span>
<span class="sd">        A mapping from the strings in `keys` and `basis_keys` to (shorter)</span>
<span class="sd">        names to show in the plot.</span>
<span class="sd">    counts_location</span>
<span class="sd">        A string or tuple specifying where the count matrix is stored, e.g.</span>
<span class="sd">        `&#39;X&#39;`, `(&#39;raw&#39;,&#39;X&#39;)`, `(&#39;raw&#39;,&#39;obsm&#39;,&#39;my_counts_key&#39;)`,</span>
<span class="sd">        `(&#39;layer&#39;,&#39;my_counts_key&#39;)`, ... For details see</span>
<span class="sd">        :func:`~tacco.get.counts`.</span>
<span class="sd">    compositional</span>
<span class="sd">        Whether the annotation is to be interpreted as compositional data or as</span>
<span class="sd">        arbitrary numbers. Compositional data is normalized to sum to 1 per</span>
<span class="sd">        observation. Can also be &#39;catsize&#39;, which rescales the compositions by</span>
<span class="sd">        the average observed size of an annotation category in terms of the</span>
<span class="sd">        contents of `.X`, e.g. reads.</span>
<span class="sd">    normalize</span>
<span class="sd">        Whether to shift the data to non-negative values and normalize them by</span>
<span class="sd">        their maximum.</span>
<span class="sd">    point_size</span>
<span class="sd">        The size of the points in the plot. Like in matplotlib, this is a</span>
<span class="sd">        measure of point area and provided in units of &quot;squared points&quot;</span>
<span class="sd">        corresponding to (1/72)^2 inch^2 = (25.4/72)^2 mm^2.</span>
<span class="sd">    cmap</span>
<span class="sd">        A string/colormap to override the `colors` with. Makes sense mostly for</span>
<span class="sd">        numeric data.</span>
<span class="sd">    cmap_vmin_vmax</span>
<span class="sd">        A tuple giving the range of values for the colormap.</span>
<span class="sd">    legend</span>
<span class="sd">        Whether to plot a legend</span>
<span class="sd">    on_data_legend</span>
<span class="sd">        A mapping from annotation values to (shortened) versions of the labels</span>
<span class="sd">        to use for labels on the plot at the center of the annotation;</span>
<span class="sd">        annotations not occurring in the mapping are used as is; if `None`, no</span>
<span class="sd">        annotation is plotted on the data.</span>
<span class="sd">    title</span>
<span class="sd">        The title of the figure</span>
<span class="sd">    render</span>
<span class="sd">        Whether the scatterplot should be custom rendered using the dpi setting</span>
<span class="sd">        from matplotlib or plotted using a matplotlib&#39;s scatterplot. If `True`,</span>
<span class="sd">        the different annotations from the same (and overlapping) positions are</span>
<span class="sd">        added up symmetrically, if `False`, they are plottet on top of each</span>
<span class="sd">        other using an alpha channel proportional to the weight. `True` also</span>
<span class="sd">        has the advantage that only the scatter part of the figure will be</span>
<span class="sd">        exported as pixelated version if the plot is exported as vectorgraphic,</span>
<span class="sd">        with the rest like labels and axes being exported as a vectorgraphic.</span>
<span class="sd">        This parameter provides control over the type of color averaging in the</span>
<span class="sd">        process of the rendering by specifying one of the modes available in</span>
<span class="sd">        :func:`~tacco.plots.mix_base_colors`, e.g. &quot;xyv&quot; or &quot;rgb&quot;, with &quot;xyv&quot;</span>
<span class="sd">        being equivalent to setting `True`.</span>
<span class="sd">    rasterized</span>
<span class="sd">        Whether to rasterize the interior of the plot, even when exported later</span>
<span class="sd">        as vectorgraphic. This leads to much smaller plots for many (data)</span>
<span class="sd">        points. `rasterized==False` is incompatible with `render==True` or</span>
<span class="sd">        string.</span>
<span class="sd">        This parameter provides experimental support for plotting pie charts</span>
<span class="sd">        per dot via ´rasterized==&quot;pie&quot;´ and ´render==False´. This is much</span>
<span class="sd">        slower, so only usable for very few points.</span>
<span class="sd">    background_color</span>
<span class="sd">        The background color to draw the points on.</span>
<span class="sd">    grid</span>
<span class="sd">        Whether to draw a grid</span>
<span class="sd">    noticks</span>
<span class="sd">        Whether to switch off ticks on the axes.</span>
<span class="sd">    axes_labels</span>
<span class="sd">        Labels to write on the axes as an list-like of the two labels.</span>
<span class="sd">    ax</span>
<span class="sd">        The 2d array of :class:`~matplotlib.axes.Axes` instances to plot on.</span>
<span class="sd">        The array dimensions have to agree with the number of axes which would</span>
<span class="sd">        be created automatically if `ax` was not supplied. If it is a single</span>
<span class="sd">        instance it is treated as a 1x1 array.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">group_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `group_key` </span><span class="si">{</span><span class="n">group_key</span><span class="si">!r}</span><span class="s1"> is not `None`, but `adata` is not a single `AnnData` instance!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `group_key` </span><span class="si">{</span><span class="n">group_key</span><span class="si">!r}</span><span class="s1"> is not available in `adata.obs`!&#39;</span><span class="p">)</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="p">{</span> <span class="n">c</span><span class="p">:</span> <span class="n">adata</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_key</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">}</span>
    
    <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">_validate_scatter_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">position_key</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">,</span> <span class="n">compositional</span><span class="o">=</span><span class="n">compositional</span><span class="p">)</span>
    <span class="n">n_solutions</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">typing_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_types</span> <span class="o">=</span> <span class="n">n_types</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">joint</span><span class="p">:</span>
        <span class="n">n_types</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">n_x</span> <span class="o">=</span> <span class="n">n_solutions</span><span class="o">*</span><span class="n">n_cols</span>
    <span class="n">n_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_types</span> <span class="o">+</span> <span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span>
    
    <span class="n">axsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axsize</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># special treatment of various semi-automatic axsizes</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axsize</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">share_scaling</span><span class="p">:</span>
        <span class="n">minxs</span><span class="p">,</span> <span class="n">maxxs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">minys</span><span class="p">,</span> <span class="n">maxys</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>    
        <span class="k">for</span> <span class="n">i_sample</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">typing_data</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="n">minx</span><span class="p">,</span><span class="n">maxx</span> <span class="o">=</span> <span class="n">get_min_max</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">miny</span><span class="p">,</span><span class="n">maxy</span> <span class="o">=</span> <span class="n">get_min_max</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">minxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minx</span><span class="p">),</span> <span class="n">maxxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxx</span><span class="p">)</span>
            <span class="n">minys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">miny</span><span class="p">),</span> <span class="n">maxys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxy</span><span class="p">)</span>
        <span class="n">minxs</span><span class="p">,</span> <span class="n">maxxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">minxs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">maxxs</span><span class="p">)</span>
        <span class="n">minys</span><span class="p">,</span> <span class="n">maxys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">minys</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">maxys</span><span class="p">)</span>
        <span class="n">sizexs</span> <span class="o">=</span> <span class="n">maxxs</span><span class="o">-</span><span class="n">minxs</span>
        <span class="n">sizeys</span> <span class="o">=</span> <span class="n">maxys</span><span class="o">-</span><span class="n">minys</span>
        <span class="n">maxsizex</span> <span class="o">=</span> <span class="n">sizexs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">maxsizey</span> <span class="o">=</span> <span class="n">sizeys</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">minxs</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">maxxs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">miny</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">minys</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">maxys</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">sizex</span> <span class="o">=</span> <span class="n">maxx</span><span class="o">-</span><span class="n">minx</span>
        <span class="n">sizey</span> <span class="o">=</span> <span class="n">maxy</span><span class="o">-</span><span class="n">miny</span>
        
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># If `ax` is given, use it. This also ensures that axs is always defined below</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
                <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ax</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span>
            <span class="k">if</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_y</span><span class="p">,</span><span class="n">n_x</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `ax` argument got the wrong shape of axes: needed is </span><span class="si">{</span><span class="p">(</span><span class="n">n_y</span><span class="p">,</span><span class="n">n_x</span><span class="p">)</span><span class="si">!r}</span><span class="s1"> supplied was </span><span class="si">{</span><span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="si">!r}</span><span class="s1">!&#39;</span><span class="p">)</span>
            <span class="n">axsize</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span><span class="o">.</span><span class="n">size</span>
            
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">axsize</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># if it is a single scalar value, use that as a global scale</span>
            <span class="c1"># this also implies that all axes have to have a common scaling</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sharex</span> <span class="ow">or</span> <span class="n">sharey</span><span class="p">):</span>
                <span class="n">share_scaling</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">sharex</span><span class="p">:</span>
                <span class="n">axsizex</span> <span class="o">=</span> <span class="n">sizex</span> <span class="o">*</span> <span class="n">axsize</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axsizex</span> <span class="o">=</span> <span class="n">maxsizex</span> <span class="o">*</span> <span class="n">axsize</span>
            <span class="k">if</span> <span class="n">sharey</span><span class="p">:</span>
                <span class="n">axsizey</span> <span class="o">=</span> <span class="n">sizey</span> <span class="o">*</span> <span class="n">axsize</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axsizey</span> <span class="o">=</span> <span class="n">maxsizey</span> <span class="o">*</span> <span class="n">axsize</span>
                
            <span class="n">axsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axsizex</span><span class="p">,</span> <span class="n">axsizey</span><span class="p">])</span>
            
        <span class="k">elif</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="c1"># determine the missing axsize</span>
            <span class="k">if</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The parameter `axsize` got `(None, None)`, while only one of the entries of the tuple can be `None`!&#39;</span><span class="p">)</span>
                
            <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizey</span> <span class="k">if</span> <span class="n">sharey</span> <span class="k">else</span> <span class="n">sizeys</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sizex</span> <span class="k">if</span> <span class="n">sharex</span> <span class="k">else</span> <span class="n">sizexs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sharex</span> <span class="ow">and</span> <span class="n">sharey</span><span class="p">):</span> <span class="c1"># if aspect_ratio is not yet fixed and still a vector</span>
            
                <span class="c1">#aspect_ratio = max(aspect_ratio)</span>
                <span class="c1">#aspect_ratio = min(aspect_ratio)</span>
                
                <span class="c1">#np.argmax(np.abs(aspect_ratio - 1))</span>
                
                <span class="k">if</span> <span class="n">sharex</span><span class="p">:</span> <span class="c1"># x is fixed: make y as large as needed</span>
                    <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">sharey</span><span class="p">:</span> <span class="c1"># y is fixed: make x as large as needed</span>
                    <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">aspect_ratio</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># we are free to take the one which fits best - in some arbitrary sense...</span>
                
            <span class="k">if</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">aspect_ratio</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># axsize[1] is None</span>
                <span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">aspect_ratio</span>
        
        <span class="k">if</span> <span class="n">share_scaling</span><span class="p">:</span>
            <span class="n">scale_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="n">maxsizex</span>
            <span class="n">scale_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="n">maxsizey</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">scale_0</span><span class="p">,</span> <span class="n">scale_1</span><span class="p">)</span>
    
    <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">wspace</span><span class="p">,</span> <span class="n">hspace</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">/</span> <span class="n">axsize</span>
    
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">n_x</span><span class="p">,</span><span class="n">n_y</span><span class="p">,</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="n">wspace</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="n">hspace</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    
    <span class="n">min_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="o">*</span><span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i_sample</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">typing_data</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">typing_data</span><span class="p">[</span><span class="n">typing_data</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">sample</span><span class="p">]</span>
        <span class="n">n_methods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[:,(</span><span class="n">i_sample</span><span class="o">*</span><span class="n">n_methods</span><span class="o">*</span><span class="n">n_cols</span><span class="p">):((</span><span class="n">i_sample</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n_methods</span><span class="o">*</span><span class="n">n_cols</span><span class="p">)]</span>
        <span class="n">_min_max</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">min_max</span><span class="p">[:,(</span><span class="n">i_sample</span><span class="o">*</span><span class="n">n_methods</span><span class="o">*</span><span class="n">n_cols</span><span class="p">):((</span><span class="n">i_sample</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n_methods</span><span class="o">*</span><span class="n">n_cols</span><span class="p">)]</span>
        <span class="n">spatial_distribution_plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">sample</span><span class="p">],</span> <span class="n">colors</span><span class="p">,</span> <span class="n">axs</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">n_cols</span><span class="o">=</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">joint</span><span class="o">=</span><span class="n">joint</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="n">cmap_vmin_vmax</span><span class="p">,</span> <span class="n">out_min_max</span><span class="o">=</span><span class="n">_min_max</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="n">render</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="n">rasterized</span><span class="p">,</span> <span class="n">noticks</span><span class="o">=</span><span class="n">noticks</span><span class="p">,</span> <span class="n">axes_labels</span><span class="o">=</span><span class="n">axes_labels</span><span class="p">,</span> <span class="n">on_data_legend</span><span class="o">=</span><span class="n">on_data_legend</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">background_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_ax</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
                <span class="n">_ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">background_color</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">share_scaling</span><span class="p">:</span>
    
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span> <span class="c1"># make the transformations have well defined values</span>
        
        <span class="n">ax_heights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ax_widths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
            <span class="n">ax_x_low</span><span class="p">,</span><span class="n">ax_y_low</span> <span class="o">=</span> <span class="n">_ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
            <span class="n">ax_x_high</span><span class="p">,</span><span class="n">ax_y_high</span> <span class="o">=</span> <span class="n">_ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">ax_height</span><span class="p">,</span><span class="n">ax_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_y_high</span><span class="o">-</span><span class="n">ax_y_low</span><span class="p">),(</span><span class="n">ax_x_high</span><span class="o">-</span><span class="n">ax_x_low</span><span class="p">)</span>
            <span class="n">ax_heights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax_height</span><span class="p">)</span>
            <span class="n">ax_widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax_width</span><span class="p">)</span>
        <span class="n">max_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ax_heights</span><span class="p">)</span>
        <span class="n">max_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ax_widths</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
            <span class="n">ax_x_low</span><span class="p">,</span><span class="n">ax_y_low</span> <span class="o">=</span> <span class="n">_ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
            <span class="n">ax_x_high</span><span class="p">,</span><span class="n">ax_y_high</span> <span class="o">=</span> <span class="n">_ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">axes_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_y_high</span><span class="o">-</span><span class="n">ax_y_low</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ax_x_high</span><span class="o">-</span><span class="n">ax_x_low</span><span class="p">)</span>

            <span class="n">delta</span> <span class="o">=</span> <span class="n">max_height</span> <span class="o">-</span> <span class="p">(</span><span class="n">ax_y_high</span> <span class="o">-</span> <span class="n">ax_y_low</span><span class="p">)</span>
            <span class="n">ax_y_high</span> <span class="o">+=</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax_y_low</span> <span class="o">-=</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">ax_y_low</span><span class="p">,</span><span class="n">ax_y_high</span><span class="p">))</span>

            <span class="n">delta</span> <span class="o">=</span> <span class="n">max_width</span> <span class="o">-</span> <span class="p">(</span><span class="n">ax_x_high</span> <span class="o">-</span> <span class="n">ax_x_low</span><span class="p">)</span>
            <span class="n">ax_x_high</span> <span class="o">+=</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax_x_low</span> <span class="o">-=</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">ax_x_low</span><span class="p">,</span><span class="n">ax_x_high</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span> <span class="c1"># make the transformations have well defined values</span>
    
    <span class="c1"># make axes use the full axsize</span>
    <span class="k">for</span> <span class="n">_ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
        <span class="n">ax_x_low</span><span class="p">,</span><span class="n">ax_y_low</span> <span class="o">=</span> <span class="n">_ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">ax_x_high</span><span class="p">,</span><span class="n">ax_y_high</span> <span class="o">=</span> <span class="n">_ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">axes_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_y_high</span><span class="o">-</span><span class="n">ax_y_low</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ax_x_high</span><span class="o">-</span><span class="n">ax_x_low</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aspect_ratio</span> <span class="o">&gt;</span> <span class="n">axes_ratio</span><span class="p">:</span>
            <span class="c1"># increase height</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">aspect_ratio</span> <span class="o">/</span> <span class="n">axes_ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ax_y_high</span> <span class="o">-</span> <span class="n">ax_y_low</span><span class="p">)</span>
            <span class="n">ax_y_high</span> <span class="o">+=</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax_y_low</span> <span class="o">-=</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">ax_y_low</span><span class="p">,</span><span class="n">ax_y_high</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># increase width</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">axes_ratio</span> <span class="o">/</span> <span class="n">aspect_ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ax_x_high</span> <span class="o">-</span> <span class="n">ax_x_low</span><span class="p">)</span>
            <span class="n">ax_x_high</span> <span class="o">+=</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax_x_low</span> <span class="o">-=</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">ax_x_low</span><span class="p">,</span><span class="n">ax_x_high</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">_add_legend_or_colorbars</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">min_max</span><span class="o">=</span><span class="n">min_max</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>



<span class="k">def</span> <span class="nf">get_cellsize</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;OTT&#39;</span><span class="p">,</span> <span class="n">reference_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_key</span><span class="o">=</span><span class="s1">&#39;OTT&#39;</span><span class="p">,</span> <span class="n">pfn_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">key</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">reference_adata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">counts</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">pfn</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">reference_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># basic level of rescaling: using common genes only</span>
        <span class="n">bare_read_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">X</span> <span class="o">@</span> <span class="n">pfn</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="c1">#print(&#39;get_cell_size0:&#39;,pfn.sum())</span>
        <span class="k">if</span> <span class="n">pfn_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pfn_key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">varm</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="n">pfn_key</span><span class="p">]:</span>
                <span class="n">pfn</span> <span class="o">=</span> <span class="n">pfn</span> <span class="o">*</span> <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="n">pfn_key</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="c1">#print(&#39;multiplying&#39;, adata.varm[pfn_key][key].to_numpy())</span>
            <span class="k">if</span> <span class="n">pfn_key</span> <span class="ow">in</span> <span class="n">reference_adata</span><span class="o">.</span><span class="n">varm</span> <span class="ow">and</span> <span class="n">reference_key</span> <span class="ow">in</span> <span class="n">reference_adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="n">pfn_key</span><span class="p">]:</span>
                <span class="n">pfn</span> <span class="o">=</span> <span class="n">pfn</span> <span class="o">/</span> <span class="n">reference_adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="n">pfn_key</span><span class="p">][</span><span class="n">reference_key</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="c1">#print(&#39;dividing&#39;, reference_adata.varm[pfn_key][reference_key].reindex(adata.var.index).to_numpy())</span>
        <span class="c1">#print(&#39;get_cell_size1:&#39;,pfn.sum())</span>
        <span class="n">pfn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">pfn</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1">#print(&#39;get_cell_size2:&#39;,pfn.sum())</span>
        <span class="n">read_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">X</span> <span class="o">@</span> <span class="n">pfn</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">read_count</span> <span class="o">*=</span> <span class="n">bare_read_count</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">read_count</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">counts</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">read_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="n">by_cells</span> <span class="o">=</span> <span class="n">solution</span> <span class="o">/</span> <span class="n">solution</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">by_reads</span> <span class="o">=</span> <span class="n">by_cells</span> <span class="o">*</span> <span class="n">read_count</span><span class="p">[</span><span class="n">solution</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">cellsize</span> <span class="o">=</span> <span class="n">by_reads</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">by_cells</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">cellsize</span>

<span class="k">def</span> <span class="nf">_validate_cross_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">basis_adata</span><span class="p">,</span> <span class="n">basis_keys</span><span class="p">,</span> <span class="n">reads</span><span class="p">,</span> <span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">_validate_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">basis_adata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basis_adata</span> <span class="o">=</span> <span class="n">adata</span>
    <span class="k">if</span> <span class="n">basis_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basis_keys</span> <span class="o">=</span> <span class="n">keys</span>
    
    <span class="n">basis_typing_data</span><span class="p">,</span> <span class="n">basis_adatas</span><span class="p">,</span> <span class="n">basis_methods</span><span class="p">,</span> <span class="n">basis_types</span><span class="p">,</span> <span class="n">basis_colors</span> <span class="o">=</span> <span class="n">_validate_args</span><span class="p">(</span><span class="n">basis_adata</span><span class="p">,</span> <span class="n">basis_keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">basis_types</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The available types provided in adata </span><span class="si">%s</span><span class="s1"> and basis adata </span><span class="si">%s</span><span class="s1"> dont agree!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">basis_types</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">basis_typing_data</span><span class="p">,</span> <span class="n">basis_adatas</span><span class="p">,</span> <span class="n">basis_methods</span>

<span class="k">def</span> <span class="nf">_cross_scatter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The shapes of the data and axs arrays </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> dont agree!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">n_y</span><span class="p">,</span> <span class="n">n_x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_y</span><span class="p">):</span>
            <span class="n">x_data</span><span class="p">,</span><span class="n">y_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">common</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">index</span>
            <span class="n">common</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">x_data</span><span class="p">[</span><span class="n">x_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">common</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">y_data</span><span class="p">[</span><span class="n">y_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            
            <span class="n">_scatter_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">x_data</span><span class="p">[</span><span class="n">common</span><span class="p">],</span><span class="n">y</span><span class="o">=</span><span class="n">y_data</span><span class="p">[</span><span class="n">common</span><span class="p">],</span>
                       <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">common</span><span class="p">],</span>
                       <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="n">n_y</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">rotation</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">y</span><span class="p">],</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                        
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n_x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="n">colors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">],</span>
              <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="cellsize">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.cellsize.html#tacco.plots.cellsize">[docs]</a>
<span class="k">def</span> <span class="nf">cellsize</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">),</span>
    <span class="n">basis_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pfn_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_reference</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">method_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Scatter plots of average cell sizes in an annotation category in the whole</span>
<span class="sd">    dataset against some reference dataset. These cell sizes are given as the</span>
<span class="sd">    average number of counts per unit cell.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` including annotation in `.obs` and/or `.obsm`.</span>
<span class="sd">        Can also be a mapping of labels to :class:`~anndata.AnnData` to specify</span>
<span class="sd">        multiple datasets.</span>
<span class="sd">    keys</span>
<span class="sd">        The `.obs`/`.obsm` annotation keys to compare. Can be a single string, or a</span>
<span class="sd">        list of strings, or a mapping of the labels of `adata` to strings or lists</span>
<span class="sd">        of strings.</span>
<span class="sd">    colors</span>
<span class="sd">        A mapping of annotation values to colors. If `None`, default colors are used.</span>
<span class="sd">    show_only</span>
<span class="sd">        A subset of annotation values to restrict the plotting to.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis.</span>
<span class="sd">    basis_adata</span>
<span class="sd">        like `adata`, but for reference data.</span>
<span class="sd">    basis_keys</span>
<span class="sd">        like `adata`, but for reference data.</span>
<span class="sd">    pfn_key</span>
<span class="sd">        A `.varm` key containing platform normalization factors. Ignored if platform</span>
<span class="sd">        normalization is not requested via `use_reference`.</span>
<span class="sd">    use_reference</span>
<span class="sd">        Whether and how to use reference data for the determination of cell sizes in</span>
<span class="sd">        non-reference data.</span>
<span class="sd">        Can be a single choice or an array of choices. Possible choices are:</span>
<span class="sd">        </span>
<span class="sd">        - `False`: Dont use the reference</span>
<span class="sd">        - `True`: Determine the cell sizes on the set of common genes with the</span>
<span class="sd">          reference data</span>
<span class="sd">        - &#39;pfn&#39;: Like `True`, but use additionally platform normalization factors.</span>
<span class="sd">        - `None`: Use all settings which are available, i.e. includes `True`, `False,</span>
<span class="sd">          and if `pfn_key!=None` also &#39;pfn&#39;.</span>
<span class="sd">    method_labels</span>
<span class="sd">        A mapping from the strings in `keys` and `basis_keys` to (shorter) names</span>
<span class="sd">        to show in the plot.</span>
<span class="sd">    counts_location</span>
<span class="sd">        A string or tuple specifying where the count matrix is stored, e.g. `&#39;X&#39;`,</span>
<span class="sd">        `(&#39;raw&#39;,&#39;X&#39;)`, `(&#39;raw&#39;,&#39;obsm&#39;,&#39;my_counts_key&#39;)`, `(&#39;layer&#39;,&#39;my_counts_key&#39;)`,</span>
<span class="sd">        ... For details see :func:`~tacco.get.counts`.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">basis_typing_data</span><span class="p">,</span> <span class="n">basis_adatas</span><span class="p">,</span> <span class="n">basis_methods</span> <span class="o">=</span> <span class="n">_validate_cross_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">basis_adata</span><span class="p">,</span> <span class="n">basis_keys</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
    <span class="n">n_solutions</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">typing_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
    <span class="n">n_solutions_basis</span><span class="p">,</span> <span class="n">n_samples_basis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_typing_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_adatas</span><span class="p">)</span>
    
    <span class="n">possible_use_refs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;pfn&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_reference</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
        <span class="n">use_reference</span> <span class="o">=</span> <span class="p">[</span><span class="n">use_reference</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">use_reference</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pfn_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_reference</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_reference</span> <span class="o">=</span> <span class="n">possible_use_refs</span>
    <span class="k">if</span> <span class="s1">&#39;pfn&#39;</span> <span class="ow">in</span> <span class="n">use_reference</span> <span class="ow">and</span> <span class="n">pfn_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;If platform normalization is desired (as indicated by specifying &quot;pfn&quot; in the &quot;use_reference&quot; argument), the argument &quot;pfn_key&quot; has to be specified!&#39;</span><span class="p">)</span>
    <span class="n">use_ref_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">use_ref</span> <span class="ow">in</span> <span class="n">use_reference</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_ref</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_use_refs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The argument use_reference got the unknown value &quot;</span><span class="si">%s</span><span class="s1">&quot;! Only </span><span class="si">%s</span><span class="s1"> are possible.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">use_ref</span><span class="p">,</span> <span class="n">possible_use_refs</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_ref</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">use_ref</span> <span class="o">==</span> <span class="s1">&#39;pfn&#39;</span><span class="p">:</span>
                <span class="n">use_ref_label</span> <span class="o">=</span> <span class="s1">&#39; - platform corrected&#39;</span>
        <span class="k">elif</span> <span class="n">use_ref</span><span class="p">:</span> <span class="c1"># ignore pfn for cellsize estimation</span>
            <span class="n">use_ref_label</span> <span class="o">=</span> <span class="s1">&#39; - common genes&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># ignore reference for cellsize estimation</span>
            <span class="n">use_ref_label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">use_ref_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">use_ref_label</span><span class="p">)</span>
        
    <span class="n">n_x</span> <span class="o">=</span> <span class="n">n_solutions</span>
    <span class="n">n_y</span> <span class="o">=</span> <span class="n">n_solutions_basis</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_reference</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">n_x</span><span class="p">,</span><span class="n">n_y</span><span class="p">,</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">typing_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">basis_typing_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">y</span> <span class="o">%</span> <span class="n">n_solutions_basis</span><span class="p">]</span> <span class="o">+</span> <span class="n">use_ref_labels</span><span class="p">[</span><span class="n">y</span> <span class="o">//</span> <span class="n">n_solutions_basis</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_y</span><span class="p">)])</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_y</span><span class="p">):</span>
            <span class="n">x_key</span> <span class="o">=</span> <span class="n">typing_data</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">x_adata</span> <span class="o">=</span> <span class="n">adatas</span><span class="p">[</span><span class="n">typing_data</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
            
            <span class="n">y_key</span> <span class="o">=</span> <span class="n">basis_typing_data</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">y</span> <span class="o">%</span> <span class="n">n_solutions_basis</span><span class="p">]</span>
            <span class="n">y_adata</span> <span class="o">=</span> <span class="n">basis_adatas</span><span class="p">[</span><span class="n">basis_typing_data</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">y</span> <span class="o">%</span> <span class="n">n_solutions_basis</span><span class="p">]]</span>
            
            <span class="n">use_ref</span> <span class="o">=</span> <span class="n">use_reference</span><span class="p">[</span><span class="n">y</span> <span class="o">//</span> <span class="n">n_solutions_basis</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_ref</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">use_ref</span> <span class="o">==</span> <span class="s1">&#39;pfn&#39;</span><span class="p">:</span>
                    <span class="n">cell_sizes_x</span> <span class="o">=</span> <span class="n">get_cellsize</span><span class="p">(</span><span class="n">x_adata</span><span class="p">,</span> <span class="n">x_key</span><span class="p">,</span> <span class="n">reference_adata</span><span class="o">=</span><span class="n">y_adata</span><span class="p">,</span> <span class="n">reference_key</span><span class="o">=</span><span class="n">y_key</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span><span class="c1">#, pfn_key=None) # no platform normalization effects, only on common genes</span>
                    <span class="n">cell_sizes_y</span> <span class="o">=</span> <span class="n">get_cellsize</span><span class="p">(</span><span class="n">y_adata</span><span class="p">,</span> <span class="n">y_key</span><span class="p">,</span> <span class="n">reference_adata</span><span class="o">=</span><span class="n">x_adata</span><span class="p">,</span> <span class="n">reference_key</span><span class="o">=</span><span class="n">x_key</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">,</span> <span class="n">pfn_key</span><span class="o">=</span><span class="n">pfn_key</span><span class="p">)</span> <span class="c1"># include platform normalization effects for both adatas in these size estimations</span>
            <span class="k">elif</span> <span class="n">use_ref</span><span class="p">:</span> <span class="c1"># ignore pfn for cellsize estimation</span>
                <span class="n">cell_sizes_x</span> <span class="o">=</span> <span class="n">get_cellsize</span><span class="p">(</span><span class="n">x_adata</span><span class="p">,</span> <span class="n">x_key</span><span class="p">,</span> <span class="n">reference_adata</span><span class="o">=</span><span class="n">y_adata</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span> <span class="c1"># no platform normalization effects, only on common genes</span>
                <span class="n">cell_sizes_y</span> <span class="o">=</span> <span class="n">get_cellsize</span><span class="p">(</span><span class="n">y_adata</span><span class="p">,</span> <span class="n">y_key</span><span class="p">,</span> <span class="n">reference_adata</span><span class="o">=</span><span class="n">x_adata</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span> <span class="c1"># include platform normalization effects for both adatas in these size estimations</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># ignore reference for cellsize estimation</span>
                <span class="n">cell_sizes_x</span> <span class="o">=</span> <span class="n">get_cellsize</span><span class="p">(</span><span class="n">x_adata</span><span class="p">,</span> <span class="n">x_key</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
                <span class="n">cell_sizes_y</span> <span class="o">=</span> <span class="n">get_cellsize</span><span class="p">(</span><span class="n">y_adata</span><span class="p">,</span> <span class="n">y_key</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
                
            <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cell_sizes_x</span><span class="p">,</span><span class="n">cell_sizes_y</span><span class="p">)</span>
    
    <span class="n">_cross_scatter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="k">def</span> <span class="nf">_validate_frequency_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">basis_adata</span><span class="p">,</span> <span class="n">basis_keys</span><span class="p">,</span> <span class="n">reads</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">_colors</span> <span class="o">=</span> <span class="n">_validate_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">reads</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">basis_adata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basis_typing_data</span><span class="p">,</span> <span class="n">basis_adatas</span><span class="p">,</span> <span class="n">basis_methods</span><span class="p">,</span> <span class="n">basis_types</span><span class="p">,</span> <span class="n">_colors</span> <span class="o">=</span> <span class="n">_validate_args</span><span class="p">(</span><span class="n">basis_adata</span><span class="p">,</span> <span class="n">basis_keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">reads</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">basis_types</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The available types provided in adata </span><span class="si">%s</span><span class="s1"> and basis adata </span><span class="si">%s</span><span class="s1"> dont agree!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">basis_types</span><span class="p">))</span>
            
        <span class="n">typing_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">basis_typing_data</span><span class="p">,</span> <span class="n">typing_data</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">_colors</span>

<div class="viewcode-block" id="frequency_bar">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.frequency_bar.html#tacco.plots.frequency_bar">[docs]</a>
<span class="k">def</span> <span class="nf">frequency_bar</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">horizontal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">method_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Bar plots of the total frequency of annotation in the whole dataset against</span>
<span class="sd">    some reference dataset.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` including annotation in `.obs` and/or</span>
<span class="sd">        `.obsm`. Can also be a mapping of labels to :class:`~anndata.AnnData`</span>
<span class="sd">        to specify multiple datasets. The :class:`~anndata.AnnData` instances</span>
<span class="sd">        can be replaced also by :class:`~pandas.DataFrame`, which are then</span>
<span class="sd">        treated like the `.obs` of an :class:`~anndata.AnnData`.</span>
<span class="sd">    keys</span>
<span class="sd">        The `.obs`/`.obsm` annotation keys to compare. Can be a single string,</span>
<span class="sd">        or a list of strings, or a mapping of the labels of `adata` to strings</span>
<span class="sd">        or lists of strings.</span>
<span class="sd">    colors</span>
<span class="sd">        A mapping of annotation values to colors. If `None`, default colors are</span>
<span class="sd">        used.</span>
<span class="sd">    show_only</span>
<span class="sd">        A subset of annotation values to restrict the plotting to.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis. If `None`, a default size is</span>
<span class="sd">        chosen automatically.</span>
<span class="sd">    basis_adata</span>
<span class="sd">        like `adata`, but for reference data.</span>
<span class="sd">    basis_keys</span>
<span class="sd">        like `adata`, but for reference data.</span>
<span class="sd">    horizontal</span>
<span class="sd">        Whether to draw the bars horizontally.</span>
<span class="sd">    reads</span>
<span class="sd">        Whether to work with read or cell count fractions.</span>
<span class="sd">    method_labels</span>
<span class="sd">        A mapping from the strings in `keys` and `basis_keys` to (shorter)</span>
<span class="sd">        names to show in the plot.</span>
<span class="sd">    counts_location</span>
<span class="sd">        A string or tuple specifying where the count matrix is stored, e.g.</span>
<span class="sd">        `&#39;X&#39;`, `(&#39;raw&#39;,&#39;X&#39;)`, `(&#39;raw&#39;,&#39;obsm&#39;,&#39;my_counts_key&#39;)`,</span>
<span class="sd">        `(&#39;layer&#39;,&#39;my_counts_key&#39;)`, ... For details see</span>
<span class="sd">        :func:`~tacco.get.counts`.</span>
<span class="sd">    ax</span>
<span class="sd">        The :class:`~matplotlib.axes.Axes` to plot on. If `None`, creates a</span>
<span class="sd">        fresh figure for plotting.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The :class:`~matplotlib.figure.Figure` containing the plot.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">_validate_frequency_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">basis_adata</span><span class="p">,</span> <span class="n">basis_keys</span><span class="p">,</span> <span class="n">reads</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
        
    <span class="n">n_solutions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">typing_data</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
                <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.1</span><span class="p">,</span><span class="mf">0.7</span><span class="o">*</span><span class="n">n_solutions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7</span><span class="o">*</span><span class="n">n_solutions</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>
    
    <span class="n">type_freqs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span> <span class="n">method</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">typing_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">})</span>
    
    <span class="n">norm_tf</span> <span class="o">=</span> <span class="p">(</span><span class="n">type_freqs</span><span class="o">/</span><span class="n">type_freqs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">norm_tf</span> <span class="o">=</span> <span class="n">norm_tf</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">_composition_bar</span><span class="p">(</span><span class="n">norm_tf</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="n">horizontal</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="frequency">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.frequency.html#tacco.plots.frequency">[docs]</a>
<span class="k">def</span> <span class="nf">frequency</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">),</span>
    <span class="n">basis_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">method_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Scatter plots of the total frequency of annotation in the whole dataset</span>
<span class="sd">    against some reference dataset.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` including annotation in `.obs` and/or</span>
<span class="sd">        `.obsm`. Can also be a mapping of labels to :class:`~anndata.AnnData`</span>
<span class="sd">        to specify multiple datasets. The :class:`~anndata.AnnData` instances</span>
<span class="sd">        can be replaced also by :class:`~pandas.DataFrame`, which are then</span>
<span class="sd">        treated like the `.obs` of an :class:`~anndata.AnnData`.</span>
<span class="sd">    keys</span>
<span class="sd">        The `.obs`/`.obsm` annotation keys to compare. Can be a single string,</span>
<span class="sd">        or a list of strings, or a mapping of the labels of `adata` to strings</span>
<span class="sd">        or lists of strings.</span>
<span class="sd">    colors</span>
<span class="sd">        A mapping of annotation values to colors. If `None`, default colors are</span>
<span class="sd">        used.</span>
<span class="sd">    show_only</span>
<span class="sd">        A subset of annotation values to restrict the plotting to.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis.</span>
<span class="sd">    basis_adata</span>
<span class="sd">        like `adata`, but for reference data.</span>
<span class="sd">    basis_keys</span>
<span class="sd">        like `adata`, but for reference data.</span>
<span class="sd">    reads</span>
<span class="sd">        Whether to work with read or cell count fractions.</span>
<span class="sd">    method_labels</span>
<span class="sd">        A mapping from the strings in `keys` and `basis_keys` to (shorter)</span>
<span class="sd">        names to show in the plot.</span>
<span class="sd">    counts_location</span>
<span class="sd">        A string or tuple specifying where the count matrix is stored, e.g.</span>
<span class="sd">        `&#39;X&#39;`, `(&#39;raw&#39;,&#39;X&#39;)`, `(&#39;raw&#39;,&#39;obsm&#39;,&#39;my_counts_key&#39;)`,</span>
<span class="sd">        `(&#39;layer&#39;,&#39;my_counts_key&#39;)`, ... For details see</span>
<span class="sd">        :func:`~tacco.get.counts`.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">basis_typing_data</span><span class="p">,</span> <span class="n">basis_adatas</span><span class="p">,</span> <span class="n">basis_methods</span> <span class="o">=</span> <span class="n">_validate_cross_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">basis_adata</span><span class="p">,</span> <span class="n">basis_keys</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
    <span class="n">n_solutions</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">typing_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
    <span class="n">n_solutions_basis</span><span class="p">,</span> <span class="n">n_samples_basis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_typing_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_adatas</span><span class="p">)</span>
    
    <span class="n">n_x</span> <span class="o">=</span> <span class="n">n_solutions</span>
    <span class="n">n_y</span> <span class="o">=</span> <span class="n">n_solutions_basis</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">n_x</span><span class="p">,</span><span class="n">n_y</span><span class="p">,</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">type_freqs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span> <span class="n">method</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">typing_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">})</span>
    <span class="n">type_freqs</span> <span class="o">=</span> <span class="n">type_freqs</span> <span class="o">/</span> <span class="n">type_freqs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># normalize freqs</span>
    
    <span class="n">basis_type_freqs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span> <span class="n">method</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">basis_typing_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">})</span>
    <span class="n">basis_type_freqs</span> <span class="o">=</span> <span class="n">basis_type_freqs</span> <span class="o">/</span> <span class="n">basis_type_freqs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># normalize freqs</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">typing_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">basis_typing_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_y</span><span class="p">):</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="n">type_freqs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">x</span><span class="p">]</span>
            <span class="n">y_data</span> <span class="o">=</span> <span class="n">basis_type_freqs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">y</span><span class="p">]</span>
            <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_data</span><span class="p">,</span><span class="n">y_data</span><span class="p">)</span>
        
    <span class="n">_cross_scatter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="comparison">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.comparison.html#tacco.plots.comparison">[docs]</a>
<span class="k">def</span> <span class="nf">comparison</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">keys</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">),</span>
    <span class="n">basis_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">method_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">counts_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">point_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">joint</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Scatterplots of the annotation fractions of different annotations, e.g. of</span>
<span class="sd">    different annotation methods or of methods and a ground truth.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` including annotation in `.obs` and/or `.obsm`.</span>
<span class="sd">        Can also be a mapping of labels to :class:`~anndata.AnnData` to specify</span>
<span class="sd">        multiple datasets.</span>
<span class="sd">    keys</span>
<span class="sd">        The `.obs`/`.obsm` annotation keys to compare. Can be a single string, or a</span>
<span class="sd">        list of strings, or a mapping of the labels of `adata` to strings or lists</span>
<span class="sd">        of strings.</span>
<span class="sd">    colors</span>
<span class="sd">        A mapping of annotation values to colors. If `None`, default colors are used.</span>
<span class="sd">    show_only</span>
<span class="sd">        A subset of annotation values to restrict the plotting to.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis.</span>
<span class="sd">    basis_adata</span>
<span class="sd">        like `adata`, but for reference data.</span>
<span class="sd">    basis_keys</span>
<span class="sd">        like `adata`, but for reference data.</span>
<span class="sd">    method_labels</span>
<span class="sd">        A mapping from the strings in `keys` and `basis_keys` to (shorter) names</span>
<span class="sd">        to show in the plot.</span>
<span class="sd">    counts_location</span>
<span class="sd">        A string or tuple specifying where the count matrix is stored, e.g. `&#39;X&#39;`,</span>
<span class="sd">        `(&#39;raw&#39;,&#39;X&#39;)`, `(&#39;raw&#39;,&#39;obsm&#39;,&#39;my_counts_key&#39;)`, `(&#39;layer&#39;,&#39;my_counts_key&#39;)`,</span>
<span class="sd">        ... For details see :func:`~tacco.get.counts`.</span>
<span class="sd">    point_size</span>
<span class="sd">        The size of the points in the plot.</span>
<span class="sd">    joint</span>
<span class="sd">        Whether to plot only one scatter plot with all annotation categories or only</span>
<span class="sd">        the scatter plots with one annotation category per plot. If `None`, plot both.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">typing_data</span><span class="p">,</span> <span class="n">adatas</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">basis_typing_data</span><span class="p">,</span> <span class="n">basis_adatas</span><span class="p">,</span> <span class="n">basis_methods</span> <span class="o">=</span> <span class="n">_validate_cross_args</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">basis_adata</span><span class="p">,</span> <span class="n">basis_keys</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method_labels</span><span class="o">=</span><span class="n">method_labels</span><span class="p">,</span> <span class="n">counts_location</span><span class="o">=</span><span class="n">counts_location</span><span class="p">)</span>
    <span class="n">n_solutions</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">typing_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
    <span class="n">n_solutions_basis</span><span class="p">,</span> <span class="n">n_samples_basis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_typing_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_adatas</span><span class="p">)</span>
    
    <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">n_x</span> <span class="o">=</span> <span class="n">n_solutions</span>
    <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_y</span> <span class="o">=</span> <span class="n">n_types</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">joint</span><span class="p">:</span>
        <span class="n">n_y</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_y</span> <span class="o">=</span> <span class="n">n_types</span>
    <span class="n">n_y</span> <span class="o">=</span> <span class="n">n_solutions_basis</span> <span class="o">*</span> <span class="n">n_y</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">n_x</span><span class="p">,</span><span class="n">n_y</span><span class="p">,</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
        <span class="c1">#ax.grid(False)</span>
        <span class="c1">#ax.axes.xaxis.set_ticks([])</span>
        <span class="c1">#ax.axes.yaxis.set_ticks([])</span>
        <span class="k">pass</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">basis_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">basis_typing_data</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="n">basis_sample</span><span class="p">,</span> <span class="n">basis_type_freqs</span> <span class="o">=</span> <span class="n">basis_typing_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">basis_name</span><span class="p">,[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">]]</span>
        <span class="n">basis_type_freqs</span> <span class="o">/=</span> <span class="n">basis_type_freqs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span><span class="kc">None</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">typing_data</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        
            <span class="n">sample</span><span class="p">,</span> <span class="n">type_freqs</span> <span class="o">=</span> <span class="n">typing_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">]]</span>
            <span class="n">type_freqs</span> <span class="o">/=</span> <span class="n">type_freqs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span><span class="kc">None</span><span class="p">]</span>
            
            <span class="n">common</span> <span class="o">=</span> <span class="n">type_freqs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">basis_type_freqs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">type_freqs</span> <span class="o">=</span> <span class="n">type_freqs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common</span><span class="p">]</span>
            <span class="n">_basis_type_freqs</span> <span class="o">=</span> <span class="n">basis_type_freqs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common</span><span class="p">]</span>
            
            <span class="k">def</span> <span class="nf">plotit</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">type_freqs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">_basis_type_freqs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">joint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">joint_ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_types</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                    <span class="n">plotit</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">joint_ax</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_types</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">it</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">plotit</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
                    <span class="n">pc</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_correlations</span><span class="p">(</span><span class="n">type_freqs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">_basis_type_freqs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1">#ax.set_title(&#39;%s\nr=%.2f $\\chi^2_m$=%.2f&#39;%(t, pc, x2))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;r=</span><span class="si">%.2f</span><span class="s1"> $</span><span class="se">\\</span><span class="s1">chi^2_m$=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
                <span class="n">pc</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_correlations</span><span class="p">(</span><span class="n">type_freqs</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">_basis_type_freqs</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">joint_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;r=</span><span class="si">%.2f</span><span class="s1"> $</span><span class="se">\\</span><span class="s1">chi^2_m$=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">joint</span><span class="p">:</span>
                <span class="n">joint_ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">plotit</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">joint_ax</span><span class="p">)</span>
                <span class="n">pc</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_correlations</span><span class="p">(</span><span class="n">type_freqs</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">_basis_type_freqs</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">joint_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;r=</span><span class="si">%.2f</span><span class="s1"> $</span><span class="se">\\</span><span class="s1">chi^2_m$=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">n_types</span> <span class="o">+</span> <span class="n">it</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">plotit</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
                    <span class="n">pc</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_correlations</span><span class="p">(</span><span class="n">type_freqs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">_basis_type_freqs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1">#ax.set_title(&#39;%s\nr=%.2f $\\chi^2_m$=%.2f&#39;%(t, pc, x2))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;r=</span><span class="si">%.2f</span><span class="s1"> $</span><span class="se">\\</span><span class="s1">chi^2_m$=</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
            
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">n_y</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span><span class="n">typing_data</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="c1">#ax.tick_params(axis=&#39;x&#39;, rotation=45, which=&#39;both&#39;)</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span><span class="n">basis_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">(</span><span class="n">basis_typing_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_y</span><span class="o">//</span><span class="n">n_solutions_basis</span><span class="p">)):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">basis_name</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                        
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n_x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="n">colors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">],</span>
              <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1">#typing = pd.Series({&#39;%s (%s)&#39; % (name, basis_name): pd.get_dummies(mdata.obs[&#39;split_type&#39;])})</span>
            
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="compositions">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.compositions.html#tacco.plots.compositions">[docs]</a>
<span class="k">def</span> <span class="nf">compositions</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">value_key</span><span class="p">,</span>
    <span class="n">group_key</span><span class="p">,</span>
    <span class="n">basis_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_value_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_group_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fillna</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">horizontal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Plot compositions of groups. In contrast to :func:`~tacco.plots.contribution`, compositions</span>
<span class="sd">    have to add up to one.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` with annotation in `.obs`.</span>
<span class="sd">    value_key</span>
<span class="sd">        The `.obs` or `.obsm` key with the values to determine the</span>
<span class="sd">        enrichment for.</span>
<span class="sd">    group_key</span>
<span class="sd">        The `.obs` key with categorical group information.</span>
<span class="sd">    basis_adata</span>
<span class="sd">        Another :class:`~anndata.AnnData` with annotation in `.obs`</span>
<span class="sd">        to compare. If `None`, only the `adata` composition is shown.</span>
<span class="sd">    basis_value_key</span>
<span class="sd">        The `.obs` or `.obsm` key for `basis_adata` with the values</span>
<span class="sd">        to determine the enrichment for. If `None`, `value_key` is used.</span>
<span class="sd">    basis_group_key</span>
<span class="sd">        The `.obs` key with categorical group information for</span>
<span class="sd">        `basis_adata`. If `None`, `value_key` is used.</span>
<span class="sd">    fillna</span>
<span class="sd">        If `None`, observation containing NA in the values are filtered.</span>
<span class="sd">        Else, NA values are replaced with this value.</span>
<span class="sd">    restrict_groups</span>
<span class="sd">        A list-like containing the groups within which the enrichment analysis is</span>
<span class="sd">        to be done. If `None`, all groups are included.</span>
<span class="sd">    restrict_values</span>
<span class="sd">        A list-like containing the values within which the enrichment analysis is</span>
<span class="sd">        to be done. If `None`, all values are included. Works only for categorical</span>
<span class="sd">        values.</span>
<span class="sd">    basis_restrict_groups</span>
<span class="sd">        Like `restrict_groups` but for `basis_adata`.</span>
<span class="sd">    basis_restrict_values</span>
<span class="sd">        Like `restrict_values` but for `basis_adata`.</span>
<span class="sd">    reads</span>
<span class="sd">        Whether to weight the values by the total count per observation</span>
<span class="sd">    colors</span>
<span class="sd">        The mapping of value names to colors. If `None`, a set of</span>
<span class="sd">        standard colors is used.</span>
<span class="sd">    horizontal</span>
<span class="sd">        Whether to plot the bar plot horizontally.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis. If `None`, use</span>
<span class="sd">        automatic values.</span>
<span class="sd">    ax</span>
<span class="sd">        The :class:`~matplotlib.axes.Axes` to plot on. If `None`, creates a</span>
<span class="sd">        fresh figure for plotting.</span>
<span class="sd">    legend</span>
<span class="sd">        Whether to include the legend</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure` if `ax` is `None`, else `None`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">compositions</span> <span class="o">=</span> <span class="n">get_compositions</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span> <span class="n">value_key</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span> <span class="n">group_key</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span> <span class="n">restrict_groups</span><span class="o">=</span><span class="n">restrict_groups</span><span class="p">,</span> <span class="n">restrict_values</span><span class="o">=</span><span class="n">restrict_values</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">)</span>
    
    <span class="n">colors</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_get_colors</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">compositions</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">basis_adata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">basis_value_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_value_key</span> <span class="o">=</span> <span class="n">value_key</span>
        <span class="k">if</span> <span class="n">basis_group_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_group_key</span> <span class="o">=</span> <span class="n">group_key</span>
        <span class="n">basis_compositions</span> <span class="o">=</span> <span class="n">get_compositions</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">basis_adata</span><span class="p">,</span> <span class="n">value_key</span><span class="o">=</span><span class="n">basis_value_key</span><span class="p">,</span> <span class="n">group_key</span><span class="o">=</span><span class="n">basis_group_key</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span> <span class="n">restrict_groups</span><span class="o">=</span><span class="n">basis_restrict_groups</span><span class="p">,</span> <span class="n">restrict_values</span><span class="o">=</span><span class="n">basis_restrict_values</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">)</span>
    
        <span class="n">basis_compositions</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">basis_compositions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (reference)&#39;</span>
        <span class="n">compositions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">basis_compositions</span><span class="p">,</span><span class="n">compositions</span><span class="p">])</span>
    
    <span class="n">n_solutions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compositions</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
                <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.1</span><span class="p">,</span><span class="mf">0.7</span><span class="o">*</span><span class="n">n_solutions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7</span><span class="o">*</span><span class="n">n_solutions</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">_composition_bar</span><span class="p">(</span><span class="n">compositions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="n">horizontal</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="k">def</span> <span class="nf">_prep_contributions</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">value_key</span><span class="p">,</span>
    <span class="n">group_key</span><span class="p">,</span>
    <span class="n">sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_value_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_group_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fillna</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
    <span class="n">normalization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">assume_counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Prepares contribution data.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` with annotation in `.obs`.</span>
<span class="sd">    value_key</span>
<span class="sd">        The `.obs` or `.obsm` key with the values to determine the</span>
<span class="sd">        enrichment for.</span>
<span class="sd">    group_key</span>
<span class="sd">        The `.obs` key with categorical group information.</span>
<span class="sd">    sample_key</span>
<span class="sd">        The `.obs` key with categorical sample information. If `None`,</span>
<span class="sd">        only the aggregated data is plotted. Otherwise the data is aggregated</span>
<span class="sd">        per sample and total and per-sample values are plotted.</span>
<span class="sd">    basis_adata</span>
<span class="sd">        Another :class:`~anndata.AnnData` with annotation in `.obs`</span>
<span class="sd">        to compare. If `None`, only the `adata` composition is shown.</span>
<span class="sd">    basis_value_key</span>
<span class="sd">        The `.obs` or `.obsm` key for `basis_adata` with the values</span>
<span class="sd">        to determine the enrichment for. If `None`, `value_key` is used.</span>
<span class="sd">    basis_group_key</span>
<span class="sd">        The `.obs` key with categorical group information for</span>
<span class="sd">        `basis_adata`. If `None`, `value_key` is used.</span>
<span class="sd">    basis_sample_key</span>
<span class="sd">        The `.obs` key with categorical sample information for</span>
<span class="sd">        `basis_adata`. If `None`, `sample_key` is used.</span>
<span class="sd">    fillna</span>
<span class="sd">        If `None`, observation containing NA in the values are filtered.</span>
<span class="sd">        Else, NA values are replaced with this value.</span>
<span class="sd">    restrict_groups</span>
<span class="sd">        A list-like containing the groups within which the enrichment analysis</span>
<span class="sd">        is to be done. If `None`, all groups are included.</span>
<span class="sd">    restrict_values</span>
<span class="sd">        A list-like containing the values within which the enrichment analysis</span>
<span class="sd">        is to be done. If `None`, all values are included. Works only for</span>
<span class="sd">        categorical values.</span>
<span class="sd">    basis_restrict_groups</span>
<span class="sd">        Like `restrict_groups` but for `basis_adata`.</span>
<span class="sd">    basis_restrict_values</span>
<span class="sd">        Like `restrict_values` but for `basis_adata`.</span>
<span class="sd">    reduction</span>
<span class="sd">        The reduction to apply on each (group,sample) subset of the data.</span>
<span class="sd">        Possible values are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;sum&#39;: sum of the values over observations</span>
<span class="sd">        - &#39;mean&#39;: mean of the values over observations</span>
<span class="sd">        - &#39;median&#39;: median of the values over observations</span>
<span class="sd">        - a callable mapping a :class:`~pandas.DataFrame` to its reduced</span>
<span class="sd">          counterpart</span>
<span class="sd">    </span>
<span class="sd">    normalization</span>
<span class="sd">        The normalization to apply on each reduced (group,sample) subset of the</span>
<span class="sd">        data. Possible values are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;sum&#39;: normalize values by their sum (yields fractions)</span>
<span class="sd">        - &#39;percent&#39;: like &#39;sum&#39; scaled by 100 (yields percentages)</span>
<span class="sd">        - &#39;gmean&#39;: normalize values by their geometric mean (yields</span>
<span class="sd">          contributions which make more sense for enrichments than fractions,</span>
<span class="sd">          due to zero-sum issue; see :func:`~tacco.tools.enrichments`)</span>
<span class="sd">        - &#39;clr&#39;: &quot;Center logratio transform&quot;; like &#39;gmean&#39; with additional log</span>
<span class="sd">          transform; makes the distribution more normal and better suited for t</span>
<span class="sd">          tests</span>
<span class="sd">        - `None`: no normalization</span>
<span class="sd">        - a value name from `value_key`: all values are normalized to this</span>
<span class="sd">          contribution</span>
<span class="sd">        - a callable mapping a :class:`~pandas.DataFrame` to its normalized</span>
<span class="sd">          counterpart</span>
<span class="sd">    </span>
<span class="sd">    assume_counts</span>
<span class="sd">        Ony relevant for `normalization==&#39;gmean&#39;` and `normalization==&#39;clr&#39;`;</span>
<span class="sd">        whether to regularize zeros by adding a pseudo count of 1 or by</span>
<span class="sd">        replacing them by 1e-3 of the minimum value. If `None`, check whether</span>
<span class="sd">        the data are consistent with count data and assume counts accordingly,</span>
<span class="sd">        except if `reads==True`, then also `assume_counts==True`.</span>
<span class="sd">    reads</span>
<span class="sd">        Whether to weight the values by the total count per observation</span>
<span class="sd">    colors</span>
<span class="sd">        The mapping of value names to colors. If `None`, a set of</span>
<span class="sd">        standard colors is used.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A tuple containing contributions, detailed_contributions, colors, types.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contributions</span> <span class="o">=</span> <span class="n">get_contributions</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span> <span class="n">value_key</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span> <span class="n">group_key</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span> <span class="n">sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span> <span class="n">restrict_groups</span><span class="o">=</span><span class="n">restrict_groups</span><span class="p">,</span> <span class="n">restrict_values</span><span class="o">=</span><span class="n">restrict_values</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span> <span class="n">assume_counts</span><span class="o">=</span><span class="n">assume_counts</span><span class="p">)</span>
    <span class="n">detailed_contributions</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">sample_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">detailed_contributions</span> <span class="o">=</span> <span class="n">get_contributions</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span> <span class="n">value_key</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span> <span class="n">group_key</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span> <span class="n">sample_key</span><span class="o">=</span><span class="n">sample_key</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span> <span class="n">restrict_groups</span><span class="o">=</span><span class="n">restrict_groups</span><span class="p">,</span> <span class="n">restrict_values</span><span class="o">=</span><span class="n">restrict_values</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span> <span class="n">assume_counts</span><span class="o">=</span><span class="n">assume_counts</span><span class="p">)</span>
    
    <span class="n">colors</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_get_colors</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">basis_adata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">basis_value_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_value_key</span> <span class="o">=</span> <span class="n">value_key</span>
        <span class="k">if</span> <span class="n">basis_group_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_group_key</span> <span class="o">=</span> <span class="n">group_key</span>
        <span class="k">if</span> <span class="n">basis_sample_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_sample_key</span> <span class="o">=</span> <span class="n">sample_key</span>
        <span class="n">basis_contributions</span> <span class="o">=</span> <span class="n">get_contributions</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">basis_adata</span><span class="p">,</span> <span class="n">value_key</span><span class="o">=</span><span class="n">basis_value_key</span><span class="p">,</span> <span class="n">group_key</span><span class="o">=</span><span class="n">basis_group_key</span><span class="p">,</span> <span class="n">sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span> <span class="n">restrict_groups</span><span class="o">=</span><span class="n">basis_restrict_groups</span><span class="p">,</span> <span class="n">restrict_values</span><span class="o">=</span><span class="n">basis_restrict_values</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span> <span class="n">assume_counts</span><span class="o">=</span><span class="n">assume_counts</span><span class="p">)</span>
    
        <span class="n">basis_contributions</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">basis_contributions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (reference)&#39;</span>
        <span class="n">contributions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">basis_contributions</span><span class="p">,</span><span class="n">contributions</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">sample_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">basis_sample_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">basis_sample_key</span> <span class="o">=</span> <span class="n">sample_key</span>
            <span class="n">detailed_basis_contributions</span> <span class="o">=</span> <span class="n">get_contributions</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">basis_adata</span><span class="p">,</span> <span class="n">value_key</span><span class="o">=</span><span class="n">basis_value_key</span><span class="p">,</span> <span class="n">group_key</span><span class="o">=</span><span class="n">basis_group_key</span><span class="p">,</span> <span class="n">sample_key</span><span class="o">=</span><span class="n">basis_sample_key</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span> <span class="n">restrict_groups</span><span class="o">=</span><span class="n">basis_restrict_groups</span><span class="p">,</span> <span class="n">restrict_values</span><span class="o">=</span><span class="n">basis_restrict_values</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span> <span class="n">assume_counts</span><span class="o">=</span><span class="n">assume_counts</span><span class="p">)</span>
    
            <span class="n">detailed_basis_contributions</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">detailed_basis_contributions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_levels</span><span class="p">([</span><span class="n">detailed_basis_contributions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (reference)&#39;</span><span class="p">,</span><span class="n">detailed_basis_contributions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="p">])</span>
            <span class="n">detailed_basis_contributions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">detailed_contributions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
            <span class="n">detailed_contributions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">detailed_basis_contributions</span><span class="p">,</span><span class="n">detailed_contributions</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">contributions</span><span class="p">,</span> <span class="n">detailed_contributions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">types</span>

<div class="viewcode-block" id="contribution">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.contribution.html#tacco.plots.contribution">[docs]</a>
<span class="k">def</span> <span class="nf">contribution</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">value_key</span><span class="p">,</span>
    <span class="n">group_key</span><span class="p">,</span>
    <span class="n">sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_value_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_group_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fillna</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
    <span class="n">normalization</span><span class="o">=</span><span class="s1">&#39;gmean&#39;</span><span class="p">,</span>
    <span class="n">assume_counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Plot contribution to groups. In contrast to :func:`~tacco.plots.composition`,</span>
<span class="sd">    contributions dont have to add up to one.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` with annotation in `.obs`.</span>
<span class="sd">    value_key</span>
<span class="sd">        The `.obs` or `.obsm` key with the values to determine the</span>
<span class="sd">        enrichment for.</span>
<span class="sd">    group_key</span>
<span class="sd">        The `.obs` key with categorical group information.</span>
<span class="sd">    sample_key</span>
<span class="sd">        The `.obs` key with categorical sample information. If `None`,</span>
<span class="sd">        only the aggregated data is plotted. Otherwise the data is aggregated</span>
<span class="sd">        per sample and total and per-sample values are plotted.</span>
<span class="sd">    basis_adata</span>
<span class="sd">        Another :class:`~anndata.AnnData` with annotation in `.obs`</span>
<span class="sd">        to compare. If `None`, only the `adata` composition is shown.</span>
<span class="sd">    basis_value_key</span>
<span class="sd">        The `.obs` or `.obsm` key for `basis_adata` with the values</span>
<span class="sd">        to determine the enrichment for. If `None`, `value_key` is used.</span>
<span class="sd">    basis_group_key</span>
<span class="sd">        The `.obs` key with categorical group information for</span>
<span class="sd">        `basis_adata`. If `None`, `value_key` is used.</span>
<span class="sd">    basis_sample_key</span>
<span class="sd">        The `.obs` key with categorical sample information for</span>
<span class="sd">        `basis_adata`. If `None`, `sample_key` is used.</span>
<span class="sd">    fillna</span>
<span class="sd">        If `None`, observation containing NA in the values are filtered.</span>
<span class="sd">        Else, NA values are replaced with this value.</span>
<span class="sd">    restrict_groups</span>
<span class="sd">        A list-like containing the groups within which the enrichment analysis</span>
<span class="sd">        is to be done. If `None`, all groups are included.</span>
<span class="sd">    restrict_values</span>
<span class="sd">        A list-like containing the values within which the enrichment analysis</span>
<span class="sd">        is to be done. If `None`, all values are included. Works only for</span>
<span class="sd">        categorical values.</span>
<span class="sd">    basis_restrict_groups</span>
<span class="sd">        Like `restrict_groups` but for `basis_adata`.</span>
<span class="sd">    basis_restrict_values</span>
<span class="sd">        Like `restrict_values` but for `basis_adata`.</span>
<span class="sd">    reduction</span>
<span class="sd">        The reduction to apply on each (group,sample) subset of the data.</span>
<span class="sd">        Possible values are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;sum&#39;: sum of the values over observations</span>
<span class="sd">        - &#39;mean&#39;: mean of the values over observations</span>
<span class="sd">        - &#39;median&#39;: median of the values over observations</span>
<span class="sd">        - a callable mapping a :class:`~pandas.DataFrame` to its reduced</span>
<span class="sd">          counterpart</span>
<span class="sd">    </span>
<span class="sd">    normalization</span>
<span class="sd">        The normalization to apply on each reduced (group,sample) subset of the</span>
<span class="sd">        data. Possible values are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;sum&#39;: normalize values by their sum (yields fractions)</span>
<span class="sd">        - &#39;percent&#39;: like &#39;sum&#39; scaled by 100 (yields percentages)</span>
<span class="sd">        - &#39;gmean&#39;: normalize values by their geometric mean (yields</span>
<span class="sd">          contributions which make more sense for enrichments than fractions,</span>
<span class="sd">          due to zero-sum issue; see :func:`~tacco.tools.enrichments`)</span>
<span class="sd">        - &#39;clr&#39;: &quot;Center logratio transform&quot;; like &#39;gmean&#39; with additional log</span>
<span class="sd">          transform; makes the distribution more normal and better suited for t</span>
<span class="sd">          tests</span>
<span class="sd">        - `None`: no normalization</span>
<span class="sd">        - a value name from `value_key`: all values are normalized to this</span>
<span class="sd">          contribution</span>
<span class="sd">        - a callable mapping a :class:`~pandas.DataFrame` to its normalized</span>
<span class="sd">          counterpart</span>
<span class="sd">    </span>
<span class="sd">    assume_counts</span>
<span class="sd">        Ony relevant for `normalization==&#39;gmean&#39;` and `normalization==&#39;clr&#39;`;</span>
<span class="sd">        whether to regularize zeros by adding a pseudo count of 1 or by</span>
<span class="sd">        replacing them by 1e-3 of the minimum value. If `None`, check whether</span>
<span class="sd">        the data are consistent with count data and assume counts accordingly,</span>
<span class="sd">        except if `reads==True`, then also `assume_counts==True`.</span>
<span class="sd">    reads</span>
<span class="sd">        Whether to weight the values by the total count per observation</span>
<span class="sd">    colors</span>
<span class="sd">        The mapping of value names to colors. If `None`, a set of</span>
<span class="sd">        standard colors is used.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis. If `None`, use</span>
<span class="sd">        automatic values.</span>
<span class="sd">    log</span>
<span class="sd">        Whether to plot on the log scale.</span>
<span class="sd">    ax</span>
<span class="sd">        The :class:`~matplotlib.axes.Axes` to plot on. If `None`, creates a</span>
<span class="sd">        fresh figure for plotting.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure` if `ax` is `None`, else `None`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">contributions</span><span class="p">,</span> <span class="n">detailed_contributions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_prep_contributions</span><span class="p">(</span>
        <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
        <span class="n">value_key</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span>
        <span class="n">group_key</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span>
        <span class="n">sample_key</span><span class="o">=</span><span class="n">sample_key</span><span class="p">,</span>
        <span class="n">basis_adata</span><span class="o">=</span><span class="n">basis_adata</span><span class="p">,</span>
        <span class="n">basis_value_key</span><span class="o">=</span><span class="n">basis_value_key</span><span class="p">,</span>
        <span class="n">basis_group_key</span><span class="o">=</span><span class="n">basis_group_key</span><span class="p">,</span>
        <span class="n">basis_sample_key</span><span class="o">=</span><span class="n">basis_sample_key</span><span class="p">,</span>
        <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span>
        <span class="n">restrict_groups</span><span class="o">=</span><span class="n">restrict_groups</span><span class="p">,</span>
        <span class="n">restrict_values</span><span class="o">=</span><span class="n">restrict_values</span><span class="p">,</span>
        <span class="n">basis_restrict_groups</span><span class="o">=</span><span class="n">basis_restrict_groups</span><span class="p">,</span>
        <span class="n">basis_restrict_values</span><span class="o">=</span><span class="n">basis_restrict_values</span><span class="p">,</span>
        <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span>
        <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span>
        <span class="n">assume_counts</span><span class="o">=</span><span class="n">assume_counts</span><span class="p">,</span>
        <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span>
        <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">labels</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">total_bars_width</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="n">n_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">bars_separation</span> <span class="o">=</span> <span class="n">total_bars_width</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_states</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">bar_separation</span> <span class="o">=</span> <span class="n">total_bars_width</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_states</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">n_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axsize</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">n_states</span> <span class="o">+</span> <span class="mf">.2</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_axisbelow</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span><span class="c1">#color=&#39;gray&#39;, linestyle=&#39;dashed&#39;)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">detailed_contributions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.5</span>
    
    <span class="n">minor_x_labeling</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;position&#39;</span><span class="p">:[],</span><span class="s1">&#39;label&#39;</span><span class="p">:[]}</span>
    
    <span class="k">for</span> <span class="n">i_state</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i_column</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">bar_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_bars_width</span><span class="o">-</span><span class="n">n_states</span><span class="o">*</span><span class="n">bar_separation</span><span class="p">)</span><span class="o">/</span><span class="n">n_states</span>
            <span class="n">bar_start</span> <span class="o">=</span> <span class="n">i_column</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">total_bars_width</span> <span class="o">+</span> <span class="n">i_state</span> <span class="o">*</span> <span class="n">total_bars_width</span><span class="o">/</span><span class="n">n_states</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">bar_separation</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bar_start</span><span class="p">,</span> <span class="n">contributions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">state</span><span class="p">,</span><span class="n">column</span><span class="p">],</span> <span class="n">bar_width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

            <span class="n">minor_x_labeling</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_column</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">total_bars_width</span> <span class="o">+</span> <span class="p">(</span><span class="n">i_state</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n_states</span><span class="p">)</span> <span class="o">*</span> <span class="n">total_bars_width</span><span class="p">)</span>
            <span class="n">minor_x_labeling</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">detailed_contributions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i_state</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">detailed_contributions</span><span class="p">[</span><span class="n">detailed_contributions</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">state</span><span class="p">]</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i_column</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">heights</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">bar_start</span> <span class="o">=</span> <span class="n">i_column</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">total_bars_width</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">bars_separation</span> <span class="o">+</span> <span class="n">i_state</span><span class="o">/</span><span class="n">n_states</span> <span class="o">*</span> <span class="n">total_bars_width</span>
                <span class="n">bar_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_bars_width</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_states</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">bars_separation</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_states</span> <span class="o">*</span> <span class="n">n_samples</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bar_start</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">n_samples</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">bar_width</span><span class="p">,</span><span class="n">bar_width</span><span class="p">),</span> <span class="n">heights</span><span class="p">,</span> <span class="n">bar_width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span>

    <span class="c1"># Add some text for labels, title and custom x-axis tick labels, etc.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;contribution&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>  <span class="c1"># the label locations</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">minor_x_labeling</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">minor_x_labeling</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
    <span class="n">minor_x_labeling</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1e-2</span> <span class="c1"># tiny shift to make the central minor annotation not be superseded by the major annotation...</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">minor_x_labeling</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span><span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">minor_x_labeling</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(</span><span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">t</span><span class="o">.</span><span class="n">set_y</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="heatmap">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.heatmap.html#tacco.plots.heatmap">[docs]</a>
<span class="k">def</span> <span class="nf">heatmap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">value_key</span><span class="p">,</span>
    <span class="n">group_key</span><span class="p">,</span>
    <span class="n">basis_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_value_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_group_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fillna</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
    <span class="n">normalization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">assume_counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axes_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">value_cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">group_cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">value_dendrogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">group_dendrogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">value_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">group_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">group_labels_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap_center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">complement_colors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">colorbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Plot heatmap of contribution to groups.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` with annotation in `.obs`. Can also be a</span>
<span class="sd">        :class:`~pandas.DataFrame` with the data to show in the heatmap. In the</span>
<span class="sd">        latter case all adata processing arguments are ignored.</span>
<span class="sd">    value_key</span>
<span class="sd">        The `.obs` or `.obsm` key with the values to determine the</span>
<span class="sd">        enrichment for.</span>
<span class="sd">    group_key</span>
<span class="sd">        The `.obs` key with categorical group information.</span>
<span class="sd">    basis_adata</span>
<span class="sd">        Another :class:`~anndata.AnnData` with annotation in `.obs`</span>
<span class="sd">        to compare. If `None`, only the `adata` composition is shown.</span>
<span class="sd">    basis_value_key</span>
<span class="sd">        The `.obs` or `.obsm` key for `basis_adata` with the values</span>
<span class="sd">        to determine the enrichment for. If `None`, `value_key` is used.</span>
<span class="sd">    basis_group_key</span>
<span class="sd">        The `.obs` key with categorical group information for</span>
<span class="sd">        `basis_adata`. If `None`, `value_key` is used.</span>
<span class="sd">    fillna</span>
<span class="sd">        If `None`, observation containing NA in the values are filtered.</span>
<span class="sd">        Else, NA values are replaced with this value.</span>
<span class="sd">    restrict_groups</span>
<span class="sd">        A list-like containing the groups within which the enrichment analysis</span>
<span class="sd">        is to be done. If `None`, all groups are included.</span>
<span class="sd">    restrict_values</span>
<span class="sd">        A list-like containing the values within which the enrichment analysis</span>
<span class="sd">        is to be done. If `None`, all values are included. Works only for</span>
<span class="sd">        categorical values.</span>
<span class="sd">    basis_restrict_groups</span>
<span class="sd">        Like `restrict_groups` but for `basis_adata`.</span>
<span class="sd">    basis_restrict_values</span>
<span class="sd">        Like `restrict_values` but for `basis_adata`.</span>
<span class="sd">    reduction</span>
<span class="sd">        The reduction to apply on each (group,sample) subset of the data.</span>
<span class="sd">        Possible values are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;sum&#39;: sum of the values over observations</span>
<span class="sd">        - &#39;mean&#39;: mean of the values over observations</span>
<span class="sd">        - &#39;median&#39;: median of the values over observations</span>
<span class="sd">        - a callable mapping a :class:`~pandas.DataFrame` to its reduced</span>
<span class="sd">          counterpart</span>
<span class="sd">    </span>
<span class="sd">    normalization</span>
<span class="sd">        The normalization to apply on each reduced (group,sample) subset of the</span>
<span class="sd">        data. Possible values are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;sum&#39;: normalize values by their sum (yields fractions)</span>
<span class="sd">        - &#39;percent&#39;: like &#39;sum&#39; scaled by 100 (yields percentages)</span>
<span class="sd">        - &#39;gmean&#39;: normalize values by their geometric mean (yields</span>
<span class="sd">          contributions which make more sense for enrichments than fractions,</span>
<span class="sd">          due to zero-sum issue; see :func:`~tacco.tools.enrichments`)</span>
<span class="sd">        - &#39;clr&#39;: &quot;Center logratio transform&quot;; like &#39;gmean&#39; with additional log</span>
<span class="sd">          transform; makes the distribution more normal and better suited for t</span>
<span class="sd">          tests</span>
<span class="sd">        - `None`: no normalization</span>
<span class="sd">        - a value name from `value_key`: all values are normalized to this</span>
<span class="sd">          contribution</span>
<span class="sd">        - a callable mapping a :class:`~pandas.DataFrame` to its normalized</span>
<span class="sd">          counterpart</span>
<span class="sd">    </span>
<span class="sd">    assume_counts</span>
<span class="sd">        Ony relevant for `normalization==&#39;gmean&#39;` and `normalization==&#39;clr&#39;`;</span>
<span class="sd">        whether to regularize zeros by adding a pseudo count of 1 or by</span>
<span class="sd">        replacing them by 1e-3 of the minimum value. If `None`, check whether</span>
<span class="sd">        the data are consistent with count data and assume counts accordingly,</span>
<span class="sd">        except if `reads==True`, then also `assume_counts==True`.</span>
<span class="sd">    reads</span>
<span class="sd">        Whether to weight the values by the total count per observation</span>
<span class="sd">    colors</span>
<span class="sd">        The mapping of value names to colors. If `None`, a set of</span>
<span class="sd">        standard colors is used.</span>
<span class="sd">    alpha</span>
<span class="sd">        A value-group-dataframe specifying a separate alpha value for all cells</span>
<span class="sd">        in the histogram. If `None`, no transparency is used.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis. If `None`, use</span>
<span class="sd">        automatic values.</span>
<span class="sd">    axes_labels</span>
<span class="sd">        Labels to write on the axes as an list-like of the two labels.</span>
<span class="sd">    annotation</span>
<span class="sd">        A :class:`~pandas.DataFrame` containing annotation for each heatmap</span>
<span class="sd">        cell. If &quot;value&quot;, annotate by the values. If `None`, don&#39;t annotate.</span>
<span class="sd">        If a tuple of &quot;value&quot; and a :class:`~pandas.DataFrame`, append the</span>
<span class="sd">        annotation from the dataframe to the values.</span>
<span class="sd">    value_cluster</span>
<span class="sd">        Whether to cluster and reorder the values.</span>
<span class="sd">    group_cluster</span>
<span class="sd">        Whether to cluster and reorder the groups.</span>
<span class="sd">    value_dendrogram</span>
<span class="sd">        Whether to draw a dendrogram for the values. If `True`, this implies</span>
<span class="sd">        `value_cluster=True`.</span>
<span class="sd">    group_dendrogram</span>
<span class="sd">        Whether to draw a dendrogram for the groups. If `True`, this implies</span>
<span class="sd">        `group_cluster=True`.</span>
<span class="sd">    value_order</span>
<span class="sd">        Set the order of the values explicitly with a list or to be close to</span>
<span class="sd">        diagonal by specifying &quot;diag&quot;; this option is incompatible with</span>
<span class="sd">        `value_cluster` and `value_dendrogram`.</span>
<span class="sd">    group_order</span>
<span class="sd">        Set the order of the groups explicitly with a list or to be close to</span>
<span class="sd">        diagonal by specifying &quot;diag&quot;; this option is incompatible with</span>
<span class="sd">        `group_cluster` and `group_dendrogram`.</span>
<span class="sd">    group_labels_rotation</span>
<span class="sd">        Adjusts the rotation of the group labels in degree.</span>
<span class="sd">    ax</span>
<span class="sd">        The :class:`~matplotlib.axes.Axes` to plot on. If `None`, creates a</span>
<span class="sd">        fresh figure for plotting. Incompatible with dendrogram plotting.</span>
<span class="sd">    cmap</span>
<span class="sd">        A string/colormap to override the `colors` with.</span>
<span class="sd">    cmap_center</span>
<span class="sd">        A value to use as center of the colormap. E.g. choosing `0` sets the</span>
<span class="sd">        central color to `0` for every colormap in the plot (i.e. `0` will get</span>
<span class="sd">        white, positive and negative colors the color and complement color</span>
<span class="sd">        given by `colors` for `cmap` is `None`, and whatever the central color</span>
<span class="sd">        of the supplied colormap is if `cmap` is not `None`). If `None`, the</span>
<span class="sd">        colormap spans the entire value range.</span>
<span class="sd">    cmap_vmin_vmax</span>
<span class="sd">        A tuple giving the range of values for the colormap. This can be</span>
<span class="sd">        modfied by `cmap_center`.</span>
<span class="sd">    complement_colors</span>
<span class="sd">        Whether to use complement colors for values below `cmap_center` if</span>
<span class="sd">        `cmap==None`.</span>
<span class="sd">    colorbar</span>
<span class="sd">        Whether to draw a colorbar; only available if `cmap` is not `None`.</span>
<span class="sd">    colorbar_label</span>
<span class="sd">        The label to use for the colorbar; only available if `colorbar` is</span>
<span class="sd">        `True`.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure` if `ax` is `None`, else `None`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">contributions</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">contributions</span><span class="p">,</span> <span class="n">detailed_contributions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_prep_contributions</span><span class="p">(</span>
            <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
            <span class="n">value_key</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span>
            <span class="n">group_key</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span>
            <span class="n">sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">basis_adata</span><span class="o">=</span><span class="n">basis_adata</span><span class="p">,</span>
            <span class="n">basis_value_key</span><span class="o">=</span><span class="n">basis_value_key</span><span class="p">,</span>
            <span class="n">basis_group_key</span><span class="o">=</span><span class="n">basis_group_key</span><span class="p">,</span>
            <span class="n">basis_sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span>
            <span class="n">restrict_groups</span><span class="o">=</span><span class="n">restrict_groups</span><span class="p">,</span>
            <span class="n">restrict_values</span><span class="o">=</span><span class="n">restrict_values</span><span class="p">,</span>
            <span class="n">basis_restrict_groups</span><span class="o">=</span><span class="n">basis_restrict_groups</span><span class="p">,</span>
            <span class="n">basis_restrict_values</span><span class="o">=</span><span class="n">basis_restrict_values</span><span class="p">,</span>
            <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span>
            <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span>
            <span class="n">assume_counts</span><span class="o">=</span><span class="n">assume_counts</span><span class="p">,</span>
            <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span>
            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
        <span class="p">)</span>
    
    <span class="n">value_cluster</span> <span class="o">=</span> <span class="n">value_cluster</span> <span class="ow">or</span> <span class="n">value_dendrogram</span>
    <span class="n">group_cluster</span> <span class="o">=</span> <span class="n">group_cluster</span> <span class="ow">or</span> <span class="n">group_dendrogram</span>
    
    <span class="k">if</span> <span class="n">value_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value_cluster</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The options `value_cluster` and `value_dendrogram` are incompatible with the option `value_order`.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">group_cluster</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The options `group_cluster` and `group_dendrogram` are incompatible with the option `group_order`.&#39;</span><span class="p">)</span>
    <span class="n">group_order_diag</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_order</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">group_order</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span>
    <span class="n">value_order_diag</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_order</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value_order</span> <span class="o">==</span> <span class="s1">&#39;diag&#39;</span>
    <span class="k">if</span> <span class="n">group_order_diag</span> <span class="ow">and</span> <span class="n">value_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value_order_diag</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The option `group_order==&quot;diag&quot;` is incompatible with non-´None´ or &quot;diag&quot; values for `value_order`.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value_order_diag</span> <span class="ow">and</span> <span class="n">group_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">group_order</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The option `value_order==&quot;diag&quot;` is incompatible with non-´None´ or &quot;diag&quot; values for `group_order`.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group_order_diag</span> <span class="ow">and</span> <span class="n">group_cluster</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The option `group_order==&quot;diag&quot;` is incompatible with the options `value_cluster` and `value_dendrogram`.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value_order_diag</span> <span class="ow">and</span> <span class="n">value_cluster</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The option `value_order==&quot;diag&quot;` is incompatible with the options `group_cluster` and `group_dendrogram`.&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value_dendrogram</span> <span class="ow">or</span> <span class="n">group_dendrogram</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The options `value_dendrogram` and `group_dendrogram` are incompatible with the option `ax`.&#39;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_ax_x</span><span class="p">,</span> <span class="n">n_ax_y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">value_dendrogram</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">group_dendrogram</span>
        <span class="k">if</span> <span class="n">axsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_per_value</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="n">x_per_group</span> <span class="o">=</span> <span class="n">y_per_value</span> <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.7</span>
            <span class="n">plot_size_y</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_per_value</span>
            <span class="n">plot_size_x</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_per_group</span>
            <span class="n">axsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">plot_size_x</span><span class="p">,</span><span class="n">plot_size_y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_size_x</span><span class="p">,</span><span class="n">plot_size_y</span> <span class="o">=</span> <span class="n">axsize</span>
        <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot_size_x</span><span class="p">,</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">if</span> <span class="n">value_dendrogram</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">height_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">plot_size_y</span><span class="p">]</span> <span class="k">if</span> <span class="n">group_dendrogram</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">n_ax_x</span><span class="p">,</span> <span class="n">n_ax_y</span><span class="p">,</span> <span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="n">height_ratios</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">group_labels_rotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_labels_rotation</span> <span class="o">=</span> <span class="mi">45</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group_labels_rotation</span> <span class="o">=</span> <span class="mi">30</span>
    
    <span class="k">if</span> <span class="n">value_cluster</span><span class="p">:</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">linkage</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">value_dendrogram</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">color_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">above_threshold_color</span><span class="o">=</span><span class="s1">&#39;tab:gray&#39;</span><span class="p">,</span> <span class="n">no_plot</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">value_dendrogram</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value_dendrogram</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        
        <span class="n">reordering</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dn</span><span class="p">[</span><span class="s1">&#39;ivl&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">contributions</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">reordering</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">group_cluster</span><span class="p">:</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">linkage</span><span class="p">(</span><span class="n">contributions</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">group_dendrogram</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">color_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">above_threshold_color</span><span class="o">=</span><span class="s1">&#39;tab:gray&#39;</span><span class="p">,</span> <span class="n">no_plot</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">group_dendrogram</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">group_dendrogram</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        
        <span class="n">reordering</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dn</span><span class="p">[</span><span class="s1">&#39;ivl&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">contributions</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">reordering</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">value_dendrogram</span> <span class="ow">and</span> <span class="n">group_dendrogram</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_order</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value_order</span>  <span class="o">==</span> <span class="s1">&#39;diag&#39;</span><span class="p">:</span>
        <span class="c1"># permute towards diagonal</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">contributions</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
            <span class="n">contributions</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">contributions</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">value_order</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">contributions</span> <span class="o">=</span> <span class="n">contributions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group_order</span><span class="p">]</span>
    
    <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">s</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">contributions</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">_x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">_y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">_y</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">_vmin_vmax</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cmap_vmin_vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">cmap_vmin_vmax</span>
        <span class="k">if</span> <span class="n">cmap_center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">delta_max</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">-</span> <span class="n">cmap_center</span>
            <span class="n">delta_min</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">vmin</span> <span class="o">-</span> <span class="n">cmap_center</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">delta_max</span><span class="p">,</span> <span class="n">delta_min</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">cmap_center</span> <span class="o">+</span> <span class="n">delta</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">cmap_center</span> <span class="o">-</span> <span class="n">delta</span>
        <span class="k">return</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span>
    
    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rgba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="o">*</span><span class="n">contributions</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

            <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">to_rgb</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
            <span class="n">_r</span><span class="p">,</span> <span class="n">_g</span><span class="p">,</span> <span class="n">_b</span> <span class="o">=</span> <span class="n">_complement_color</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="c1"># complement colors for negative values</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">_vmin_vmax</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">contributions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">complement_colors</span><span class="p">:</span>
                <span class="n">cmap_j</span><span class="o">=</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,(</span><span class="n">_r</span><span class="p">,</span> <span class="n">_g</span><span class="p">,</span> <span class="n">_b</span><span class="p">)),(</span><span class="mf">0.5</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),(</span><span class="mi">1</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">))])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmap_j</span><span class="o">=</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),(</span><span class="mi">1</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">))])</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_j</span><span class="p">)</span>
            <span class="n">rgba</span><span class="p">[:,</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">_vmin_vmax</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">contributions</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">rgba</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
            <span class="n">height_pxl</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="n">width_pxl</span> <span class="o">=</span> <span class="mi">15</span>
            <span class="n">offset_top_pxl</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">offset_left_pxl</span> <span class="o">=</span> <span class="mi">20</span>

            <span class="n">left</span><span class="p">,</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">offset_left_pxl</span><span class="p">,</span><span class="o">-</span><span class="n">offset_top_pxl</span><span class="o">-</span><span class="n">height_pxl</span><span class="p">]))</span>
            <span class="n">width</span><span class="p">,</span><span class="n">height</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">width_pxl</span><span class="p">,</span><span class="n">height_pxl</span><span class="p">]))</span>
            <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">colorbar_label</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">contributions</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">rgba</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">rgba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">annotation</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span>
                        <span class="n">ann</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">contributions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">col</span><span class="p">]</span><span class="si">:</span><span class="s1">.2</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`annotation` got unknown string argument &quot;</span><span class="si">{</span><span class="n">annotation</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">annotation</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">annotation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">col</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="c1">#np.nan</span>
                        <span class="n">ann</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">contributions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">col</span><span class="p">]</span><span class="si">:</span><span class="s1">.2</span><span class="si">}{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`annotation` got a tuple argument where the first entry is not &quot;value&quot;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ann</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">col</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">group_labels_rotation</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;right&#39;</span> <span class="k">if</span> <span class="n">group_labels_rotation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;center&#39;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="n">_set_axes_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axes_labels</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="k">def</span> <span class="nf">_asterisks_from_pvals</span><span class="p">(</span><span class="n">pvals</span><span class="p">):</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">pvals</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">anstr</span> <span class="o">=</span> <span class="n">pvals</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">anstr</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">anstr</span><span class="p">[(</span><span class="n">pvals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.05</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;$^{</span><span class="se">\\</span><span class="s1">ast}$&#39;</span>
    <span class="n">anstr</span><span class="p">[(</span><span class="n">pvals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;${^{</span><span class="se">\\</span><span class="s1">ast}}{^{</span><span class="se">\\</span><span class="s1">ast}}$&#39;</span>
    <span class="n">anstr</span><span class="p">[(</span><span class="n">pvals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.001</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;${^{</span><span class="se">\\</span><span class="s1">ast}}{^{</span><span class="se">\\</span><span class="s1">ast}}{^{</span><span class="se">\\</span><span class="s1">ast}}$&#39;</span>
    <span class="n">anstr</span><span class="p">[(</span><span class="n">pvals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.05</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;$_{</span><span class="se">\\</span><span class="s1">ast}$&#39;</span>
    <span class="n">anstr</span><span class="p">[(</span><span class="n">pvals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;${_{</span><span class="se">\\</span><span class="s1">ast}}{_{</span><span class="se">\\</span><span class="s1">ast}}$&#39;</span>
    <span class="n">anstr</span><span class="p">[(</span><span class="n">pvals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.001</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;${_{</span><span class="se">\\</span><span class="s1">ast}}{_{</span><span class="se">\\</span><span class="s1">ast}}{_{</span><span class="se">\\</span><span class="s1">ast}}$&#39;</span>
    <span class="k">return</span> <span class="n">anstr</span>

<div class="viewcode-block" id="sigmap">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.sigmap.html#tacco.plots.sigmap">[docs]</a>
<span class="k">def</span> <span class="nf">sigmap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">value_key</span><span class="p">,</span>
    <span class="n">group_key</span><span class="p">,</span>
    <span class="n">sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">position_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">position_split</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">min_obs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">basis_adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_value_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_group_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_sample_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_position_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_position_split</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_min_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fillna</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">basis_restrict_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">p_corr</span><span class="o">=</span><span class="s1">&#39;fdr_bh&#39;</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;mwu&#39;</span><span class="p">,</span>
    <span class="n">reduction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">normalization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">assume_counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">value_dendrogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">group_dendrogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">value_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">group_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Plot heatmap of contribution to groups and mark significant differences</span>
<span class="sd">    with asterisks.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` with annotation in `.obs`.</span>
<span class="sd">    value_key</span>
<span class="sd">        The `.obs` or `.obsm` key with the values to determine the</span>
<span class="sd">        enrichment for.</span>
<span class="sd">    group_key</span>
<span class="sd">        The `.obs` key with categorical group information.</span>
<span class="sd">    sample_key</span>
<span class="sd">        The `.obs` key with categorical sample information for p-value</span>
<span class="sd">        determination. If `None`, use only the aggregated data is plotted.</span>
<span class="sd">    position_key</span>
<span class="sd">        The `.obsm` key or array-like of `.obs` keys with the position space</span>
<span class="sd">        coordinates. If `None`, no position splits are performed.</span>
<span class="sd">    position_split</span>
<span class="sd">        The number of splits per spatial dimension before enrichment. Can be a</span>
<span class="sd">        tuple with the spatial dimension as length to assign a different split</span>
<span class="sd">        per dimension. If `None`, no position splits are performed. See also</span>
<span class="sd">        `min_obs`.</span>
<span class="sd">    min_obs</span>
<span class="sd">        The minimum number of observations per sample: if less observations are</span>
<span class="sd">        available, the sample is not used. This also limits the number of</span>
<span class="sd">        `position_split` to stop splitting if the split would decrease the</span>
<span class="sd">        number of observations below this threshold.</span>
<span class="sd">    basis_adata</span>
<span class="sd">        Another :class:`~anndata.AnnData` with annotation in `.obs`</span>
<span class="sd">        to compare. If `None`, only the `adata` composition is shown.</span>
<span class="sd">    basis_value_key</span>
<span class="sd">        The `.obs` or `.obsm` key for `basis_adata` with the values</span>
<span class="sd">        to determine the enrichment for. If `None`, `value_key` is used.</span>
<span class="sd">    basis_group_key</span>
<span class="sd">        The `.obs` key with categorical group information for</span>
<span class="sd">        `basis_adata`. If `None`, `value_key` is used.</span>
<span class="sd">    basis_sample_key</span>
<span class="sd">        The `.obs` key with categorical sample information for</span>
<span class="sd">        `basis_adata`. If `None`, `sample_key` is used.</span>
<span class="sd">    basis_position_key</span>
<span class="sd">        Like `position_key` but for `basis_adata`. If `None`, no position</span>
<span class="sd">        splits are performed.</span>
<span class="sd">    basis_position_split</span>
<span class="sd">        Like `position_split` but for `basis_adata`. If `None`,</span>
<span class="sd">        `position_split` is used.</span>
<span class="sd">    basis_min_obs</span>
<span class="sd">        Like `min_obs` but for `basis_adata`. If `None`, `min_obs` is used.</span>
<span class="sd">    fillna</span>
<span class="sd">        If `None`, observation containing NA in the values are filtered.</span>
<span class="sd">        Else, NA values are replaced with this value.</span>
<span class="sd">    restrict_groups</span>
<span class="sd">        A list-like containing the groups within which the enrichment analysis</span>
<span class="sd">        is to be done. If `None`, all groups are included.</span>
<span class="sd">    restrict_values</span>
<span class="sd">        A list-like containing the values within which the enrichment analysis</span>
<span class="sd">        is to be done. If `None`, all values are included. Works only for</span>
<span class="sd">        categorical values.</span>
<span class="sd">    basis_restrict_groups</span>
<span class="sd">        Like `restrict_groups` but for `basis_adata`.</span>
<span class="sd">    basis_restrict_values</span>
<span class="sd">        Like `restrict_values` but for `basis_adata`.</span>
<span class="sd">    p_corr</span>
<span class="sd">        The name of the p-value correction method to use. Possible values are</span>
<span class="sd">        the ones available in</span>
<span class="sd">        :func:`~statsmodels.stats.multitest.multipletests`. If `None`, no</span>
<span class="sd">        p-value correction is performed.</span>
<span class="sd">    method</span>
<span class="sd">        Specification of methods to use for enrichment. Available are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;fisher&#39;: Fishers exact test; only for categorical values. Ignores</span>
<span class="sd">          the `reduction` and `normalization` arguments.</span>
<span class="sd">        - &#39;mwu&#39;: MannWhitneyU test</span>
<span class="sd">        </span>
<span class="sd">    reduction</span>
<span class="sd">        The reduction to apply on each (group,sample) subset of the data.</span>
<span class="sd">        Possible values are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;sum&#39;: sum of the values over observations</span>
<span class="sd">        - &#39;mean&#39;: mean of the values over observations</span>
<span class="sd">        - &#39;median&#39;: median of the values over observations</span>
<span class="sd">        - `None`: use observations directly</span>
<span class="sd">        - a callable mapping a :class:`~pandas.DataFrame` to its reduced</span>
<span class="sd">          counterpart</span>
<span class="sd">    </span>
<span class="sd">    normalization</span>
<span class="sd">        The normalization to apply on each reduced (group,sample) subset of the</span>
<span class="sd">        data. Possible values are:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;sum&#39;: normalize values by their sum (yields fractions)</span>
<span class="sd">        - &#39;percent&#39;: like &#39;sum&#39; scaled by 100 (yields percentages)</span>
<span class="sd">        - &#39;gmean&#39;: normalize values by their geometric mean (yields</span>
<span class="sd">          contributions which make more sense for enrichments than fractions,</span>
<span class="sd">          due to zero-sum issue; see :func:`~tacco.tools.enrichments`)</span>
<span class="sd">        - &#39;clr&#39;: &quot;Center logratio transform&quot;; like &#39;gmean&#39; with additional log</span>
<span class="sd">          transform; makes the distribution more normal and better suited for t</span>
<span class="sd">          tests</span>
<span class="sd">        - `None`: no normalization</span>
<span class="sd">        - a value name from `value_key`: all values are normalized to this</span>
<span class="sd">          contribution</span>
<span class="sd">        - a callable mapping a :class:`~pandas.DataFrame` to its normalized</span>
<span class="sd">          counterpart</span>
<span class="sd">    </span>
<span class="sd">    assume_counts</span>
<span class="sd">        Ony relevant for `normalization==&#39;gmean&#39;` and `normalization==&#39;clr&#39;`;</span>
<span class="sd">        whether to regularize zeros by adding a pseudo count of 1 or by</span>
<span class="sd">        replacing them by 1e-3 of the minimum value. If `None`, check whether</span>
<span class="sd">        the data are consistent with count data and assume counts accordingly,</span>
<span class="sd">        except if `reads==True`, then also `assume_counts==True`.</span>
<span class="sd">    reads</span>
<span class="sd">        Whether to weight the values by the total count per observation</span>
<span class="sd">    colors</span>
<span class="sd">        The mapping of value names to colors. If `None`, a set of standard</span>
<span class="sd">        colors is used.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis. If `None`, use automatic</span>
<span class="sd">        values.</span>
<span class="sd">    value_dendrogram</span>
<span class="sd">        Whether to draw a dendrogram for the values</span>
<span class="sd">    group_dendrogram</span>
<span class="sd">        Whether to draw a dendrogram for the groups</span>
<span class="sd">    value_order</span>
<span class="sd">        Set the order of the values explicitly; this option is incompatible</span>
<span class="sd">        with `value_dendrogram`.</span>
<span class="sd">    group_order</span>
<span class="sd">        Set the order of the groups explicitly; this option is incompatible</span>
<span class="sd">        with `group_dendrogram`.</span>
<span class="sd">    ax</span>
<span class="sd">        The :class:`~matplotlib.axes.Axes` to plot on. If `None`, creates a</span>
<span class="sd">        fresh figure for plotting. Incompatible with dendrogram plotting.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure` if `ax` is `None`, else `None`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">enrichments</span><span class="p">(</span>
        <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span><span class="n">value_key</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span><span class="n">group_key</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span><span class="n">sample_key</span><span class="o">=</span><span class="n">sample_key</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span><span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span>
        <span class="n">position_key</span><span class="o">=</span><span class="n">position_key</span><span class="p">,</span> <span class="n">position_split</span><span class="o">=</span><span class="n">position_split</span><span class="p">,</span><span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs</span><span class="p">,</span><span class="n">p_corr</span><span class="o">=</span><span class="n">p_corr</span><span class="p">,</span>
        <span class="n">restrict_groups</span><span class="o">=</span><span class="n">restrict_groups</span><span class="p">,</span><span class="n">restrict_values</span><span class="o">=</span><span class="n">restrict_values</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span>
        <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span><span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span><span class="n">assume_counts</span><span class="o">=</span><span class="n">assume_counts</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">basis_adata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">basis_position_split</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_position_split</span> <span class="o">=</span> <span class="n">position_split</span>
        <span class="k">if</span> <span class="n">basis_min_obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_min_obs</span> <span class="o">=</span> <span class="n">min_obs</span>
        <span class="k">if</span> <span class="n">basis_sample_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_sample_key</span> <span class="o">=</span> <span class="n">sample_key</span>
        <span class="k">if</span> <span class="n">basis_group_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_group_key</span> <span class="o">=</span> <span class="n">group_key</span>
        <span class="k">if</span> <span class="n">basis_value_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_value_key</span> <span class="o">=</span> <span class="n">value_key</span>
        <span class="n">basis_pvals</span> <span class="o">=</span> <span class="n">enrichments</span><span class="p">(</span>
            <span class="n">adata</span><span class="o">=</span><span class="n">basis_adata</span><span class="p">,</span><span class="n">value_key</span><span class="o">=</span><span class="n">basis_value_key</span><span class="p">,</span><span class="n">group_key</span><span class="o">=</span><span class="n">basis_group_key</span><span class="p">,</span><span class="n">sample_key</span><span class="o">=</span><span class="n">basis_sample_key</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span><span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span>
            <span class="n">position_key</span><span class="o">=</span><span class="n">basis_position_key</span><span class="p">,</span> <span class="n">position_split</span><span class="o">=</span><span class="n">basis_position_split</span><span class="p">,</span><span class="n">min_obs</span><span class="o">=</span><span class="n">basis_min_obs</span><span class="p">,</span><span class="n">p_corr</span><span class="o">=</span><span class="n">p_corr</span><span class="p">,</span>
            <span class="n">restrict_groups</span><span class="o">=</span><span class="n">basis_restrict_groups</span><span class="p">,</span><span class="n">restrict_values</span><span class="o">=</span><span class="n">basis_restrict_values</span><span class="p">,</span> <span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span>
            <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span><span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span><span class="n">assume_counts</span><span class="o">=</span><span class="n">assume_counts</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">basis_pvals</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">basis_value_key</span><span class="p">:</span><span class="n">value_key</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">basis_pvals</span><span class="p">[</span><span class="n">basis_group_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis_pvals</span><span class="p">[</span><span class="n">basis_group_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">rename_categories</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39; (reference)&#39;</span><span class="p">)</span>
        <span class="n">basis_pvals</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">basis_group_key</span><span class="p">:</span><span class="n">group_key</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">joint_categories</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">basis_pvals</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">),</span> <span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">pvals</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)]</span>
        <span class="n">pvals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">basis_pvals</span><span class="p">,</span><span class="n">pvals</span><span class="p">])</span>
        <span class="n">pvals</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvals</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">(</span><span class="n">joint_categories</span><span class="p">,</span><span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="n">ann</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">pvals</span><span class="p">[</span><span class="n">pvals</span><span class="p">[</span><span class="s1">&#39;enrichment&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;enriched&#39;</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;p_</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">p_corr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">value_key</span><span class="p">)</span>
    <span class="n">annp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">pvals</span><span class="p">[</span><span class="n">pvals</span><span class="p">[</span><span class="s1">&#39;enrichment&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;enriched&#39;</span><span class="p">],</span><span class="n">values</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;p_</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">p_corr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">value_key</span><span class="p">)</span>
    <span class="n">ann</span><span class="p">[</span><span class="n">annp</span><span class="o">&lt;</span><span class="n">ann</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">annp</span>
    <span class="n">anstr</span> <span class="o">=</span> <span class="n">_asterisks_from_pvals</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span>
        <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span><span class="n">value_key</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span><span class="n">group_key</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span>
        <span class="n">basis_adata</span><span class="o">=</span><span class="n">basis_adata</span><span class="p">,</span><span class="n">basis_value_key</span><span class="o">=</span><span class="n">basis_value_key</span><span class="p">,</span><span class="n">basis_group_key</span><span class="o">=</span><span class="n">basis_group_key</span><span class="p">,</span>
        <span class="n">fillna</span><span class="o">=</span><span class="n">fillna</span><span class="p">,</span><span class="n">restrict_groups</span><span class="o">=</span><span class="n">restrict_groups</span><span class="p">,</span><span class="n">restrict_values</span><span class="o">=</span><span class="n">restrict_values</span><span class="p">,</span>
        <span class="n">basis_restrict_groups</span><span class="o">=</span><span class="n">basis_restrict_groups</span><span class="p">,</span><span class="n">basis_restrict_values</span><span class="o">=</span><span class="n">basis_restrict_values</span><span class="p">,</span>
        <span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span><span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span><span class="n">reads</span><span class="o">=</span><span class="n">reads</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span><span class="n">annotation</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="n">anstr</span><span class="p">),</span>
        <span class="n">value_dendrogram</span><span class="o">=</span><span class="n">value_dendrogram</span><span class="p">,</span> <span class="n">group_dendrogram</span><span class="o">=</span><span class="n">group_dendrogram</span><span class="p">,</span><span class="n">assume_counts</span><span class="o">=</span><span class="n">assume_counts</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">complement_colors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap_center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">value_order</span><span class="o">=</span><span class="n">value_order</span><span class="p">,</span><span class="n">group_order</span><span class="o">=</span><span class="n">group_order</span><span class="p">,</span>
    <span class="p">);</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="significances">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.significances.html#tacco.plots.significances">[docs]</a>
<span class="k">def</span> <span class="nf">significances</span><span class="p">(</span>
    <span class="n">significances</span><span class="p">,</span>
    <span class="n">p_key</span><span class="p">,</span>
    <span class="n">value_key</span><span class="p">,</span>
    <span class="n">group_key</span><span class="p">,</span>
    <span class="n">enrichment_key</span><span class="o">=</span><span class="s1">&#39;enrichment&#39;</span><span class="p">,</span>
    <span class="n">enriched_label</span><span class="o">=</span><span class="s1">&#39;enriched&#39;</span><span class="p">,</span>
    <span class="n">pmax</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">pmin</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
    <span class="n">annotate_pvalues</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">value_cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">group_cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">value_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">group_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scale_legend</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Plot enrichment significances.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    significances</span>
<span class="sd">        A :class:`~pandas.DataFrame` with p-values and their annotation. If it</span>
<span class="sd">        contains significances for enrichment and depletion, this direction has</span>
<span class="sd">        to be specified with values &quot;enriched&quot; and something else (e.g.</span>
<span class="sd">        &quot;depleted&quot; or &quot;purified&quot;) in a column &quot;enrichment&quot; of the DataFrame.</span>
<span class="sd">        See also the parameters `enrichment_key` and `enrichment_label`.</span>
<span class="sd">    p_key</span>
<span class="sd">        The key with the p-values.</span>
<span class="sd">    value_key</span>
<span class="sd">        The key with the values for which the enrichment was determined.</span>
<span class="sd">    group_key</span>
<span class="sd">        The key with the groups in which the enrichment was determined.</span>
<span class="sd">    enrichment_key</span>
<span class="sd">        The key with the direction of enrichment, i.e something like &quot;enriched&quot;</span>
<span class="sd">        and &quot;purified&quot;. See also parameter `enriched_label`. Default:</span>
<span class="sd">        &quot;enrichment&quot;.</span>
<span class="sd">    enriched_label</span>
<span class="sd">        The value under the key `enrichment_key` which indicates something like</span>
<span class="sd">        enrichment. Default: &quot;enriched&quot;.</span>
<span class="sd">    pmax</span>
<span class="sd">        The maximum p-value to show.</span>
<span class="sd">    pmin</span>
<span class="sd">        The minimum p-value on the color scale.</span>
<span class="sd">    annotate_pvalues</span>
<span class="sd">        Whether to annotate p-values</span>
<span class="sd">    value_cluster</span>
<span class="sd">        Whether to cluster and reorder the values.</span>
<span class="sd">    group_cluster</span>
<span class="sd">        Whether to cluster and reorder the groups.</span>
<span class="sd">    value_order</span>
<span class="sd">        Set the order of the values explicitly with a list or to be close to</span>
<span class="sd">        diagonal by specifying &quot;diag&quot;; this option is incompatible with</span>
<span class="sd">        `value_cluster`.</span>
<span class="sd">    group_order</span>
<span class="sd">        Set the order of the groups explicitly with a list or to be close to</span>
<span class="sd">        diagonal by specifying &quot;diag&quot;; this option is incompatible with</span>
<span class="sd">        `group_cluster`.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis. If `None`, use</span>
<span class="sd">        automatic values.</span>
<span class="sd">    ax</span>
<span class="sd">        The :class:`~matplotlib.axes.Axes` to plot on. If `None`, creates a</span>
<span class="sd">        fresh figure for plotting. Incompatible with dendrogram plotting.</span>
<span class="sd">    scale_legend</span>
<span class="sd">        Set to scale height and width of legend.  </span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">small_value</span> <span class="o">=</span> <span class="mf">1e-300</span>
    <span class="n">max_log</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pmin</span><span class="p">)</span>
    <span class="n">min_log</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pmax</span><span class="p">)</span>
    
    <span class="n">depleted_label</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">enrichment_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">enrichment_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">significances</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The column &quot;</span><span class="si">{</span><span class="n">enrichment_key</span><span class="si">}</span><span class="s1">&quot; does not exist in the supplied dataframe! If this is intentional and you want to supress this error, supply &quot;enrichment_key=None&quot; as argument.&#39;</span><span class="p">)</span>
        <span class="n">unique_significance_labels</span> <span class="o">=</span> <span class="n">significances</span><span class="p">[</span><span class="n">enrichment_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_significance_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">enriched_label</span> <span class="o">=</span> <span class="n">unique_significance_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_significance_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">enriched_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_significance_labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The column &quot;</span><span class="si">{</span><span class="n">enrichment_key</span><span class="si">}</span><span class="s1">&quot; is expected to have exactly 2 different values: &quot;</span><span class="si">{</span><span class="n">enriched_label</span><span class="si">}</span><span class="s1">&quot; and something else, e.g. &quot;depleted&quot; or &quot;purified&quot;! The supplied column has the values </span><span class="si">{</span><span class="n">significances</span><span class="p">[</span><span class="n">enrichment_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
            <span class="n">depleted_label</span> <span class="o">=</span> <span class="n">unique_significance_labels</span><span class="p">[</span><span class="n">unique_significance_labels</span><span class="o">!=</span><span class="n">enriched_label</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">depleted_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">enr_e</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">significances</span><span class="p">[</span><span class="n">significances</span><span class="p">[</span><span class="n">enrichment_key</span><span class="p">]</span><span class="o">==</span><span class="n">enriched_label</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">p_key</span><span class="p">)</span>
        <span class="n">enr_p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">significances</span><span class="p">[</span><span class="n">significances</span><span class="p">[</span><span class="n">enrichment_key</span><span class="p">]</span><span class="o">==</span><span class="n">depleted_label</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">p_key</span><span class="p">)</span>

        <span class="n">enr_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">enr_e</span><span class="p">,</span><span class="n">small_value</span><span class="p">)</span>
        <span class="n">enr_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">enr_p</span><span class="p">,</span><span class="n">small_value</span><span class="p">)</span>

        <span class="n">enr_p</span> <span class="o">=</span> <span class="n">enr_p</span><span class="o">.</span><span class="n">reindex_like</span><span class="p">(</span><span class="n">enr_e</span><span class="p">)</span>

        <span class="n">enr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">enr_e</span> <span class="o">&lt;</span> <span class="n">enr_p</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">enr_e</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">enr_p</span><span class="p">)),</span><span class="n">index</span><span class="o">=</span><span class="n">enr_e</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">enr_e</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">enr_e</span> <span class="o">&lt;</span> <span class="n">enr_p</span><span class="p">,</span> <span class="n">enr_e</span><span class="p">,</span> <span class="n">enr_p</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="n">enr_e</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">enr_e</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">significances</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">value_key</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">group_key</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">p_key</span><span class="p">)</span>
        <span class="n">enr</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>
        
    <span class="c1"># avoid discrepancies between color and annotation by basing both color and annotation on cuts on the same values</span>
    <span class="n">enr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ann</span> <span class="o">&gt;</span> <span class="n">pmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">enr</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="n">enr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">enr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">ann</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ann</span> <span class="o">&gt;</span> <span class="n">pmax</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ann</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)),</span><span class="n">index</span><span class="o">=</span><span class="n">enr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">enr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="n">enr</span> <span class="o">=</span> <span class="n">enr</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ann</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">annotate_pvalues</span><span class="p">:</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># setup the plotting</span>
    <span class="n">enriched_color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.07058823529411765</span><span class="p">,</span> <span class="mf">0.09019607843137255</span><span class="p">)</span>
    <span class="n">depleted_color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.30196078431372547</span><span class="p">,</span> <span class="mf">0.5215686274509804</span><span class="p">,</span> <span class="mf">0.7098039215686275</span><span class="p">)</span>
    <span class="n">null_color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">slightly_weight</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">slightly_enriched_color</span><span class="p">,</span> <span class="n">slightly_depleted_color</span> <span class="o">=</span> <span class="n">mix_base_colors</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">slightly_weight</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">slightly_weight</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],[</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">slightly_weight</span><span class="p">,</span><span class="n">slightly_weight</span><span class="p">],]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">enriched_color</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">null_color</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">depleted_color</span><span class="p">)])</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">depleted_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ct2</span> <span class="o">=</span> <span class="n">min_log</span><span class="o">/</span><span class="n">max_log</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="n">null_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">null_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">ct2</span><span class="p">,</span>  <span class="n">null_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slightly_enriched_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                         <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">enriched_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">enriched_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span>
               <span class="s1">&#39;green&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="n">null_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">null_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">ct2</span><span class="p">,</span>  <span class="n">null_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slightly_enriched_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                         <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">enriched_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">enriched_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span>
                <span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="n">null_color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">null_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">ct2</span><span class="p">,</span>  <span class="n">null_color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">slightly_enriched_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                         <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">enriched_color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">enriched_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]}</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="p">(</span><span class="s1">&#39;sigmap&#39;</span><span class="p">,</span> <span class="n">segmentdata</span><span class="o">=</span><span class="n">cdict</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">enr</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">max_log</span><span class="p">),</span> <span class="n">cmap_center</span><span class="o">=</span><span class="n">max_log</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">ann</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">value_cluster</span><span class="o">=</span><span class="n">value_cluster</span><span class="p">,</span> <span class="n">group_cluster</span><span class="o">=</span><span class="n">group_cluster</span><span class="p">,</span> <span class="n">value_order</span><span class="o">=</span><span class="n">value_order</span><span class="p">,</span> <span class="n">group_order</span><span class="o">=</span><span class="n">group_order</span><span class="p">,</span> <span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ct1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">min_log</span><span class="o">/</span><span class="n">max_log</span><span class="p">)</span>
        <span class="n">ct2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">min_log</span><span class="o">/</span><span class="n">max_log</span><span class="p">)</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="n">depleted_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">depleted_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">ct1</span><span class="p">,</span>  <span class="n">slightly_depleted_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">null_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">ct2</span><span class="p">,</span>  <span class="n">null_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slightly_enriched_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                         <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">enriched_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">enriched_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]]],</span>
               <span class="s1">&#39;green&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="n">depleted_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">depleted_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">ct1</span><span class="p">,</span>  <span class="n">slightly_depleted_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">null_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">ct2</span><span class="p">,</span>  <span class="n">null_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slightly_enriched_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                         <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">enriched_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">enriched_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span>
                <span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="n">depleted_color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">depleted_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">ct1</span><span class="p">,</span>  <span class="n">slightly_depleted_color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">null_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">ct2</span><span class="p">,</span>  <span class="n">null_color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">slightly_enriched_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                         <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">enriched_color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">enriched_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]}</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="p">(</span><span class="s1">&#39;sigmap&#39;</span><span class="p">,</span> <span class="n">segmentdata</span><span class="o">=</span><span class="n">cdict</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">enr</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">max_log</span><span class="p">,</span><span class="n">max_log</span><span class="p">),</span> <span class="n">cmap_center</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">ann</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">value_cluster</span><span class="o">=</span><span class="n">value_cluster</span><span class="p">,</span> <span class="n">group_cluster</span><span class="o">=</span><span class="n">group_cluster</span><span class="p">,</span> <span class="n">value_order</span><span class="o">=</span><span class="n">value_order</span><span class="p">,</span> <span class="n">group_order</span><span class="o">=</span><span class="n">group_order</span><span class="p">,</span> <span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>

    <span class="n">rel_dpi_factor</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_dpi</span><span class="p">()</span> <span class="o">/</span> <span class="mi">72</span>
    <span class="n">height_pxl</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="o">*</span> <span class="n">scale_legend</span>
    <span class="n">width_pxl</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="o">*</span> <span class="n">scale_legend</span>
    <span class="n">offset_top_pxl</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="o">*</span> <span class="n">scale_legend</span>
    <span class="n">offset_left_pxl</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="o">*</span> <span class="n">scale_legend</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">left</span><span class="p">,</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">offset_left_pxl</span><span class="p">,</span><span class="o">-</span><span class="n">offset_top_pxl</span><span class="o">-</span><span class="n">height_pxl</span><span class="p">]))</span>
    <span class="n">width</span><span class="p">,</span><span class="n">height</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">width_pxl</span><span class="p">,</span><span class="n">height_pxl</span><span class="p">]))</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span> <span class="k">if</span> <span class="n">depleted_label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="n">max_log</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_log</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">),</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depleted_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="n">min_log</span><span class="p">,</span><span class="n">max_log</span><span class="p">])</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="n">pmax</span><span class="p">,</span><span class="n">pmin</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="o">-</span><span class="n">max_log</span><span class="p">,</span><span class="o">-</span><span class="n">min_log</span><span class="p">,</span><span class="n">min_log</span><span class="p">,</span><span class="n">max_log</span><span class="p">])</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="n">pmin</span><span class="p">,</span><span class="n">pmax</span><span class="p">,</span><span class="n">pmax</span><span class="p">,</span><span class="n">pmin</span><span class="p">])</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;enriched&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset pixels&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">scale_legend</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;insignificant&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span> <span class="k">if</span> <span class="n">depleted_label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.5</span><span class="p">)),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset pixels&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span> <span class="k">if</span> <span class="n">depleted_label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;center&#39;</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">scale_legend</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depleted_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;depleted&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset pixels&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">scale_legend</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<span class="k">def</span> <span class="nf">_escape_math_special_characters</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;\_&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span>

<span class="k">def</span> <span class="nf">_get_co_occurrence</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">analysis_key</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">show_only_center</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">score_key</span><span class="p">,</span> <span class="n">log_base</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">analysis_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`analysis_key` &quot;</span><span class="si">{</span><span class="n">analysis_key</span><span class="si">}</span><span class="s1">&quot; is not found in `adata.uns`! Make sure to run tc.tl.co_occurrence first.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">score_key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">analysis_key</span><span class="p">]:</span>
        <span class="n">mean_scores</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">analysis_key</span><span class="p">][</span><span class="n">score_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">score_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">log_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mean_scores</span> <span class="o">=</span> <span class="n">mean_scores</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">log_base</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The score_key </span><span class="si">{</span><span class="n">score_key</span><span class="si">!r}</span><span class="s1"> was not found!&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">mean_scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The score </span><span class="si">{</span><span class="n">score_key</span><span class="si">!r}</span><span class="s1"> in `adata.uns[</span><span class="si">{</span><span class="n">analysis_key</span><span class="si">}</span><span class="s1">]` is None!&#39;</span><span class="p">)</span>
    
    <span class="n">intervals</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">analysis_key</span><span class="p">][</span><span class="s1">&#39;interval&#39;</span><span class="p">]</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">analysis_key</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">analysis_key</span><span class="p">][</span><span class="s1">&#39;center&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">show_only</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">show_only</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">show_only</span> <span class="o">=</span> <span class="p">[</span><span class="n">show_only</span><span class="p">]</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">show_only</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">show_only</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `show_only` categories </span><span class="si">{</span><span class="p">[</span><span class="n">s</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">show_only</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">annotation</span><span class="p">]</span><span class="si">!r}</span><span class="s1"> are not available in the data!&#39;</span><span class="p">)</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="n">select</span><span class="p">]</span>
        <span class="n">mean_scores</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[</span><span class="n">select</span><span class="p">,:,:]</span>
        <span class="c1"># check if the order is the same as in the show_only selection</span>
        <span class="n">permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">annotation</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">show_only</span><span class="p">))]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">permutation</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">permutation</span><span class="p">))):</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="n">permutation</span><span class="p">]</span>
            <span class="n">mean_scores</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[</span><span class="n">permutation</span><span class="p">,:,:]</span>

    <span class="k">if</span> <span class="n">show_only_center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">show_only_center</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">show_only_center</span> <span class="o">=</span> <span class="p">[</span><span class="n">show_only_center</span><span class="p">]</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">show_only_center</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">show_only_center</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `show_only_center` categories </span><span class="si">{</span><span class="p">[</span><span class="n">s</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">show_only_center</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">center</span><span class="p">]</span><span class="si">!r}</span><span class="s1"> are not available in the data!&#39;</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="n">select</span><span class="p">]</span>
        <span class="n">mean_scores</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[:,</span><span class="n">select</span><span class="p">,:]</span>
        <span class="c1"># check if the order is the same as in the show_only_center selection</span>
        <span class="n">permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">center</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">show_only_center</span><span class="p">))]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">permutation</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">permutation</span><span class="p">))):</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="n">permutation</span><span class="p">]</span>
            <span class="n">mean_scores</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[:,</span><span class="n">permutation</span><span class="p">,:]</span>

    <span class="n">colors</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_get_colors</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">annotation</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">mean_scores</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">types</span>

<span class="k">def</span> <span class="nf">_get_cooc_expression_label</span><span class="p">(</span><span class="n">score_key</span><span class="p">,</span><span class="n">log_base</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">score_key</span> <span class="o">==</span> <span class="s1">&#39;occ&#39;</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">frac{p(anno|center)}{p(anno)}$&#39;</span>
    <span class="k">elif</span> <span class="n">score_key</span> <span class="o">==</span> <span class="s1">&#39;log_occ&#39;</span><span class="p">:</span>
        <span class="n">base_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">log_base</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">log_base</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$log&#39;</span> <span class="o">+</span> <span class="n">base_str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">left(</span><span class="se">\\</span><span class="s1">frac{p(anno|center)}{p(anno)}</span><span class="se">\\</span><span class="s1">right)$&#39;</span>
    <span class="k">elif</span> <span class="n">score_key</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">frac{log(N(anno,center))-random expectation}{standard deviation}$&#39;</span>
    <span class="k">elif</span> <span class="n">score_key</span> <span class="o">==</span> <span class="s1">&#39;composition&#39;</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$p(anno|center)$&#39;</span>
    <span class="k">elif</span> <span class="n">score_key</span> <span class="o">==</span> <span class="s1">&#39;log_composition&#39;</span><span class="p">:</span>
        <span class="n">base_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">log_base</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">log_base</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$log&#39;</span> <span class="o">+</span> <span class="n">base_str</span> <span class="o">+</span> <span class="s1">&#39;(p(anno|center))$&#39;</span>
    <span class="k">elif</span> <span class="n">score_key</span> <span class="o">==</span> <span class="s1">&#39;distance_distribution&#39;</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$p(dist|anno,center)$&#39;</span>
    <span class="k">elif</span> <span class="n">score_key</span> <span class="o">==</span> <span class="s1">&#39;log_distance_distribution&#39;</span><span class="p">:</span>
        <span class="n">base_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">log_base</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">log_base</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$log&#39;</span> <span class="o">+</span> <span class="n">base_str</span> <span class="o">+</span> <span class="s1">&#39;(p(dist|anno,center))$&#39;</span>
    <span class="k">elif</span> <span class="n">score_key</span> <span class="o">==</span> <span class="s1">&#39;relative_distance_distribution&#39;</span><span class="p">:</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">frac{p(dist|anno,center)}{p(dist|*,center)}$&#39;</span>
    <span class="k">elif</span> <span class="n">score_key</span> <span class="o">==</span> <span class="s1">&#39;log_relative_distance_distribution&#39;</span><span class="p">:</span>
        <span class="n">base_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">log_base</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">log_base</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$log&#39;</span> <span class="o">+</span> <span class="n">base_str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">left(</span><span class="se">\\</span><span class="s1">frac{p(dist|anno,center)}{p(dist|*,center)}</span><span class="se">\\</span><span class="s1">right)$&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">log_base</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">log_base</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;$log&#39;</span> <span class="o">+</span> <span class="n">base_str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">left(</span><span class="se">\\</span><span class="s1">frac{p(anno|center)/p(anno)}{gmean</span><span class="se">\\</span><span class="s1">left(p(anno|center)/p(anno)</span><span class="se">\\</span><span class="s1">right)}</span><span class="se">\\</span><span class="s1">right)$&#39;</span>
    <span class="k">return</span> <span class="n">expression</span>

<div class="viewcode-block" id="co_occurrence">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.co_occurrence.html#tacco.plots.co_occurrence">[docs]</a>
<span class="k">def</span> <span class="nf">co_occurrence</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">analysis_key</span><span class="p">,</span>
    <span class="n">score_key</span><span class="o">=</span><span class="s1">&#39;log_occ&#39;</span><span class="p">,</span>
    <span class="n">log_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_only_center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">,</span>
    <span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">merged</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Plot co-occurrence as determined by :func:`~tacco.tools.co_occurrence`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` with the co-occurence analysis in `.uns`.</span>
<span class="sd">        Can also be a mapping of labels to :class:`~anndata.AnnData` to specify</span>
<span class="sd">        multiple datasets.</span>
<span class="sd">    analysis_key</span>
<span class="sd">        The `.uns` key with the co-occurence analysis result.</span>
<span class="sd">    score_key</span>
<span class="sd">        The `.uns[analysis_key]` key of the score to use or the</span>
<span class="sd">        `.uns[analysis_key][&#39;comparisons&#39;]` sub-key specifying the comparison</span>
<span class="sd">        to plot. Available keys `.uns[analysis_key]` include:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;occ&#39;: co-occurrence</span>
<span class="sd">        - &#39;log_occ&#39;: logarithm of the co-occurrence</span>
<span class="sd">        - &#39;log2_occ&#39;: base-2-logarithm of the co-occurrence; this is a not a</span>
<span class="sd">          real key but a convenience function to rescale the &#39;log_occ&#39; values</span>
<span class="sd">        - &#39;z&#39;: z-score of the log of the neighbourship counts with respect to</span>
<span class="sd">          random neighbourships</span>
<span class="sd">        - &#39;composition&#39;: distance dependent composition, `p(anno|center, dist)`</span>
<span class="sd">        - &#39;log_composition&#39;: log of &#39;composition&#39;</span>
<span class="sd">        - &#39;distance_distribution&#39;: distribution of distances between anno and</span>
<span class="sd">          center ´p(dist|anno,center)´</span>
<span class="sd">        - &#39;log_distance_distribution&#39;: log of &#39;distance_distribution&#39;</span>
<span class="sd">        - &#39;relative_distance_distribution&#39;: &#39;distance_distribution&#39; normalized</span>
<span class="sd">          to `p(dist|*,center)`, the distance distribution of any annotation to</span>
<span class="sd">          the center</span>
<span class="sd">        - &#39;log_relative_distance_distribution&#39;: log of</span>
<span class="sd">          &#39;relative_distance_distribution&#39;</span>
<span class="sd">    log_base</span>
<span class="sd">        The base of the logarithm to use for plotting if `score_key` is</span>
<span class="sd">        &#39;log_occ&#39; or a comparison key. If `None`, use the natural logarithm.</span>
<span class="sd">    colors</span>
<span class="sd">        The mapping of value names to colors. If `None`, a set of</span>
<span class="sd">        standard colors is used.</span>
<span class="sd">    show_only</span>
<span class="sd">        A subset of annotation values to restrict the plotting to.</span>
<span class="sd">    show_only_center</span>
<span class="sd">        A subset of the center annotation values to restrict the plotting</span>
<span class="sd">        to.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis.</span>
<span class="sd">    sharex, sharey</span>
<span class="sd">        Whether and how to use common x/y axis. Options include `True`,</span>
<span class="sd">        `False`, &quot;col&quot;, &quot;row&quot;, &quot;none&quot;, and &quot;all&quot;.</span>
<span class="sd">    wspace, hspace</span>
<span class="sd">        Control the spacing between the plots.</span>
<span class="sd">    legend</span>
<span class="sd">        Whether to include the legend</span>
<span class="sd">    grid</span>
<span class="sd">        Whether to plot a grid</span>
<span class="sd">    merged</span>
<span class="sd">        Whether to merge the plots for all :class:`~anndata.AnnData` instances</span>
<span class="sd">        into a single row of plots. This makes only sense if more instances are</span>
<span class="sd">        provided in `adata`.</span>
<span class="sd">    ax</span>
<span class="sd">        The :class:`~matplotlib.axes.Axes` to plot on. If `None`, creates a</span>
<span class="sd">        fresh figure for plotting.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">adatas</span> <span class="o">=</span> <span class="n">_get_adatas</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">linestyles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span><span class="s1">&#39;dashdot&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">adata_i</span><span class="p">,</span> <span class="p">(</span><span class="n">adata_name</span><span class="p">,</span> <span class="n">adata</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adatas</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="n">mean_scores</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_get_co_occurrence</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">analysis_key</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">show_only_center</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">score_key</span><span class="p">,</span> <span class="n">log_base</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">merged</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">linestyles</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`merged==True` is ony possible with up to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">linestyles</span><span class="p">)</span><span class="si">}</span><span class="s1"> andatas!&#39;</span><span class="p">)</span>
            
            
            <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
                        <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ax</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span>
                    <span class="k">if</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `ax` argument got the wrong shape of axes: needed is </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">!r}</span><span class="s1"> supplied was </span><span class="si">{</span><span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="si">!r}</span><span class="s1">!&#39;</span><span class="p">)</span>
                    <span class="n">axsize</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span><span class="o">.</span><span class="n">size</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="n">hspace</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="n">wspace</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="p">)</span>


            <span class="k">for</span> <span class="n">ir</span><span class="p">,</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">center</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">intervals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="k">for</span> <span class="n">ja</span><span class="p">,</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">annotation</span><span class="p">):</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[</span><span class="n">ja</span><span class="p">,</span><span class="n">ir</span><span class="p">,:]</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyles</span><span class="p">[</span><span class="n">adata_i</span><span class="p">]</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">na</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">adata_i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
                    <span class="n">adata_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;center </span><span class="si">{</span><span class="n">center</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1">: &#39;</span>
                    <span class="n">anno_title</span> <span class="o">=</span> <span class="s1">&#39;annotation: &#39;</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">anno_title</span><span class="p">)</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">_get_cooc_expression_label</span><span class="p">(</span><span class="n">score_key</span><span class="p">,</span><span class="n">log_base</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">adata_title</span> <span class="o">+</span> <span class="n">expression</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
                        <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ax</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span>
                    <span class="k">if</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `ax` argument got the wrong shape of axes: needed is </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">))</span><span class="si">!r}</span><span class="s1"> supplied was </span><span class="si">{</span><span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="si">!r}</span><span class="s1">!&#39;</span><span class="p">)</span>
                    <span class="n">axsize</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span><span class="o">.</span><span class="n">size</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span> <span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="n">hspace</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="n">wspace</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="p">)</span>

            <span class="k">for</span> <span class="n">ir</span><span class="p">,</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">center</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">intervals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="k">for</span> <span class="n">ja</span><span class="p">,</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">annotation</span><span class="p">):</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[</span><span class="n">ja</span><span class="p">,</span><span class="n">ir</span><span class="p">,:]</span>
                    <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyles</span><span class="p">[</span><span class="n">nr</span><span class="o">==</span><span class="n">na</span><span class="p">]</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">adata_i</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">na</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">)</span>

                <span class="n">axs</span><span class="p">[</span><span class="n">adata_i</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>

                <span class="n">adata_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">adata_name</span><span class="si">}</span><span class="s1">, center </span><span class="si">{</span><span class="n">center</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1">: &#39;</span> <span class="k">if</span> <span class="n">adata_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;center </span><span class="si">{</span><span class="n">center</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1">: &#39;</span>
                <span class="n">anno_title</span> <span class="o">=</span> <span class="s1">&#39;annotation: &#39;</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">.</span><span class="n">name</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">adata_i</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">adata_i</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">anno_title</span><span class="p">)</span>

                <span class="n">expression</span> <span class="o">=</span> <span class="n">_get_cooc_expression_label</span><span class="p">(</span><span class="n">score_key</span><span class="p">,</span><span class="n">log_base</span><span class="p">)</span>

                <span class="n">axs</span><span class="p">[</span><span class="n">adata_i</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">adata_title</span> <span class="o">+</span> <span class="n">expression</span><span class="p">)</span>

                <span class="n">axs</span><span class="p">[</span><span class="n">adata_i</span><span class="p">,</span><span class="n">ir</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        
        <span class="n">handles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">merged</span><span class="p">:</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">adata_name</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">)</span> <span class="k">for</span> <span class="p">((</span><span class="n">adata_name</span><span class="p">,</span> <span class="n">adata</span><span class="p">),</span> <span class="n">linestyle</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">adatas</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">linestyles</span><span class="p">)</span> <span class="p">])</span>
        
        <span class="n">handles</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">annotation</span><span class="p">])</span> <span class="p">])</span>
        
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
    
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="co_occurrence_matrix">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.co_occurrence_matrix.html#tacco.plots.co_occurrence_matrix">[docs]</a>
<span class="k">def</span> <span class="nf">co_occurrence_matrix</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">analysis_key</span><span class="p">,</span>
    <span class="n">score_key</span><span class="o">=</span><span class="s1">&#39;log_occ&#39;</span><span class="p">,</span>
    <span class="n">log_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_only_center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">wspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">x_padding</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">y_padding</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">value_cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">group_cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">restrict_intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">p_corr</span><span class="o">=</span><span class="s1">&#39;fdr_bh&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span>
    <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">scale_legend</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Plot co-occurrence as determined by :func:`~tacco.tools.co_occurrence` or</span>
<span class="sd">    :func:`~tacco.tools.co_occurrence_matrix` as a matrix.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` with the co-occurence analysis in `.uns`.</span>
<span class="sd">        Can also be a mapping of labels to :class:`~anndata.AnnData` to specify</span>
<span class="sd">        multiple datasets.</span>
<span class="sd">    analysis_key</span>
<span class="sd">        The `.uns` key with the co-occurence analysis result.</span>
<span class="sd">    score_key</span>
<span class="sd">        The `.uns[analysis_key]` key of the score to use. Available keys</span>
<span class="sd">        `.uns[analysis_key]` include:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;occ&#39;: co-occurrence</span>
<span class="sd">        - &#39;log_occ&#39;: logarithm of the co-occurrence</span>
<span class="sd">        - &#39;log2_occ&#39;: base-2-logarithm of the co-occurrence; this is a not a</span>
<span class="sd">          real key but a convenience function to rescale the &#39;log_occ&#39; values</span>
<span class="sd">        - &#39;z&#39;: z-score of the log of the neighbourship counts with respect to</span>
<span class="sd">          random neighbourships</span>
<span class="sd">        - &#39;composition&#39;: distance dependent composition, `p(anno|center, dist)`</span>
<span class="sd">        - &#39;log_composition&#39;: log of &#39;composition&#39;</span>
<span class="sd">        - &#39;distance_distribution&#39;: distribution of distances between anno and</span>
<span class="sd">          center ´p(dist|anno,center)´</span>
<span class="sd">        - &#39;log_distance_distribution&#39;: log of &#39;distance_distribution&#39;</span>
<span class="sd">        - &#39;relative_distance_distribution&#39;: &#39;distance_distribution&#39; normalized</span>
<span class="sd">          to `p(dist|*,center)`, the distance distribution of any annotation to</span>
<span class="sd">          the center</span>
<span class="sd">        - &#39;log_relative_distance_distribution&#39;: log of</span>
<span class="sd">          &#39;relative_distance_distribution&#39;</span>
<span class="sd">    log_base</span>
<span class="sd">        The base of the logarithm to use for plotting if `score_key` is a log</span>
<span class="sd">        quantity. If `None`, use the natural logarithm.</span>
<span class="sd">    colors</span>
<span class="sd">        The mapping of value names to colors. If `None`, a set of</span>
<span class="sd">        standard colors is used.</span>
<span class="sd">    show_only</span>
<span class="sd">        A subset of annotation values to restrict the plotting to.</span>
<span class="sd">    show_only_center</span>
<span class="sd">        A subset of the center annotation values to restrict the plotting</span>
<span class="sd">        to.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of a single axis. If `None`, some heuristic</span>
<span class="sd">        value is used.</span>
<span class="sd">    hspace, vspace</span>
<span class="sd">        Relative horizontal and vertical spacing between plots</span>
<span class="sd">    x_padding, y_padding</span>
<span class="sd">        Absolute horizontal and vertical spacing between plots; this setting</span>
<span class="sd">        overrides `hspace` and `vspace`; if `None`, use the value from `hspace`</span>
<span class="sd">        `vspace`; if `None`, use the value from `vspace`</span>
<span class="sd">    value_cluster</span>
<span class="sd">        Whether to cluster and reorder the values.</span>
<span class="sd">    group_cluster</span>
<span class="sd">        Whether to cluster and reorder the groups.</span>
<span class="sd">    restrict_intervals</span>
<span class="sd">        A list-like containing the indices of the intervals to plot. If `None`,</span>
<span class="sd">        all intervals are included.</span>
<span class="sd">    cmap</span>
<span class="sd">        A string/colormap to override the `colors` with globally.</span>
<span class="sd">    cmap_vmin_vmax</span>
<span class="sd">        A tuple giving the range of values for the colormap.</span>
<span class="sd">    legend</span>
<span class="sd">        Whether to include the legend</span>
<span class="sd">    scale_legend</span>
<span class="sd">        Set to scale height and width of legend.</span>
<span class="sd">    ax</span>
<span class="sd">        The :class:`~matplotlib.axes.Axes` to plot on. If `None`, creates a</span>
<span class="sd">        fresh figure for plotting. Incompatible with dendrogram plotting.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">adatas</span> <span class="o">=</span> <span class="n">_get_adatas</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    
    <span class="n">min_max</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># first pass through the data to get global min/max of the values for colormap</span>
    <span class="k">for</span> <span class="n">adata_i</span><span class="p">,</span> <span class="p">(</span><span class="n">adata_name</span><span class="p">,</span> <span class="n">adata</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adatas</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="n">mean_scores</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_get_co_occurrence</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">analysis_key</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">show_only_center</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">score_key</span><span class="o">=</span><span class="n">score_key</span><span class="p">,</span> <span class="n">log_base</span><span class="o">=</span><span class="n">log_base</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">min_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">restrict_intervals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">restrict_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">restrict_intervals</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[:,:,</span><span class="n">restrict_intervals</span><span class="p">]</span>
        
        <span class="n">min_max</span><span class="p">[</span><span class="n">adata_i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
    <span class="n">min_max</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_max</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">min_max</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_max</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="n">cmap_vmin_vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_max</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cmap_vmin_vmax</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">axsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axsize</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="mf">0.2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ax</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="k">if</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">restrict_intervals</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `ax` argument got the wrong shape of axes: needed is </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">restrict_intervals</span><span class="p">))</span><span class="si">!r}</span><span class="s1"> supplied was </span><span class="si">{</span><span class="n">axs</span><span class="o">.</span><span class="n">shape</span><span class="si">!r}</span><span class="s1">!&#39;</span><span class="p">)</span>
        <span class="n">axsize</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span><span class="o">.</span><span class="n">size</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">restrict_intervals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">),</span> <span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="n">hspace</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="n">wspace</span><span class="p">,</span> <span class="n">x_padding</span><span class="o">=</span><span class="n">x_padding</span><span class="p">,</span> <span class="n">y_padding</span><span class="o">=</span><span class="n">y_padding</span><span class="p">,</span> <span class="p">)</span>
    
    <span class="c1"># second pass for actual plotting</span>
    <span class="k">for</span> <span class="n">adata_i</span><span class="p">,</span> <span class="p">(</span><span class="n">adata_name</span><span class="p">,</span> <span class="n">adata</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adatas</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="n">mean_scores</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_get_co_occurrence</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">analysis_key</span><span class="p">,</span> <span class="n">show_only</span><span class="p">,</span> <span class="n">show_only_center</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">score_key</span><span class="o">=</span><span class="n">score_key</span><span class="p">,</span> <span class="n">log_base</span><span class="o">=</span><span class="n">log_base</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[:,:,</span><span class="n">restrict_intervals</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">_ii</span><span class="p">,</span> <span class="n">rii</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">restrict_intervals</span><span class="p">):</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">intervals</span><span class="p">[</span><span class="n">rii</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">intervals</span><span class="p">[</span><span class="n">rii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
            
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">adata_i</span><span class="p">,</span><span class="n">_ii</span><span class="p">]</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[:,:,</span><span class="n">_ii</span><span class="p">]</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="n">heatmap</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">value_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
                <span class="n">value_cluster</span><span class="o">=</span><span class="n">value_cluster</span><span class="p">,</span> <span class="n">group_cluster</span><span class="o">=</span><span class="n">group_cluster</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">cmap_center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="c1">#(0 if log else None),</span>
                <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="n">min_max</span><span class="p">[</span><span class="n">adata_i</span><span class="p">,</span><span class="n">_ii</span><span class="p">],</span>
                <span class="n">group_labels_rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">);</span>

            <span class="n">adata_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">adata_name</span><span class="si">}</span><span class="s1">, interval </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s1">: &#39;</span> <span class="k">if</span> <span class="n">adata_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;interval </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s1">: &#39;</span>

            <span class="n">expression</span> <span class="o">=</span> <span class="n">_get_cooc_expression_label</span><span class="p">(</span><span class="n">score_key</span><span class="p">,</span><span class="n">log_base</span><span class="p">)</span>
                
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">adata_title</span> <span class="o">+</span> <span class="n">expression</span><span class="p">)</span>

            <span class="n">anno_title</span> <span class="o">=</span> <span class="s1">&#39;annotation: &#39;</span> <span class="o">+</span> <span class="n">_escape_math_special_characters</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">anno_center_title</span> <span class="o">=</span> <span class="s1">&#39;center: &#39;</span> <span class="o">+</span> <span class="n">_escape_math_special_characters</span><span class="p">(</span><span class="n">center</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">anno_title</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">anno_center_title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">_add_legend_or_colorbars</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">min_max</span><span class="o">=</span><span class="n">min_max</span><span class="p">,</span> <span class="n">scale_legend</span><span class="o">=</span><span class="n">scale_legend</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="annotated_heatmap">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.annotated_heatmap.html#tacco.plots.annotated_heatmap">[docs]</a>
<span class="k">def</span> <span class="nf">annotated_heatmap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">obs_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">var_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">var_highlight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">obs_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">var_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span>
    <span class="n">cmap_center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cmap_vmin_vmax</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">trafo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Plots a heatmap of cells and genes grouped by categorical annotations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` with annotation in `.obs` and/or `.var`.</span>
<span class="sd">    obs_key</span>
<span class="sd">        The `.obs` key with the categorical `obs` annotation to use. If `None`,</span>
<span class="sd">        the observations are not grouped and plotted in the order in which they</span>
<span class="sd">        appear in `adata`.</span>
<span class="sd">    var_key</span>
<span class="sd">        The `.var` key with the categorical `var` annotation to use. Can also</span>
<span class="sd">        be a mapping of annotations to list-likes of var names. If `None`, the</span>
<span class="sd">        genes are not grouped and plotted in the order in which they appear in</span>
<span class="sd">        `adata`. If `n_genes` is set, the meaning of this key is modified.</span>
<span class="sd">    n_genes</span>
<span class="sd">        The number of differentially expressed genes to find for the groups of</span>
<span class="sd">        observations. The differentially exressed genes will be used in place</span>
<span class="sd">        of a categorical `var` annotation. Setting `n_genes` changes the</span>
<span class="sd">        behaviour of `var_key`: It is interpreted as a categorical `.obs` key</span>
<span class="sd">        defining the groups of observations for which to derive the</span>
<span class="sd">        differentially expressed genes. If `var_key` is `None`, `obs_key` is</span>
<span class="sd">        used for that.</span>
<span class="sd">    var_highlight</span>
<span class="sd">        A list-like of var names to annotate.</span>
<span class="sd">    obs_colors</span>
<span class="sd">        A dict-like with the colors to use for the `obs_key` annotation. If</span>
<span class="sd">        `None`, default colors are used.</span>
<span class="sd">    var_colors</span>
<span class="sd">        A dict-like with the colors to use for the `var_key` annotation. If</span>
<span class="sd">        `None`, default colors are used, except if `n_genes` is set which</span>
<span class="sd">        triggers the usage of `obs_colors` for `var_colors`.</span>
<span class="sd">    cmap</span>
<span class="sd">        A string/colormap to use in the heatmap.</span>
<span class="sd">    cmap_center</span>
<span class="sd">        A value to use as center of the colormap. E.g. choosing `0` sets the</span>
<span class="sd">        central color to `0`. If `None`, the colormap spans the entire value</span>
<span class="sd">        range.</span>
<span class="sd">    cmap_vmin_vmax</span>
<span class="sd">        A tuple giving the range of values for the colormap. This can be</span>
<span class="sd">        modfied by `cmap_center`.</span>
<span class="sd">    trafo</span>
<span class="sd">        Whether to normalize, logarithmize, and scale the data prior to</span>
<span class="sd">        plotting. This makes sense if bare count data is supplied. If the data</span>
<span class="sd">        is already preprocessed, this can be set to `False`. If `None`, a</span>
<span class="sd">        heuristic tries to figure out whether count data was supplied, and if</span>
<span class="sd">        so performs the preprocessing.</span>
<span class="sd">    axsize</span>
<span class="sd">        Tuple of width and size of the main axis.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">trafo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">got_counts</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">preprocessing</span><span class="o">.</span><span class="n">check_counts_validity</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">got_counts</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">got_counts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;`adata` looks like it contains bare counts and will be normalized, logarithmized, and scaled for plotting. If that is not desired (and to get rid of this message) explicitly set `trafo` to something else than `None`.&#39;</span><span class="p">)</span>
            <span class="n">trafo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trafo</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="n">trafo</span> <span class="ow">or</span> <span class="n">n_genes</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">trafo</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">var_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var_key</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`var_key` cannot be a dict-like if `n_genes` is set!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`var_key` </span><span class="si">{</span><span class="n">var_key</span><span class="si">!r}</span><span class="s1"> is not a column of `adata.obs` even though `n_genes` is set!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">var_key</span><span class="p">],</span> <span class="s1">&#39;cat&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: `var_key` </span><span class="si">{</span><span class="n">var_key</span><span class="si">!r}</span><span class="s1"> is not a categorical column of `adata.obs` even though `n_genes` is set! Treating it as a categorical column...&#39;</span><span class="p">)</span>
                <span class="n">group_key</span> <span class="o">=</span> <span class="n">var_key</span>
            <span class="k">elif</span> <span class="n">obs_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obs_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`obs_key` </span><span class="si">{</span><span class="n">obs_key</span><span class="si">!r}</span><span class="s1"> is not a column of `adata.obs`!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">obs_key</span><span class="p">],</span> <span class="s1">&#39;cat&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: `obs_key` </span><span class="si">{</span><span class="n">obs_key</span><span class="si">!r}</span><span class="s1"> is not a categorical column of `adata.obs`! Treating it as a categorical column...&#39;</span><span class="p">)</span>
                <span class="n">group_key</span> <span class="o">=</span> <span class="n">obs_key</span>
                <span class="k">if</span> <span class="n">var_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">var_colors</span> <span class="o">=</span> <span class="n">obs_colors</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`n_genes` can only be used if at least one of [`obs_key`, `var_key`] is not `None`!&#39;</span><span class="p">)</span>
                
            <span class="n">ukey</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_unused_key</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">)</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">key_added</span><span class="o">=</span><span class="n">ukey</span><span class="p">,</span> <span class="n">n_genes</span><span class="o">=</span><span class="n">n_genes</span><span class="p">,)</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">ukey</span><span class="p">][</span><span class="s1">&#39;names&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">ukey</span><span class="p">]</span>
                
        <span class="k">else</span><span class="p">:</span> <span class="c1"># if var_key is not None:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var_key</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">):</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="n">var_key</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`var_key` </span><span class="si">{</span><span class="n">var_key</span><span class="si">!r}</span><span class="s1"> is not a column of `adata.var`!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">var_key</span><span class="p">],</span> <span class="s1">&#39;cat&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: `var_key` </span><span class="si">{</span><span class="n">var_key</span><span class="si">!r}</span><span class="s1"> is not a categorical column of `adata.var`! Treating it as a categorical column...&#39;</span><span class="p">)</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">var_key</span><span class="p">)}</span>

        <span class="n">all_marker</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">marker</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>
        <span class="c1"># reorder genes to represent the annotation</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span><span class="n">all_marker</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">var_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_colors</span> <span class="o">=</span> <span class="n">to_rgba_array</span><span class="p">(</span><span class="n">get_default_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">marker</span><span class="p">)))</span>
            <span class="n">var_colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">cat</span><span class="p">:</span><span class="n">col</span> <span class="k">for</span> <span class="n">cat</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">marker</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">var_colors</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var_colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">cat</span><span class="p">:</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="n">var_colors</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            
        <span class="n">all_marker_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_colors</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">marker</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>
        
        <span class="n">all_marker_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">marker</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>
        <span class="n">marker_centers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_marker_labels</span><span class="p">))[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_marker_labels</span><span class="p">)</span> <span class="o">==</span> <span class="n">l</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">marker</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">obs_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">obs_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`obs_key` </span><span class="si">{</span><span class="n">obs_key</span><span class="si">!r}</span><span class="s1"> is not a column of `adata.obs`!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">obs_key</span><span class="p">],</span> <span class="s1">&#39;cat&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: `obs_key` </span><span class="si">{</span><span class="n">obs_key</span><span class="si">!r}</span><span class="s1"> is not a categorical column of `adata.obs`! Treating it as a categorical column...&#39;</span><span class="p">)</span>

        <span class="n">cells</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">obs_key</span><span class="p">)}</span>
        <span class="n">all_cells</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">cells</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>
        <span class="c1"># reorder cells to represent the annotation</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">all_cells</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">obs_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obs_colors</span> <span class="o">=</span> <span class="n">to_rgba_array</span><span class="p">(</span><span class="n">get_default_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)))</span>
            <span class="n">obs_colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">cat</span><span class="p">:</span><span class="n">col</span> <span class="k">for</span> <span class="n">cat</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cells</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">obs_colors</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs_colors</span> <span class="o">=</span> <span class="p">{</span><span class="n">cat</span><span class="p">:</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="n">obs_colors</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            
        <span class="n">all_cell_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_colors</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">cells</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>
        
        <span class="n">all_cell_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="n">cells</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>
        <span class="n">cell_centers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_cell_labels</span><span class="p">))[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_cell_labels</span><span class="p">)</span> <span class="o">==</span> <span class="n">l</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cells</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">var_highlight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># reorder highlighted genes to simplify labelling</span>
        <span class="n">var_highlight</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">var_highlight</span><span class="p">)]</span>
        <span class="n">highlight_centers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">var_highlight</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">var_highlight</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">trafo</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">is_view</span><span class="p">:</span>
            <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>
    <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">A</span>
    
    <span class="k">if</span> <span class="n">cmap_vmin_vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmap_vmin_vmax</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="n">cmap_vmin_vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cmap_vmin_vmax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cmap_center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shifted</span> <span class="o">=</span> <span class="n">cmap_vmin_vmax</span> <span class="o">-</span> <span class="n">cmap_center</span>
        <span class="n">abs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shifted</span><span class="p">))</span>
        <span class="n">shifted</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">abs_max</span><span class="p">,</span><span class="n">abs_max</span><span class="p">]</span>
        <span class="n">cmap_vmin_vmax</span> <span class="o">=</span> <span class="n">shifted</span> <span class="o">+</span> <span class="n">cmap_center</span>

    <span class="c1"># plotting</span>
    <span class="n">fig</span><span class="p">,</span><span class="n">axs</span><span class="o">=</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span><span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">0.03</span><span class="p">,</span><span class="n">axsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span><span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">0.03</span><span class="p">,</span><span class="n">axsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span><span class="n">x_padding</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">y_padding</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">cmap_vmin_vmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">cmap_vmin_vmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">rel_dpi_factor</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_dpi</span><span class="p">()</span> <span class="o">/</span> <span class="mi">72</span>
    <span class="n">cax_width</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="c1"># color bar width in pixel</span>
    <span class="n">cax_height</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="c1"># color bar height in pixel</span>
    <span class="n">cax_offset</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">rel_dpi_factor</span> <span class="c1"># color bar y offset in pixel</span>
    <span class="n">cax_l</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">cax_width</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cax_b</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">cax_height</span><span class="o">+</span><span class="n">cax_offset</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cax_w</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">cax_width</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cax_h</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">cax_height</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="n">cax_l</span><span class="p">,</span><span class="n">cax_b</span><span class="p">,</span><span class="n">cax_w</span><span class="p">,</span><span class="n">cax_h</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>

    <span class="c1"># labelling</span>
    <span class="k">def</span> <span class="nf">_collides</span><span class="p">(</span><span class="n">ann1</span><span class="p">,</span> <span class="n">ann2</span><span class="p">,</span> <span class="n">offset1</span><span class="p">,</span> <span class="n">offset2</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">offset1</span> <span class="o">!=</span> <span class="n">offset2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">extent1</span> <span class="o">=</span> <span class="n">ann1</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">())</span>
        <span class="n">extent2</span> <span class="o">=</span> <span class="n">ann2</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">extent2</span><span class="o">.</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">extent1</span><span class="o">.</span><span class="n">x0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">extent1</span><span class="o">.</span><span class="n">y1</span> <span class="o">&gt;</span> <span class="n">extent2</span><span class="o">.</span><span class="n">y0</span>

    <span class="k">def</span> <span class="nf">_collides_any</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">anns</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ann2</span><span class="p">,</span> <span class="n">off2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">anns</span><span class="p">,</span> <span class="n">offs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_collides</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">ann2</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">off2</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="nf">_find_offset</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">anns</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">_collides_any</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">anns</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
            <span class="n">off</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">off</span>
    <span class="k">def</span> <span class="nf">_find_shift</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">anns</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">extent1</span> <span class="o">=</span> <span class="n">ann</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">())</span>
        <span class="n">extent2</span> <span class="o">=</span> <span class="n">anns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">extent2</span><span class="o">.</span><span class="n">x1</span> <span class="o">-</span> <span class="n">extent1</span><span class="o">.</span><span class="n">x0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">extent1</span><span class="o">.</span><span class="n">y1</span> <span class="o">-</span> <span class="n">extent2</span><span class="o">.</span><span class="n">y0</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">delta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">obs_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">all_cell_colors</span><span class="p">]),</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

        <span class="n">anns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">offs</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="o">*</span><span class="n">rel_dpi_factor</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">cell_centers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ann</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="n">bar</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arrowstyle&#39;</span><span class="p">:</span><span class="s1">&#39;-&#39;</span><span class="p">},)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">_find_offset</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">anns</span><span class="p">,</span> <span class="n">offs</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">ann</span><span class="o">.</span><span class="n">xyann</span> <span class="o">=</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="n">xyann</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ann</span><span class="o">.</span><span class="n">xyann</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">offset</span><span class="o">*</span><span class="mf">1.8</span><span class="p">)</span>
            <span class="n">anns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>
            <span class="n">offs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">all_marker_colors</span><span class="p">])</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

        <span class="n">anns</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">15</span><span class="o">*</span><span class="n">rel_dpi_factor</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">marker_centers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ann</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="n">bar</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arrowstyle&#39;</span><span class="p">:</span><span class="s1">&#39;-&#39;</span><span class="p">},)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">_find_shift</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">anns</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">shift</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ann</span><span class="o">.</span><span class="n">xyann</span> <span class="o">=</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="n">xyann</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ann</span><span class="o">.</span><span class="n">xyann</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">shift</span><span class="p">)</span>
            <span class="n">anns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var_highlight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">anns</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">15</span><span class="o">*</span><span class="n">rel_dpi_factor</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="o">*</span><span class="n">rel_dpi_factor</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">highlight_centers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ann</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="o">+</span><span class="n">bar</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arrowstyle&#39;</span><span class="p">:</span><span class="s1">&#39;-&#39;</span><span class="p">},</span> <span class="n">annotation_clip</span><span class="o">=</span><span class="kc">False</span><span class="p">,)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">_find_shift</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">anns</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">shift</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ann</span><span class="o">.</span><span class="n">xyann</span> <span class="o">=</span> <span class="p">(</span><span class="n">ann</span><span class="o">.</span><span class="n">xyann</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ann</span><span class="o">.</span><span class="n">xyann</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">shift</span><span class="p">)</span>
            <span class="n">anns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_anno_hist</span><span class="p">(</span><span class="n">mist</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">anno</span><span class="p">):</span>
    <span class="n">Nobs</span><span class="p">,</span><span class="n">Nanno</span> <span class="o">=</span> <span class="n">anno</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">Nobs</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">mist</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">Nobs</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    <span class="n">Nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nd</span><span class="p">,))</span>
    <span class="n">sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nd</span><span class="p">,</span><span class="n">Nanno</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nobs</span><span class="p">):</span>
        <span class="n">di</span> <span class="o">=</span> <span class="n">mist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">_di</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">di</span> <span class="o">&lt;=</span> <span class="n">intervals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">di</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hist</span><span class="p">[</span><span class="n">_di</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sums</span><span class="p">[</span><span class="n">_di</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">anno</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nd</span><span class="p">):</span>
        <span class="n">sums</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">/=</span> <span class="n">hist</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sums</span>

<div class="viewcode-block" id="annotation_coordinate">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.annotation_coordinate.html#tacco.plots.annotation_coordinate">[docs]</a>
<span class="k">def</span> <span class="nf">annotation_coordinate</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">annotation_key</span><span class="p">,</span>
    <span class="n">coordinate_key</span><span class="p">,</span>
    <span class="n">group_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reference_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">delta_coordinate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Plots an annotation density with respect to a scalar coordinate.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        A :class:`~anndata.AnnData`.</span>
<span class="sd">    annotation_key</span>
<span class="sd">        The `.obs` or `.obsm` key to plot.</span>
<span class="sd">    coordinate_key</span>
<span class="sd">        The `.obs` key or (`.obsm` key, column name) pair with the scalar</span>
<span class="sd">        coordinate(s).</span>
<span class="sd">    group_key</span>
<span class="sd">        A categorical group annotation. The plot is done separately per group.</span>
<span class="sd">        If `None`, plots for only one group are generated.</span>
<span class="sd">    reference_key</span>
<span class="sd">        The `.obs` key to use as weights (i.e. the weight to use for</span>
<span class="sd">        calculating the annotation density). If `None`, use `1` per</span>
<span class="sd">        observation, which makes sense if the annotation is categorical or</span>
<span class="sd">        fractional annotations which should sum to `1`.</span>
<span class="sd">    max_coordinate</span>
<span class="sd">        The maximum coordinate to use. If `None` or `np.inf`, uses the maximum</span>
<span class="sd">        coordinate in the data.</span>
<span class="sd">    delta_coordinate</span>
<span class="sd">        The width in coordinate for coordinate discretization. If `None`, takes</span>
<span class="sd">        `max_coordinate/100`.</span>
<span class="sd">    axsize</span>
<span class="sd">        Size of a single axis in the plot</span>
<span class="sd">    colors</span>
<span class="sd">        A mapping of annotation values to colors. If `None`, default colors are</span>
<span class="sd">        used.</span>
<span class="sd">    stacked</span>
<span class="sd">        Whether to plot the different annotations on different scales on</span>
<span class="sd">        separate stacked plots or on the same scale in a single plot.</span>
<span class="sd">    verbose</span>
<span class="sd">        Level of verbosity, with `0` (no output), `1` (some output), ...</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">group_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">group_adatas</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span><span class="n">adata</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group_adatas</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">:</span><span class="n">adata</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">group</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_key</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">annotation_key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">):</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">annotation_key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">annotation_key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `annotation_key` </span><span class="si">{</span><span class="n">annotation_key</span><span class="si">!r}</span><span class="s1"> is neither in `adata.obs` nor `adata.obsm`!&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_list_like</span><span class="p">(</span><span class="n">coordinate_key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinate_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">coordinate_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span> <span class="ow">and</span> <span class="n">coordinate_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">coordinate_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">coordinate_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">coordinate_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `coordinate_key` </span><span class="si">{</span><span class="n">coordinate_key</span><span class="si">!r}</span><span class="s1"> is list/like, but not something of length 2 containing a `adata.obsm` key and a column name therein!&#39;</span><span class="p">)</span>
        <span class="c1">#coordinate_key = f&#39;{coordinate_key[0]}:{coordinate_key[1]}&#39;</span>
        <span class="n">coordinate_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coordinate_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">elif</span> <span class="n">coordinate_key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">coordinate_key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `coordinate_key` </span><span class="si">{</span><span class="n">coordinate_key</span><span class="si">!r}</span><span class="s1"> is not in `adata.obs` and not a valid specification for something in `adata.obsm`!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">max_coordinate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_coordinate</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
        <span class="n">max_coordinate</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">max_coordinate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_coordinate</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">delta_coordinate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">delta_coordinate</span> <span class="o">=</span> <span class="n">max_coordinate</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="n">n_intervals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_coordinate</span> <span class="o">/</span> <span class="n">delta_coordinate</span><span class="p">)</span>
    <span class="n">max_coordinate</span> <span class="o">=</span> <span class="n">n_intervals</span> <span class="o">*</span> <span class="n">delta_coordinate</span>
    <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_coordinate</span><span class="o">+</span><span class="n">delta_coordinate</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span><span class="n">delta_coordinate</span><span class="p">)</span>
    <span class="n">midpoints</span> <span class="o">=</span> <span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">intervals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span>
    
    <span class="k">if</span> <span class="n">reference_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reference_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">reference_key</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
        <span class="n">reference_weights</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">reference_key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `reference_key` </span><span class="si">{</span><span class="n">reference_key</span><span class="si">!r}</span><span class="s1"> is not in `adata.obs`!&#39;</span><span class="p">)</span>
    
    <span class="n">annotation_categories</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">colors</span><span class="p">,</span><span class="n">annotation_categories</span> <span class="o">=</span> <span class="n">_get_colors</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">annotation_categories</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">stacked</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_adatas</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="n">y_padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">x_padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_adatas</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">axsize</span><span class="o">=</span><span class="n">axsize</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="n">y_padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">x_padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">gi</span><span class="p">,(</span><span class="n">group</span><span class="p">,</span><span class="n">group_adata</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_adatas</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

        <span class="n">group_annotation</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">group_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">group_reference_weights</span> <span class="o">=</span> <span class="n">reference_weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">no_nan</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">group_annotation</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">anno</span> <span class="o">=</span> <span class="n">_anno_hist</span><span class="p">(</span><span class="n">group_coordinates</span><span class="p">[</span><span class="n">no_nan</span><span class="p">],</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">group_reference_weights</span><span class="p">[</span><span class="n">no_nan</span><span class="p">],</span> <span class="n">group_annotation</span><span class="p">[</span><span class="n">no_nan</span><span class="p">])</span>
        <span class="n">anno</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">anno</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">midpoints</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">annotation</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stacked</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">gi</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">anno</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">gi</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">gi</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">anno</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">gi</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">group_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; in </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">group</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">gi</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">annotation_key</span><span class="si">}</span><span class="s1"> VS distance from </span><span class="si">{</span><span class="n">coordinate_key</span><span class="si">}{</span><span class="n">group_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="n">colors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">],</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="dotplot">
<a class="viewcode-back" href="../../../_autosummary/tacco.plots.dotplot.html#tacco.plots.dotplot">[docs]</a>
<span class="k">def</span> <span class="nf">dotplot</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">genes</span><span class="p">,</span>
    <span class="n">group_key</span><span class="p">,</span>
    <span class="n">log1p</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">marks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">marks_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">swap_axes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Dot plot of expression values.</span>
<span class="sd">    </span>
<span class="sd">    This is similar to :func:`scanpy.pl.dotplot` with customizations, e.g. the</span>
<span class="sd">    option to mark selected dots.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        An :class:`~anndata.AnnData` including annotation in `.obs`.</span>
<span class="sd">    genes</span>
<span class="sd">        The `.var` index values to compare use as a list-like.</span>
<span class="sd">    group_key</span>
<span class="sd">        An `.obs` key with categorical group information.</span>
<span class="sd">    log1p</span>
<span class="sd">        Whether to log1p-transform the data prior to plotting.</span>
<span class="sd">    marks</span>
<span class="sd">        A :class:`pandas.DataFrame` containing categorical markers for the dots</span>
<span class="sd">        with genes in the rows and groups in the columns.</span>
<span class="sd">    marks_colors</span>
<span class="sd">        A mapping from the categories in `marks` to colors; if `None`, default</span>
<span class="sd">        colors are used.</span>
<span class="sd">    swap_axes</span>
<span class="sd">        If `False`, the x axis contains the genes and the y axis the groups.</span>
<span class="sd">        Otherwise the axes are swapped.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`~matplotlib.figure.Figure`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The genes </span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="si">!r}</span><span class="s1"> are not available in `adata.var`!&#39;</span><span class="p">)</span>

    <span class="n">markers</span> <span class="o">=</span> <span class="n">genes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">group_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `group_key` </span><span class="si">{</span><span class="n">group_key</span><span class="si">!r}</span><span class="s1"> is not available in `adata.obs`!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">group_key</span><span class="p">],</span> <span class="s1">&#39;cat&#39;</span><span class="p">):</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">swap_axes</span><span class="p">:</span>
        <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">cluster</span>
        <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">markers</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">markers</span>
        <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">cluster</span>
    
    <span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">axsize</span><span class="o">=</span><span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">)]))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">))</span>   <span class="c1"># the label locations</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">))</span>   <span class="c1"># the label locations</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">swap_axes</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axisbelow</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">marker_counts</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span><span class="n">markers</span><span class="p">]</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">log1p</span><span class="p">:</span>
        <span class="n">marker_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">marker_counts</span><span class="p">)</span>
    <span class="n">mean_exp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">c</span><span class="p">:</span> <span class="n">marker_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_key</span><span class="p">)</span> <span class="p">})</span>
    <span class="n">mean_pos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">c</span><span class="p">:</span> <span class="p">(</span><span class="n">marker_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_key</span><span class="p">)</span> <span class="p">})</span>

    <span class="k">if</span> <span class="n">marks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="n">marks</span><span class="o">.</span><span class="n">reindex_like</span><span class="p">(</span><span class="n">mean_pos</span><span class="p">)</span>

    <span class="n">mean_exp_index_name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span> <span class="k">if</span> <span class="n">mean_exp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mean_exp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
    <span class="n">mean_pos_index_name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span> <span class="k">if</span> <span class="n">mean_pos</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mean_pos</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
    <span class="n">mean_exp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">mean_exp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">mean_exp_index_name</span><span class="p">:</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="s1">&#39;mean_exp&#39;</span><span class="p">})</span>
    <span class="n">mean_pos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">mean_pos</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">mean_pos_index_name</span><span class="p">:</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="s1">&#39;mean_pos&#39;</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">marks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">marks</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">marks</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">marks_index_name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span> <span class="k">if</span> <span class="n">marks</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">marks</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">marks</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">marks_index_name</span><span class="p">:</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="s1">&#39;marks&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">marks_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">marks_colors</span> <span class="o">=</span> <span class="n">get_default_colors</span><span class="p">(</span><span class="n">marks</span><span class="p">[</span><span class="s1">&#39;marks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

    <span class="n">all_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mean_exp</span><span class="p">,</span> <span class="n">mean_pos</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">marks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_df</span><span class="p">,</span> <span class="n">marks</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;marks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There were gene-group combinations without a match in &quot;marks&quot;!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">swap_axes</span><span class="p">:</span>
        <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">xticklabels</span><span class="p">))</span>
        <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">yticklabels</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">xticklabels</span><span class="p">))</span>
        <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">yticklabels</span><span class="p">))</span>

    <span class="n">legend_items</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">mean_exp_min</span><span class="p">,</span> <span class="n">mean_exp_max</span> <span class="o">=</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;mean_exp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;mean_exp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">mean_exp_min</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mean_exp_max</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="c1">#LinearSegmentedColormap.from_list(&#39;mean_exp&#39;, [(0,(1, 1, 1)),(1,(1, g, b))])</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;mean_exp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="p">]</span>

    <span class="n">legend_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#0000&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;mean expression&#39;</span><span class="p">))</span>
    <span class="n">mean_exp_for_legend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mean_exp_min</span><span class="p">,</span> <span class="n">mean_exp_max</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">legend_items</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">mean_exp_for_legend</span><span class="p">),</span><span class="n">mean_exp_for_legend</span><span class="p">)])</span>

    <span class="n">mean_pos_min</span><span class="p">,</span> <span class="n">mean_pos_max</span> <span class="o">=</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;mean_pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;mean_pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">size_map</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">mean_pos_max</span> <span class="o">*</span> <span class="mi">14</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">size_map</span><span class="p">(</span><span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;mean_pos&#39;</span><span class="p">])</span>

    <span class="n">legend_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#0000&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fraction of expressing cells&#39;</span><span class="p">))</span>
    <span class="n">mean_pos_for_legend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mean_pos_min</span><span class="p">,</span> <span class="n">mean_pos_max</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">legend_items</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#aaa&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">size_map</span><span class="p">(</span><span class="n">ind</span><span class="p">)),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">mean_pos_for_legend</span><span class="p">])</span>

    <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;#aaa&#39;</span> <span class="k">if</span> <span class="n">marks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;marks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">marks_colors</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">marks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">marks_name</span> <span class="o">=</span> <span class="n">marks_colors</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">marks_colors</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">legend_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#0000&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">marks_name</span><span class="p">))</span>
        <span class="n">legend_items</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#aaa&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">size_map</span><span class="p">(</span><span class="n">mean_pos_for_legend</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="n">marks_colors</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">all_df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="n">edgecolors</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_items</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Broad Institute.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>